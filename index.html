<!DOCTYPE html>
<!--
  Bangkok Explorer - Smart Route Planning App
  Copyright Â© 2026 Eitan Fisher. All Rights Reserved.
  
  This application and its source code are protected by copyright.
  Unauthorized copying, distribution, or modification is prohibited.
-->
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Bangkok Explorer ğŸ‡¹ğŸ‡­</title>
    <style>
      @keyframes slideUp {
        from {
          transform: translateY(100px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      @keyframes slideDown {
        from {
          transform: translateY(-30px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      /* Custom Scrollbar - Thin and Subtle */
      .overflow-y-auto::-webkit-scrollbar {
        width: 6px;
      }
      
      .overflow-y-auto::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
      }
      
      .overflow-y-auto::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
      
      .overflow-y-auto::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      
      /* Firefox */
      .overflow-y-auto {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
      }
    </style>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK - sequential loading with Promise -->
    <script>
    window.__firebaseReady = new Promise(function(resolve) {
      var libs = ['firebase-app-compat.js','firebase-database-compat.js'];
      var loaded = 0;
      var failed = false;
      
      function loadNext() {
        if (failed || loaded >= libs.length) {
          resolve(!failed);
          return;
        }
        var s = document.createElement('script');
        s.src = 'https://www.gstatic.com/firebasejs/9.22.0/' + libs[loaded];
        s.onload = function() {
          loaded++;
          console.log('[FIREBASE] Loaded: ' + libs[loaded-1]);
          loadNext();
        };
        s.onerror = function() {
          console.warn('[FIREBASE] Blocked: ' + libs[loaded]);
          failed = true;
          resolve(false);
        };
        document.head.appendChild(s);
      }
      
      loadNext();
      
      // Safety timeout - don't wait forever
      setTimeout(function() {
        if (loaded < libs.length && !failed) {
          console.warn('[FIREBASE] Load timeout after 8s');
          resolve(false);
        }
      }, 8000);
    });
    </script>
    
    <!-- Config -->
    <script>
// ============================================================================
// Bangkok Explorer - Configuration & Constants
// Copyright Â© 2026 Eitan Fisher. All Rights Reserved.
// ============================================================================

window.BKK = window.BKK || {};

// App Version
window.BKK.VERSION = '2.8.2';

// Firebase Configuration
window.BKK.firebaseConfig = {
  apiKey: "AIzaSyCAH_2fk_plk6Dg5dlCCfaRWKL3Nmc6V6g",
  authDomain: "bangkok-explorer.firebaseapp.com",
  databaseURL: "https://bangkok-explorer-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "bangkok-explorer",
  storageBucket: "bangkok-explorer.firebasestorage.app",
  messagingSenderId: "139083217994",
  appId: "1:139083217994:web:48fc6a45028c91d177bab3",
  measurementId: "G-QVGD0RKEHP"
};

// Google Places API Configuration
window.BKK.GOOGLE_PLACES_API_KEY = 'AIzaSyD0F0TYKuWXVqibhj-sH-DaElDtLL8hMwM';
window.BKK.GOOGLE_PLACES_API_URL = 'https://places.googleapis.com/v1/places:searchNearby';
window.BKK.GOOGLE_PLACES_TEXT_SEARCH_URL = 'https://places.googleapis.com/v1/places:searchText';

// Interests that use text search instead of category search
window.BKK.textSearchInterests = {
  graffiti: 'street art'
};

// Interest Options (base categories)
window.BKK.interestOptions = [
  { id: 'temples', label: '××§×“×©×™×', icon: 'ğŸ›•' },
  { id: 'food', label: '××•×›×œ', icon: 'ğŸœ' },
  { id: 'graffiti', label: '×’×¨×¤×™×˜×™', icon: 'ğŸ¨' },
  { id: 'artisans', label: '××œ××›×”', icon: 'ğŸ”¨' },
  { id: 'galleries', label: '×’×œ×¨×™×•×ª', icon: 'ğŸ–¼ï¸' },
  { id: 'architecture', label: '××¨×›×™×˜×§×˜×•×¨×”', icon: 'ğŸ›ï¸' },
  { id: 'canals', label: '×ª×¢×œ×•×ª', icon: 'ğŸš¤' },
  { id: 'cafes', label: '×§×¤×”', icon: 'â˜•' },
  { id: 'markets', label: '×©×•×•×§×™×', icon: 'ğŸª' },
  { id: 'nightlife', label: '×œ×™×œ×”', icon: 'ğŸŒƒ' },
  { id: 'parks', label: '×¤××¨×§×™×', icon: 'ğŸŒ³' },
  { id: 'rooftop', label: '×’×’×•×ª', icon: 'ğŸŒ†' },
  { id: 'entertainment', label: '×‘×™×“×•×¨', icon: 'ğŸ­' },
];

// Map interests to Google Places API categories
window.BKK.interestToGooglePlaces = {
  temples: ['hindu_temple', 'church', 'mosque', 'synagogue'],
  food: ['restaurant', 'meal_takeaway'],
  graffiti: ['art_gallery'],
  artisans: ['store', 'art_gallery'],
  galleries: ['art_gallery', 'museum'],
  architecture: ['historical_landmark'],
  canals: ['boat_tour_agency', 'marina'],
  cafes: ['cafe', 'coffee_shop'],
  markets: ['market', 'shopping_mall'],
  nightlife: ['bar', 'night_club'],
  parks: ['park', 'national_park'],
  rooftop: ['bar', 'restaurant'],
  entertainment: ['movie_theater', 'amusement_park', 'performing_arts_theater'],
};

// Interests NOT covered by the system
window.BKK.uncoveredInterests = [
  { id: 'massage_spa', icon: 'ğŸ’†', label: '×¢×™×¡×•×™ ×•×¡×¤×', name: '×¢×™×¡×•×™ ×•×¡×¤×', examples: 'Thai massage, wellness centers, spa' },
  { id: 'fitness', icon: 'ğŸ‹ï¸', label: '×›×•×©×¨ ×•×¡×¤×•×¨×˜', name: '×›×•×©×¨ ×•×¡×¤×•×¨×˜', examples: 'Gyms, yoga studios, Muay Thai, fitness' },
  { id: 'shopping_special', icon: 'ğŸ›ï¸', label: '×§× ×™×•×ª ××™×•×—×“×•×ª', name: '×§× ×™×•×ª ××™×•×—×“×•×ª', examples: 'Boutiques, jewelry, fashion stores' },
  { id: 'learning', icon: 'ğŸ“', label: '×œ×™××•×“ ×•×—×•×•×™×•×ª', name: '×œ×™××•×“ ×•×—×•×•×™×•×ª', examples: 'Cooking classes, meditation, workshops' },
  { id: 'health', icon: 'ğŸ¥', label: '×‘×¨×™××•×ª ×•×¨×¤×•××”', name: '×‘×¨×™××•×ª ×•×¨×¤×•××”', examples: 'Clinics, pharmacies, health services' },
  { id: 'accommodation', icon: 'ğŸ¨', label: '××™×¨×•×—', name: '××™×¨×•×—', examples: 'Hotels, hostels, guesthouses' },
  { id: 'transport', icon: 'ğŸš—', label: '×ª×—×‘×•×¨×”', name: '×ª×—×‘×•×¨×”', examples: 'Car rental, bike rental, transportation' },
  { id: 'business', icon: 'ğŸ’¼', label: '×¢×¡×§×™×', name: '×¢×¡×§×™×', examples: 'Coworking, offices, business centers' }
];

// Tooltip content for each interest
window.BKK.interestTooltips = {
  temples: '××§×“×©×™× ×‘×•×“×”×™×¡×˜×™×™× ×•×”×™× ×“×™×™×',
  food: '××¡×¢×“×•×ª ×•××•×›×œ ×¨×—×•×‘',
  graffiti: '××•×× ×•×ª ×¨×—×•×‘ ×•×’×¨×¤×™×˜×™',
  artisans: '×‘×ª×™ ××œ××›×” ×•××•×× ×™×',
  galleries: '×’×œ×¨×™×•×ª ×•××•×–×™××•× ×™×',
  architecture: '×‘× ×™×™× ×™× ×”×™×¡×˜×•×¨×™×™×',
  canals: '×©×™×™×˜×™× ×‘×ª×¢×œ×•×ª ×•×‘× ×”×¨',
  cafes: '×‘×ª×™ ×§×¤×”',
  markets: '×©×•×•×§×™× ×•×‘×–××¨×™×',
  nightlife: '×‘×¨×™× ×•××•×¢×“×•× ×™ ×œ×™×œ×”',
  parks: '×’× ×™× ×•×¤××¨×§×™×',
  rooftop: '×‘×¨×™× ×•××¡×¢×“×•×ª ×¢×œ ×’×’×•×ª',
  entertainment: '×§×•×œ× ×•×¢, ×ª×™××˜×¨×•×Ÿ, ××•×¤×¢×™×',
};

// Area options
window.BKK.areaOptions = [
  { id: 'sukhumvit', label: '×¡×•×§×•××•×•×™×ª', labelEn: 'Sukhumvit', icon: 'ğŸ™ï¸' },
  { id: 'old-town', label: '×”×¢×™×¨ ×”×¢×ª×™×§×”', labelEn: 'Old Town', icon: 'ğŸ°' },
  { id: 'chinatown', label: '×¦\'×™×™× ×” ×˜××•×Ÿ', labelEn: 'Chinatown', icon: 'ğŸ®' },
  { id: 'thonglor', label: '×ª×•× ×’×œ×•×¨', labelEn: 'Thonglor', icon: 'â˜•' },
  { id: 'ari', label: '××¨×™', labelEn: 'Ari', icon: 'ğŸ¨' },
  { id: 'riverside', label: '×¨×™×‘×¨×¡×™×™×“', labelEn: 'Riverside', icon: 'ğŸŒŠ' }
];

// Area coordinates (center points + radius)
window.BKK.areaCoordinates = {
  'sukhumvit': { lat: 13.7370, lng: 100.5610, radius: 2500 },
  'old-town': { lat: 13.7500, lng: 100.4914, radius: 2000 },
  'chinatown': { lat: 13.7408, lng: 100.5050, radius: 1500 },
  'thonglor': { lat: 13.7320, lng: 100.5830, radius: 2000 },
  'ari': { lat: 13.7790, lng: 100.5410, radius: 2000 },
  'riverside': { lat: 13.7270, lng: 100.4965, radius: 2000 }
};

// Help content for all views
window.BKK.helpContent = {
  main: {
    title: '×ª×›× ×•×Ÿ ××¡×œ×•×œ',
    content: `**××” ×–×” Bangkok Explorer?**
××¤×œ×™×§×¦×™×” ×œ×ª×›× ×•×Ÿ ××¡×œ×•×œ×™ ×˜×™×•×œ ×‘×‘× ×’×§×•×§. ×‘×—×¨ ×ª×—×•××™ ×¢× ×™×™×Ÿ ×•××–×•×¨, ×•×”××¢×¨×›×ª ×ª×‘× ×” ×œ×š ××¡×œ×•×œ ××•×ª××.

**××™×š ×œ×”×ª×—×™×œ:**
â€¢ ×‘×—×¨ **××™×–×•×¨** - ×”××–×•×¨ ×‘×‘× ×’×§×•×§ ×©××¢× ×™×™×Ÿ ××•×ª×š
â€¢ ×‘×—×¨ **×ª×—×•××™ ×¢× ×™×™×Ÿ** - ×œ×—×¥ ×¢×œ ×”××™×™×§×•× ×™× (××§×“×©×™×, ××•×›×œ, ×§× ×™×•×ª...)
â€¢ ×œ×—×¥ **"××¦× × ×§×•×“×•×ª ×¢× ×™×™×Ÿ"** - ×”×›××•×ª ××•×¦×’×ª ×‘×¡×•×’×¨×™×™× (× ×™×ª×Ÿ ×œ×©× ×•×ª ×‘×”×’×“×¨×•×ª)

**×¡×•×’×™ ××¡×œ×•×œ:**
â€¢ ğŸ”„ **××¢×’×œ×™** - ××¡×œ×•×œ ×©×—×•×–×¨ ×œ× ×§×•×“×ª ×”×”×ª×—×œ×”
â€¢ â¡ï¸ **×œ×™× ×™××¨×™** - ××¡×œ×•×œ ×‘×§×• ×™×©×¨ ×× ×§×•×“×” ×œ× ×§×•×“×”

**×˜×™×¤:**
×œ×˜×™×•×œ ×’××™×© ×‘×œ×™ ×¡×“×¨ ××•×’×“×¨ - ×‘×—×¨ ×œ××Ÿ ×œ×œ×›×ª ×‘×¢×¦××š ××ª×•×š ×”×¨×©×™××”, ××• ×”×©×ª××© ×‘"×”×¦×’ × ×§×•×“×•×ª ×¢×œ ×”××¤×”".`
  },
  placesListing: {
    title: '×¨×©×™××ª ×”××§×•××•×ª',
    content: `**××™×š × ×‘×—×¨×• ×”××§×•××•×ª?**
1. ×§×•×“× - ×”××§×•××•×ª ×©×”×•×¡×¤×ª ×‘×¢×¦××š
2. ××—×¨ ×›×š - ××§×•××•×ª ×-Google ×œ×¤×™ ×“×™×¨×•×’ ×’×‘×•×”

**×›××•×ª ×”××§×•××•×ª ×œ×›×œ ×ª×—×•×:**
××—×•×©×‘×ª ×œ×¤×™: ×¡×”"×› ××§×•××•×ª (××”×”×’×“×¨×•×ª) ×—×œ×§×™ ××¡×¤×¨ ×ª×—×•××™ ×”×¢× ×™×™×Ÿ ×©×‘×—×¨×ª.

**×›×¤×ª×•×¨×™× ×‘×›×œ ××§×•×:**
â€¢ âœ• **××¤×•×¨** - ×“×œ×’ ×–×× ×™×ª (×”×•×¤×š ×œ-â¸ï¸ ×¦×”×•×‘ ×›×©××•×©×”×”)
â€¢ â¸ï¸ **×¦×”×•×‘** - ×”×—×–×¨ ×œ××¡×œ×•×œ (×œ×—×™×¦×” ××‘×˜×œ×ª ×”×©×”×™×”)
â€¢ ğŸš« **××“×•×** - ×“×œ×’ ×œ×¦××™×ª×•×ª (×œ× ×™×•×¤×™×¢ ×™×•×ª×¨)
â€¢ âœ… **×™×¨×•×§** - ×‘×˜×œ ×“×™×œ×•×’ ×§×‘×•×¢
â€¢ + **×¡×’×•×œ** - ×”×•×¡×£ ×œ×¨×©×™××” ×©×œ×™
â€¢ âœï¸ **×›×—×•×œ** - ×¢×¨×•×š (×¨×§ ×œ××§×•××•×ª ×©×œ×™)

**×›×¤×ª×•×¨×™× ×œ××˜×”:**
â€¢ ğŸ’¾ **×¡×’×•×œ** - ×©××•×¨ ××¡×œ×•×œ (×©× + ×”×¢×¨×•×ª)
â€¢ ğŸ—ºï¸ **×™×¨×•×§** - ×¤×ª×— ××ª ×”××¡×œ×•×œ ×‘-Google Maps

**"+ ×¢×•×“" ×œ×™×“ ×›×œ ×ª×—×•×:**
××•×¡×™×£ ××§×•××•×ª × ×•×¡×¤×™× ×××•×ª×• ×¡×•×’.

**×œ×—×™×¦×” ×¢×œ ×©× ×”××§×•×** ×¤×•×ª×—×ª ××•×ª×• ×‘-Google Maps.`
  },
  route: {
    title: '×ª×•×¦××•×ª ×”××¡×œ×•×œ',
    content: `**×œ×•×’×™×§×ª ×”××§×•××•×ª:**
×”××¢×¨×›×ª ××‘×™××” ×§×•×“× ××ª ×”××§×•××•×ª ×©×œ×š (××•×ª×××™× ××™×©×™×ª), ×•××—×¨ ×›×š ××©×œ×™××” ×¢× ××§×•××•×ª ×-Google ×œ×¤×™ ×“×™×¨×•×’ ×’×‘×•×”.

**×›×¤×ª×•×¨×™× ×‘×›×œ ××§×•×:**
â€¢ ğŸ—ºï¸ **××¤×”** - ×¤×ª×™×—×” ×‘-Google Maps
â€¢ âœï¸ **×¢×¨×™×›×”** - ×¢×¨×™×›×ª ×¤×¨×˜×™ ×”××§×•×
â€¢ ğŸš« **×“×™×œ×•×’** - ×”×¡×¨×” ×–×× ×™×ª ××”××¡×œ×•×œ ×”× ×•×›×—×™
â€¢ ğŸ”™ **×”×—×–×¨×”** - ×”×—×–×¨×ª ××§×•× ×©×“×•×œ×’
â€¢ ×œ×—×™×¦×” ×¢×œ ×”×©× - ×¤×¨×˜×™× ××œ××™×

**×›×¤×ª×•×¨×™× ×›×œ×œ×™×™×:**
â€¢ **"×¤×ª×— ×‘-Google Maps"** - ×¤×ª×™×—×ª ×”××¡×œ×•×œ ×”××—×•×©×‘ ×‘××¤×•×ª
â€¢ **"××¦× ×¢×•×“"** - ×”×•×¡×¤×ª ××§×•××•×ª × ×•×¡×¤×™× ×œ×ª×—×•× ××¡×•×™×
â€¢ **"×©××•×¨ ××¡×œ×•×œ"** - ×©××™×¨×” ×œ×©×™××•×© ×¢×ª×™×“×™
â€¢ **"××¡×œ×•×œ ×—×“×©"** - ×”×ª×—×œ×” ××—×“×©

**×¡×™××•× ×™×:**
â€¢ â­ - ××§×•× ××•×ª×× ××™×©×™×ª (×©×œ×š)
â€¢ ğŸ› ï¸ - ××§×•× ×‘×ª×”×œ×™×š ×¢×“×›×•×Ÿ
â€¢ âš ï¸ - ×—×¡×¨×•×ª ×§×•××•×¨×“×™× ×˜×•×ª
â€¢ ğŸš« - ××§×•× ×©×“×•×œ×’ (×–×× ×™×ª ×‘××¡×œ×•×œ ×–×”)`
  },
  myContent: {
    title: '×”×ª×•×›×Ÿ ×©×œ×™',
    content: `**××‘× ×” ×—×“×© - ×©× ×™ ××¡×›×™×:**

**ğŸ“ ×”××§×•××•×ª ×©×œ×™:**
â€¢ × ×™×”×•×œ ××§×•××•×ª ××•×ª×××™× ××™×©×™×ª
â€¢ ×”×•×¡×¤×”, ×¢×¨×™×›×”, ××—×™×§×”
â€¢ ×¡×˜×˜×•×¡: ×¤×¢×™×œ / ×¨×©×™××” ×©×—×•×¨×”
â€¢ ××§×•××•×ª ×©×œ×š ××§×‘×œ×™× ×¢×“×™×¤×•×ª!

**ğŸ·ï¸ ×”×ª×—×•××™× ×©×œ×™:**
â€¢ ×›×œ ×ª×—×•××™ ×”×¢× ×™×™×Ÿ ×‘××¢×¨×›×ª
â€¢ âœ… **×¤×¢×™×œ×™×** - ××•×¤×™×¢×™× ×‘×—×™×¤×•×©
â€¢ â¸ï¸ **×œ× ×¤×¢×™×œ×™×** - ××•×¡×ª×¨×™× ××”×—×™×¤×•×©
â€¢ âš™ï¸ ×”×’×“×¨×•×ª ×—×™×¤×•×© ×œ×›×œ ×ª×—×•×
â€¢ â• ×”×•×¡×¤×ª ×ª×—×•××™× ×—×“×©×™×

**×¡×•×’×™ ×ª×—×•××™×:**
â€¢ **××•×‘× ×™×** - ×ª×—×•××™× ×§×‘×•×¢×™× (× ×™×ª×Ÿ ×œ×”×©×‘×™×ª)
â€¢ **×œ× × ×›×œ×œ×™×** - ×œ× ×¤×¢×™×œ×™× ×›×‘×¨×™×¨×ª ××—×“×œ
â€¢ **××•×ª×××™×** - ×ª×—×•××™× ×©×™×¦×¨×ª (× ×™×ª×Ÿ ×œ××—×•×§)

**×˜×™×¤:** ×ª×—×•× ×œ×œ× ×”×’×“×¨×•×ª ×—×™×¤×•×© ××¡×•××Ÿ ×‘××“×•× ×•×œ× ×™×¢×‘×•×“!`
  },
  myPlaces: {
    title: '×”××§×•××•×ª ×©×œ×™',
    content: `**× ×™×”×•×œ ××§×•××•×ª ××•×ª×××™× ××™×©×™×ª**

**×”×•×¡×¤×ª ××§×•×:**
â€¢ ×œ×—×¥ **"+ ×”×•×¡×£ ××§×•×"**
â€¢ ×”×–×Ÿ ×©× ×•×ª×—×•× ×¢× ×™×™×Ÿ (×—×•×‘×”)
â€¢ ×”×•×¡×£ ×§×•××•×¨×“×™× ×˜×•×ª, ×ª××•× ×”, ×”×¢×¨×•×ª

**×¤×¢×•×œ×•×ª:**
â€¢ âœï¸ **×¢×¨×™×›×”** - ×©×™× ×•×™ ×¤×¨×˜×™ ×”××§×•×
â€¢ ğŸ—‘ï¸ **××—×™×§×”** - ×”×¡×¨×” ××”××¢×¨×›×ª
â€¢ ğŸ” **×‘×“×™×§×”** - ××™×“×¢ ×-Google ×¢×œ ×”××§×•×

**×¡×˜×˜×•×¡ ××§×•×:**
â€¢ âœ… **×¤×¢×™×œ** - ×™×•×¤×™×¢ ×‘××¡×œ×•×œ×™×
â€¢ ğŸš« **×¨×©×™××” ×©×—×•×¨×”** - ×œ× ×™×•×¤×™×¢ ×œ×¢×•×œ×

**××§×•××•×ª ×©×œ×š ××§×‘×œ×™× ×¢×“×™×¤×•×ª** ×¢×œ ×¤× ×™ ××§×•××•×ª ×-Google!`
  },
  myInterests: {
    title: '×”×ª×—×•××™× ×©×œ×™',
    content: `**× ×™×”×•×œ ×›×œ ×ª×—×•××™ ×”×¢× ×™×™×Ÿ**

**×ª×—×•××™× ×¤×¢×™×œ×™× (âœ…):**
â€¢ ××•×¤×™×¢×™× ×‘×˜×•×¤×¡ ×”×—×™×¤×•×©
â€¢ âš™ï¸ ×œ×©×™× ×•×™ ×”×’×“×¨×•×ª ×—×™×¤×•×©
â€¢ âŒ ×œ×”×©×‘×ª×”

**×ª×—×•××™× ×œ× ×¤×¢×™×œ×™× (â¸ï¸):**
â€¢ ××•×¡×ª×¨×™× ××”×—×™×¤×•×©
â€¢ âœ… ×”×¤×¢×œ - ×œ×”×•×¡×¤×” ×œ×—×™×¤×•×©

**×¡×•×’×™ ×ª×—×•××™×:**
â€¢ **××•×‘× ×™×** - ××§×“×©×™×, ××•×›×œ, ×’×¨×¤×™×˜×™... (×œ× × ×™×ª×Ÿ ×œ××—×•×§)
â€¢ **×œ× × ×›×œ×œ×™×** - ×¢×™×¡×•×™, ×›×•×©×¨... (×›×‘×•×™×™× ×›×‘×¨×™×¨×ª ××—×“×œ)
â€¢ **××•×ª×××™× (×—×“×©)** - ×ª×—×•××™× ×©×™×¦×¨×ª (× ×™×ª×Ÿ ×œ××—×•×§)

**âš ï¸ ×ª×—×•× ×œ× ×ª×§×™×Ÿ:**
â€¢ ××¡×’×¨×ª ××“×•××” = ×—×¡×¨ ×”×’×“×¨×•×ª ×—×™×¤×•×©
â€¢ ×œ× ×™×¢×‘×•×“ ×¢×“ ×©×ª×’×“×™×¨ Place Types`
  },
  interestConfig: {
    title: '×”×’×“×¨×•×ª ×ª×—×•×',
    content: `**×”×’×“×¨×•×ª ×”×—×™×¤×•×© ×©×œ ×”×ª×—×•×**

**×©× ×”×ª×—×•×:**
×”×©× ×©×™×•×¤×™×¢ ×‘×¨×©×™××ª ×”×ª×—×•××™×.

**×¡×•×’ ×—×™×¤×•×© (Place Types):**
×§×˜×’×•×¨×™×•×ª ×©×œ Google ×œ××©×œ: temple, restaurant, museum.
×”××¢×¨×›×ª ××‘×™××” ××§×•××•×ª ×©×”×¡×•×’ ×©×œ×”× ××ª××™× ×œ××—×ª ×”×§×˜×’×•×¨×™×•×ª.

**×—×™×¤×•×© ×˜×§×¡×˜ (Text Search):**
×—×™×¤×•×© ×—×•×¤×©×™, ×œ××©×œ: "street art", "rooftop bar".
×”××¢×¨×›×ª ××‘×™××” ××§×•××•×ª ×©×’×•×’×œ ××¦× ×œ×¤×™ ×”×˜×§×¡×˜, ×•××¡× × ×ª ×›××œ×” ×©×”×©× ×©×œ×”× ×œ× ××›×™×œ ××ª ×”×‘×™×˜×•×™.

**××™×œ×•×ª ×¡×™× ×•×Ÿ (Blacklist):**
××™×œ×™× ×©×× ××•×¤×™×¢×•×ª ×‘×©× ×”××§×•×, ×”×•× ×œ× ×™×™×›×œ×œ. ×œ××©×œ: "cannabis", "massage" - ×›×“×™ ×œ×¡× ×Ÿ ××§×•××•×ª ×œ× ×¨×œ×•×•× ×˜×™×.

**âš ï¸ ×—×©×•×‘:** ×ª×—×•× ×‘×œ×™ ×”×’×“×¨×•×ª ×—×™×¤×•×© ×œ× ×™×¢×‘×•×“!`
  },
  searchLogic: {
    title: '××™×š ×”××¢×¨×›×ª ××•×¦××ª ××§×•××•×ª?',
    content: `**×¡×“×¨ ×”××¦×™××”:**
1. **×§×•×“×** - ×”××§×•××•×ª ×©×œ×š (××•×ª×××™× ××™×©×™×ª) ×©×ª×•×××™× ×œ××–×•×¨ ×•×œ×ª×—×•×
2. **××—×¨ ×›×š** - ××§×•××•×ª ×-Google Places API

**×¡×™× ×•×Ÿ ××§×•××•×ª ××’×•×’×œ:**
â€¢ ××§×•× ×¢× ×©× ×©××›×™×œ ××™×œ×ª ×¡×™× ×•×Ÿ (blacklist) = ××¡×•× ×Ÿ
â€¢ ××§×•× ×©×©××• ×–×”×” ×œ××§×•× ×©×œ×š = ××¡×•× ×Ÿ (×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª)
â€¢ ××§×•× "×“×œ×’ ×œ×¦××™×ª×•×ª" = ××¡×•× ×Ÿ
â€¢ ×—×™×¤×•×© ×˜×§×¡×˜: ×¨×§ ××§×•××•×ª ×©×”×©× ×©×œ×”× ××›×™×œ ××ª ×‘×™×˜×•×™ ×”×—×™×¤×•×© ×”××œ×

**×ª×™×¢×“×•×£:**
â€¢ ××§×•××•×ª ×××•×™× ×™× ×œ×¤×™ ×“×™×¨×•×’ (××”×’×‘×•×” ×œ× ××•×š)
â€¢ ×”×“×™×¨×•×’ ××©××© ×¨×§ ×œ×¡×“×¨, ×œ× ×œ×¡×™× ×•×Ÿ - ×’× ××§×•××•×ª ×¢× ×“×™×¨×•×’ × ××•×š ×™×™×›×œ×œ×•

**×›××•×ª:**
â€¢ ××¡×¤×¨ ×”××§×•××•×ª ××—×•×œ×§ ×©×•×•×” ×‘×™×Ÿ ×”×ª×—×•××™× ×©×‘×—×¨×ª
â€¢ × ×™×ª×Ÿ ×œ×©× ×•×ª ×‘×”×’×“×¨×•×ª

**"+ ×¢×•×“":**
â€¢ ××•×¡×™×£ ××§×•××•×ª × ×•×¡×¤×™× ×××•×ª×• ×ª×—×•× (×‘×¨×™×¨×ª ××—×“×œ: 3)
â€¢ ×”××§×•××•×ª ×”×—×“×©×™× ××¡×•×× ×™× ×‘×’×‘×•×œ ×›×—×•×œ ××§×•×•×§×•`
  },
  saved: {
    title: '××¡×œ×•×œ×™× ×©××•×¨×™×',
    content: `**××” ×™×© ×›××Ÿ:**
×›×œ ×”××¡×œ×•×œ×™× ×©×©××¨×ª ×œ×©×™××•×© ×¢×ª×™×“×™.

**×©××™×¨×ª ××¡×œ×•×œ:**
â€¢ ×œ×—×¥ "ğŸ’¾ ×©××•×¨ ××¡×œ×•×œ" ×‘××¡×š ×”××¡×œ×•×œ
â€¢ ×ª×Ÿ ×©× ×™×™×—×•×“×™ (×—×•×‘×”)
â€¢ ×”×•×¡×£ ×”×¢×¨×•×ª ×× ×¨×•×¦×”

**×¤×¢×•×œ×•×ª:**
â€¢ ×œ×—×¥ ×¢×œ ××¡×œ×•×œ ×œ×˜×¢×™× ×” ××—×“×©
â€¢ ğŸ—‘ï¸ ×œ××—×™×§×ª ××¡×œ×•×œ

**×˜×™×¤:**
××¡×œ×•×œ×™× × ×›×œ×œ×™× ×‘×™×™×¦×•×/×™×™×‘×•× ×‘×”×’×“×¨×•×ª!`
  },
  settings: {
    title: '×”×’×“×¨×•×ª',
    content: `**×”×’×“×¨×•×ª ×”××¢×¨×›×ª:**

**××¡×¤×¨ ××§×•××•×ª:**
â€¢ ×›××•×ª ×”××§×•××•×ª ×”××§×¡×™××œ×™×ª ×‘××¡×œ×•×œ
â€¢ ×›××•×ª ××§×•××•×ª × ×•×¡×¤×™× ×‘"××¦× ×¢×•×“"

**×™×™×‘×•×/×™×™×¦×•×:**
â€¢ **×™×™×¦×•×** - ×©×•××¨ ×”×›×œ ×œ×§×•×‘×¥ JSON:
  - ××§×•××•×ª ××•×ª×××™×
  - ×ª×—×•××™× ××•×ª×××™×
  - ×”×’×“×¨×•×ª ×—×™×¤×•×©
  - ×¡×˜×˜×•×¡ ×ª×—×•××™×
  - ××¡×œ×•×œ×™× ×©××•×¨×™×

â€¢ **×™×™×‘×•×** - ××•×¡×™×£ ××§×•×‘×¥:
  - ×›×¤×™×œ×•×™×•×ª ×™×“×•×œ×’×•
  - ×”×’×“×¨×•×ª ×™×ª××–×’×•
  - ×©×•× ×“×‘×¨ ×œ× ×™×™××—×§

**Admin (×œ×× ×”×œ×™×):**
â€¢ ×¦×¤×™×™×” ×‘×œ×•×’ ×›× ×™×¡×•×ª
â€¢ × ×™×”×•×œ ××›×©×™×¨×™× ××•×¨×©×™×
â€¢ ×¡×™×¡××ª Admin`
  },
  addLocation: {
    title: '×”×•×¡×¤×ª/×¢×¨×™×›×ª ××§×•×',
    content: `**×©×“×•×ª ×—×•×‘×”:**
â€¢ **×©×** - ×©× ×”××§×•×
â€¢ **×ª×—×•× ×¢× ×™×™×Ÿ** - ×œ×¤×—×•×ª ××—×“

**×©×“×•×ª × ×•×¡×¤×™×:**
â€¢ **××™×–×•×¨** - ×œ×¡×™× ×•×Ÿ ×œ×¤×™ ××–×•×¨ ×‘×‘× ×’×§×•×§
â€¢ **×ª××•× ×”** - ×”×¢×œ××” ××”××›×©×™×¨ ××• ×§×™×©×•×¨
â€¢ **×›×ª×•×‘×ª** - ×˜×§×¡×˜ ×—×•×¤×©×™
â€¢ **×§×™×©×•×¨ Maps** - ×”×¢×ª×§ ×-Google Maps
â€¢ **×”×¢×¨×•×ª** - ××™×“×¢ × ×•×¡×£ ×œ×¢×¦××š

**××” ×–×” ×§×•××•×¨×“×™× ×˜×•×ª?**
××™×§×•× ××“×•×™×§ ×¢×œ ×”××¤×” (×§×• ×¨×•×—×‘ + ×§×• ××•×¨×š).
×‘×œ×™ ×§×•××•×¨×“×™× ×˜×•×ª - ×”××§×•× ×œ× ×™×•×¤×™×¢ ×‘××¡×œ×•×œ ×‘-Google Maps!

**××™×š ×œ×”×©×™×’ ×§×•××•×¨×“×™× ×˜×•×ª:**
â€¢ ğŸ”¤ **×©×** - ×—×™×¤×•×© ××•×˜×•××˜×™ ×œ×¤×™ ×©× ×”××§×•×
â€¢ ğŸ  **×›×ª×•×‘×ª** - ×—×™×¤×•×© ×œ×¤×™ ×”×›×ª×•×‘×ª ×©×”×–× ×ª
â€¢ ğŸ”— **×§×™×©×•×¨** - ×—×™×œ×•×¥ ××§×™×©×•×¨ Google Maps
â€¢ ğŸ“ **××™×§×•×** - GPS - ×”××™×§×•× ×”× ×•×›×—×™ ×©×œ×š
â€¢ ğŸ—ºï¸ **×‘×“×•×§** - ×¤×ª×™×—×” ×‘××¤×” ×œ××™××•×ª

**×˜×™×¤ ×œ×§×™×©×•×¨ Maps:**
1. ×¤×ª×— Google Maps ×•××¦× ××ª ×”××§×•×
2. ×œ×—×¥ ×¢×œ ×”××§×•× ×•××– "×©×ª×£"
3. ×”×¢×ª×§ ××ª ×”×§×™×©×•×¨ ×•×”×“×‘×§ ×‘×©×“×” "×§×™×©×•×¨ Maps"
4. ×œ×—×¥ ğŸ”— ×œ×—×™×œ×•×¥ ×”×§×•××•×¨×“×™× ×˜×•×ª

**×›×¤×ª×•×¨×™×:**
â€¢ **×”×•×¡×£/×¢×“×›×Ÿ** - ×©×•××¨ ×•× ×©××¨ ×¤×ª×•×—
â€¢ **×¡×’×•×¨** - ×©×•××¨ ×•×¡×•×’×¨
â€¢ **X** - ×¡×•×’×¨ ×‘×œ×™ ×œ×©××•×¨`
  },
  addInterest: {
    title: '×”×•×¡×¤×ª/×¢×¨×™×›×ª ×ª×—×•× ×¢× ×™×™×Ÿ',
    content: `**××” ×–×” ×ª×—×•× ×¢× ×™×™×Ÿ ××•×ª××?**
×§×˜×’×•×¨×™×” ×—×“×©×” ×©××ª×” ×™×•×¦×¨ ×¢× ×”×’×“×¨×•×ª ×—×™×¤×•×© ××©×œ×š.

**×©×“×•×ª ×‘×¡×™×¡:**
â€¢ **×©× ×”×ª×—×•×** - ×”×©× ×©×™×•×¦×’ (×œ×“×•×’××”: "×‘×ª×™ ×§×•×œ× ×•×¢")
â€¢ **××™×™×§×•×Ÿ** - ××™××•×’'×™ ×©×™×™×¦×’ ××ª ×”×ª×—×•×

**×”×’×“×¨×•×ª ×—×™×¤×•×© (×—×•×‘×”!):**
â€¢ **Search Mode:**
  - **Category** - ×—×™×¤×•×© ×œ×¤×™ ×¡×•×’×™ ××§×•××•×ª
  - **Text** - ×—×™×¤×•×© ×˜×§×¡×˜ ×—×•×¤×©×™

â€¢ **Place Types** (×œ××¦×‘ Category):
  - ×¨×©×™××” ××•×¤×¨×“×ª ×‘×¤×¡×™×§×™×
  - ×œ×“×•×’××”: movie_theater, cinema
  - [×§×™×©×•×¨ ×œ×¨×©×™××ª ×”×¡×•×’×™×]

â€¢ **Text Query** (×œ××¦×‘ Text):
  - ×œ×“×•×’××”: street art
  - ×™×—×¤×©: "[query] [area] Bangkok"

â€¢ **Blacklist:**
  - ××™×œ×™× ×œ×¡×™× ×•×Ÿ (cannabis, massage...)

**âš ï¸ ×—×©×•×‘:**
×ª×—×•× ×œ×œ× Place Types ××• Text Query ×œ× ×™×¢×‘×•×“!
×™×¡×•××Ÿ ×‘××“×•× ×¢×“ ×©×ª×’×“×™×¨.

**×›×¤×ª×•×¨×™×:**
â€¢ **×”×•×¡×£** - ×©×•××¨ ×•× ×©××¨ ×¤×ª×•×—
â€¢ **×©××•×¨** - ×¢×“×›×•×Ÿ ×ª×—×•× ×§×™×™×
â€¢ **×¡×’×•×¨** - ×©×•××¨ ×•×¡×•×’×¨`
  }
};

console.log('[CONFIG] Loaded successfully');


    </script>
    <!-- Utils -->
    <script>
// ============================================================================
// Bangkok Explorer - Utility Functions
// Copyright Â© 2026 Eitan Fisher. All Rights Reserved.
// Pure functions - no React state dependency
// ============================================================================

window.BKK = window.BKK || {};

// ============================================================================
// GEOLOCATION & COORDINATES
// ============================================================================

/**
 * Check if a location is within an area's boundaries using Haversine formula
 * @returns {{ valid: boolean, distance: number, distanceKm: string }}
 */
window.BKK.checkLocationInArea = (lat, lng, areaId) => {
  const area = window.BKK.areaCoordinates[areaId];
  if (!area || !lat || !lng) return { valid: true, distance: 0 };
  
  const R = 6371e3; // Earth radius in meters
  const lat1Rad = lat * Math.PI / 180;
  const lat2Rad = area.lat * Math.PI / 180;
  const deltaLat = (area.lat - lat) * Math.PI / 180;
  const deltaLng = (area.lng - lng) * Math.PI / 180;
  
  const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
            Math.cos(lat1Rad) * Math.cos(lat2Rad) *
            Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c;
  
  return { 
    valid: distance <= area.radius, 
    distance: Math.round(distance),
    distanceKm: (distance / 1000).toFixed(1)
  };
};

/**
 * Extract coordinates from Google Maps URL (various formats)
 * @returns {{ lat: number, lng: number } | null}
 */
window.BKK.extractCoordsFromUrl = (url) => {
  if (!url || !url.trim()) return null;

  let lat = null, lng = null;
  let match;
  
  // Format 1: ?q=13.7465,100.4927
  match = url.match(/[?&]q=([-\d.]+),([-\d.]+)/);
  if (match) { lat = parseFloat(match[1]); lng = parseFloat(match[2]); }
  
  // Format 2: @13.7465,100.4927,17z
  if (!lat) {
    match = url.match(/@([-\d.]+),([-\d.]+)/);
    if (match) { lat = parseFloat(match[1]); lng = parseFloat(match[2]); }
  }
  
  // Format 3: &ll=13.7465,100.4927
  if (!lat) {
    match = url.match(/[?&]ll=([-\d.]+),([-\d.]+)/);
    if (match) { lat = parseFloat(match[1]); lng = parseFloat(match[2]); }
  }
  
  // Format 4: Shortened URLs (goo.gl)
  if (!lat && (url.includes('goo.gl') || url.includes('maps.app'))) {
    return { lat: null, lng: null, shortened: true };
  }
  
  // Format 5: Raw coordinates: 13.7465,100.4927
  if (!lat) {
    match = url.match(/^([-\d.]+)\s*,\s*([-\d.]+)$/);
    if (match) { lat = parseFloat(match[1]); lng = parseFloat(match[2]); }
  }
  
  if (lat !== null && lng !== null) {
    return { lat, lng };
  }
  return null;
};

/**
 * Geocode address using Google Places Text Search API
 * @returns {{ lat, lng, address, displayName } | null}
 */
window.BKK.geocodeAddress = async (address) => {
  if (!address || !address.trim()) return null;

  const searchQuery = address.toLowerCase().includes('bangkok') 
    ? address 
    : `${address}, Bangkok, Thailand`;
  
  const response = await fetch(
    'https://places.googleapis.com/v1/places:searchText',
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Goog-Api-Key': window.BKK.GOOGLE_PLACES_API_KEY,
        'X-Goog-FieldMask': 'places.displayName,places.location,places.formattedAddress'
      },
      body: JSON.stringify({ textQuery: searchQuery, maxResultCount: 1 })
    }
  );
  
  const data = await response.json();
  
  if (data.places && data.places.length > 0) {
    const place = data.places[0];
    return {
      lat: place.location.latitude,
      lng: place.location.longitude,
      address: place.formattedAddress || place.displayName?.text || searchQuery,
      displayName: place.displayName?.text || ''
    };
  }
  return null;
};

/**
 * Geocode by place name
 * @returns {{ lat, lng, address, displayName } | null}
 */
window.BKK.geocodeByName = async (name) => {
  if (!name || !name.trim()) return null;

  const searchQuery = name.toLowerCase().includes('bangkok') 
    ? name 
    : `${name}, Bangkok, Thailand`;
  
  const response = await fetch(
    'https://places.googleapis.com/v1/places:searchText',
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Goog-Api-Key': window.BKK.GOOGLE_PLACES_API_KEY,
        'X-Goog-FieldMask': 'places.displayName,places.location,places.formattedAddress'
      },
      body: JSON.stringify({ textQuery: searchQuery, maxResultCount: 1 })
    }
  );
  
  const data = await response.json();
  
  if (data.places && data.places.length > 0) {
    const place = data.places[0];
    return {
      lat: place.location.latitude,
      lng: place.location.longitude,
      address: place.formattedAddress || '',
      displayName: place.displayName?.text || name
    };
  }
  return null;
};

/**
 * Reverse geocode: get address from coordinates
 * @returns {string} formatted address
 */
window.BKK.reverseGeocode = async (lat, lng) => {
  try {
    const response = await fetch(
      'https://places.googleapis.com/v1/places:searchText',
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Goog-Api-Key': window.BKK.GOOGLE_PLACES_API_KEY,
          'X-Goog-FieldMask': 'places.formattedAddress'
        },
        body: JSON.stringify({ textQuery: `${lat},${lng}`, maxResultCount: 1 })
      }
    );
    
    const data = await response.json();
    if (data.places && data.places.length > 0) {
      return data.places[0].formattedAddress || '';
    }
    return '';
  } catch (error) {
    console.error('[REVERSE GEOCODE] Error:', error);
    return '';
  }
};

// ============================================================================
// IMAGE HANDLING
// ============================================================================

/**
 * Compress image file to target size
 * @returns {Promise<string>} base64 compressed image
 */
window.BKK.compressImage = (file, maxSizeKB = 200) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        const maxDimension = 800;
        if (width > height && width > maxDimension) {
          height = (height / width) * maxDimension;
          width = maxDimension;
        } else if (height > maxDimension) {
          width = (width / height) * maxDimension;
          height = maxDimension;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        let quality = 0.8;
        let compressed = canvas.toDataURL('image/jpeg', quality);
        
        while (compressed.length > maxSizeKB * 1024 * 1.37 && quality > 0.3) {
          quality -= 0.1;
          compressed = canvas.toDataURL('image/jpeg', quality);
        }
        
        console.log('[IMAGE] Compressed:', {
          original: file.size,
          compressed: Math.round(compressed.length / 1024),
          quality
        });
        
        resolve(compressed);
      };
      img.src = e.target.result;
    };
    
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
};

// ============================================================================
// UI HELPERS
// ============================================================================

/**
 * Consistent button style generator
 */
window.BKK.getButtonStyle = (isActive = false, variant = 'primary') => {
  const baseStyle = {
    border: isActive ? '5px solid #f97316' : '3px solid #d1d5db',
    backgroundColor: isActive ? '#fed7aa' : '#ffffff',
    boxShadow: isActive ? '0 10px 15px -3px rgba(0, 0, 0, 0.3)' : 'none',
    padding: '12px 16px',
    borderRadius: '12px',
    fontWeight: 'bold',
    cursor: 'pointer',
    transition: 'all 0.2s'
  };
  
  if (variant === 'danger') {
    return {
      ...baseStyle,
      border: '3px solid #ef4444',
      backgroundColor: isActive ? '#fecaca' : '#ffffff',
      color: '#dc2626'
    };
  }
  
  if (variant === 'success') {
    return {
      ...baseStyle,
      border: '3px solid #10b981',
      backgroundColor: isActive ? '#d1fae5' : '#ffffff',
      color: '#059669'
    };
  }
  
  return baseStyle;
};

/**
 * Build Google Maps directions URL from stops
 */
window.BKK.buildMapsUrl = (stops, circular = false) => {
  if (!stops || stops.length === 0) return '';
  
  const validStops = stops.filter(s => s.lat && s.lng && s.lat !== 0 && s.lng !== 0);
  if (validStops.length === 0) return '';
  
  let waypoints = validStops.map(s => `${s.lat},${s.lng}`);
  
  if (circular && validStops.length > 1) {
    waypoints.push(waypoints[0]);
  }
  
  const origin = waypoints[0];
  const destination = waypoints[waypoints.length - 1];
  const middlePoints = waypoints.slice(1, -1).join('|');
  
  let mapUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
  if (middlePoints) {
    mapUrl += `&waypoints=${middlePoints}`;
  }
  mapUrl += '&travelmode=walking';
  
  return mapUrl;
};

/**
 * Parse user agent for readable browser/OS info
 */
window.BKK.parseUserAgent = (ua) => {
  let browser = 'Unknown', os = 'Unknown';
  if (ua.includes('SamsungBrowser')) browser = 'Samsung';
  else if (ua.includes('Chrome') && !ua.includes('Edg')) browser = 'Chrome';
  else if (ua.includes('Safari') && !ua.includes('Chrome')) browser = 'Safari';
  else if (ua.includes('Firefox')) browser = 'Firefox';
  else if (ua.includes('Edg')) browser = 'Edge';
  if (ua.includes('iPhone')) os = 'iPhone';
  else if (ua.includes('iPad')) os = 'iPad';
  else if (ua.includes('Android')) os = 'Android';
  else if (ua.includes('Windows')) os = 'Windows';
  else if (ua.includes('Mac OS')) os = 'Mac';
  else if (ua.includes('Linux')) os = 'Linux';
  return { browser, os };
};

/**
 * SHA-256 hash a string (for password protection)
 * Returns hex string. Uses Web Crypto API.
 */
window.BKK.hashPassword = async function(password) {
  if (!password) return '';
  var encoder = new TextEncoder();
  var data = encoder.encode(password);
  var hashBuffer = await crypto.subtle.digest('SHA-256', data);
  var hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
};

console.log('[UTILS] Loaded successfully');


    </script>

    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            borderWidth: {
              '3': '3px',
              '4': '4px',
            }
          }
        }
      }
    </script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
const { useState, useEffect } = React;

// Firebase Configuration - loaded from config.js
const firebaseConfig = window.BKK.firebaseConfig;

// Initialize Firebase (deferred until SDK loads)
let firebaseApp = null;
let database = null;
let isFirebaseAvailable = false;

function initFirebase() {
  try {
    if (typeof firebase !== 'undefined') {
      firebaseApp = firebase.initializeApp(firebaseConfig);
      database = firebase.database();
      isFirebaseAvailable = true;
      console.log('[FIREBASE] Initialized successfully');
    } else {
      console.log('[FIREBASE] Not available - using localStorage only');
    }
  } catch (error) {
    console.error('[FIREBASE] Initialization failed:', error);
    console.log('[FIREBASE] Falling back to localStorage');
  }
}

// Google Places API - loaded from config.js
const GOOGLE_PLACES_API_KEY = window.BKK.GOOGLE_PLACES_API_KEY;
const GOOGLE_PLACES_API_URL = window.BKK.GOOGLE_PLACES_API_URL;

const BangkokExplorer = () => {

  // Load saved preferences
  const loadPreferences = () => {
    try {
      const saved = localStorage.getItem('bangkok_preferences');
      if (saved) {
        const prefs = JSON.parse(saved);
        // Add maxStops if not present (for backward compatibility)
        if (!prefs.maxStops) prefs.maxStops = 10;
        // Add fetchMoreCount if not present
        if (!prefs.fetchMoreCount) prefs.fetchMoreCount = 3;
        return prefs;
      }
    } catch (e) {}
    return {
      hours: 3,
      area: 'sukhumvit',
      interests: [],
      circular: true,
      startPoint: '',
      maxStops: 10,
      fetchMoreCount: 3
    };
  };

  const [currentView, setCurrentView] = useState('form');
  const [formData, setFormData] = useState(loadPreferences());
  const [route, setRoute] = useState(null);
  const [isGenerating, setIsGenerating] = useState(false);
  const [disabledStops, setDisabledStops] = useState([]); // Track disabled stop IDs
  const [routeType, setRouteType] = useState(() => {
    // Load from localStorage or default to 'circular'
    const saved = localStorage.getItem('bangkok_route_type');
    return saved || 'circular';
  }); // 'circular' or 'linear'
  const [savedRoutes, setSavedRoutes] = useState([]);
  const [customLocations, setCustomLocations] = useState([]);
  const [showAddLocationDialog, setShowAddLocationDialog] = useState(false);
  const [showBlacklistLocations, setShowBlacklistLocations] = useState(false);
  const [placesGroupBy, setPlacesGroupBy] = useState('interest'); // 'interest' or 'area'
  const [routesSortBy, setRoutesSortBy] = useState('area'); // 'area' or 'name'
  const [editingRoute, setEditingRoute] = useState(null);
  const [showRouteDialog, setShowRouteDialog] = useState(false);
  const [routeDialogMode, setRouteDialogMode] = useState('edit'); // 'add' or 'edit'
  const [newLocation, setNewLocation] = useState({
    name: '',
    description: '',
    notes: '',
    area: formData.area,
    interests: [],
    lat: null,
    lng: null,
    mapsUrl: '',
    address: '',  // Address for geocoding
    uploadedImage: null,  // Base64 image data
    imageUrls: [],  // Array of URL strings
    inProgress: true  // Auto-check for new locations
  });
  const [customInterests, setCustomInterests] = useState([]);
  const [interestStatus, setInterestStatus] = useState({}); // { interestId: true/false }
  
  // Interest search configuration (editable)
  const [interestConfig, setInterestConfig] = useState({});
  const [googlePlaceInfo, setGooglePlaceInfo] = useState(null);
  const [loadingGoogleInfo, setLoadingGoogleInfo] = useState(false);
  const [editingCustomInterest, setEditingCustomInterest] = useState(null);
  const [showAddInterestDialog, setShowAddInterestDialog] = useState(false);
  const [newInterest, setNewInterest] = useState({ label: '', icon: 'ğŸ“', searchMode: 'types', types: '', textSearch: '', blacklist: '' });
  const [showEditLocationDialog, setShowEditLocationDialog] = useState(false);
  const [editingLocation, setEditingLocation] = useState(null);
  const [showImageModal, setShowImageModal] = useState(false);
  const [modalImage, setModalImage] = useState(null);
  const [toastMessage, setToastMessage] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [addingPlaceIds, setAddingPlaceIds] = useState([]); // Track places being added
  const [showImportDialog, setShowImportDialog] = useState(false);
  const [importedData, setImportedData] = useState(null);
  
  // Access Log System (Admin Only)
  const [accessLogs, setAccessLogs] = useState([]);
  const [hasNewEntries, setHasNewEntries] = useState(false);
  const [isCurrentUserAdmin, setIsCurrentUserAdmin] = useState(() => {
    return localStorage.getItem('bangkok_is_admin') === 'true';
  });
  const [showAccessLog, setShowAccessLog] = useState(false);

  // Confirm Dialog (replaces browser confirm)
  const [showConfirmDialog, setShowConfirmDialog] = useState(false);
  const [confirmConfig, setConfirmConfig] = useState({ message: '', onConfirm: null });

  // Help System
  const [showHelp, setShowHelp] = useState(false);
  const [helpContext, setHelpContext] = useState('main');
  
  // Debug Mode System
  const [debugMode, setDebugMode] = useState(() => {
    return localStorage.getItem('bangkok_debug_mode') === 'true';
  });
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [isDataLoaded, setIsDataLoaded] = useState(false); // Tracks initial Firebase/localStorage load
  const dataLoadTracker = React.useRef({ locations: false, interests: false, config: false, status: false });
  const markLoaded = (key) => {
    dataLoadTracker.current[key] = true;
    const t = dataLoadTracker.current;
    if (t.locations && t.interests && t.config && t.status) {
      setIsDataLoaded(true);
    }
  };
  
  // Safety timeout - don't show loading forever
  useEffect(() => {
    const timer = setTimeout(() => {
      if (!isDataLoaded) {
        console.warn('[LOAD] Safety timeout - forcing data loaded after 5s');
        setIsDataLoaded(true);
      }
    }, 5000);
    return () => clearTimeout(timer);
  }, [isDataLoaded]);
  const [startPointCoords, setStartPointCoords] = useState(null); // { lat, lng }
  const [isLocating, setIsLocating] = useState(false);
  
  // Admin System - Password based
  const [adminPassword, setAdminPassword] = useState('');
  const [adminUsers, setAdminUsers] = useState([]);
  const [isUnlocked, setIsUnlocked] = useState(true);
  const [showPasswordDialog, setShowPasswordDialog] = useState(false);
  const [passwordInput, setPasswordInput] = useState('');
  const [newAdminPassword, setNewAdminPassword] = useState(''); // For setting new password in admin panel
  
  // Add debug log entry (console only)
  const addDebugLog = (category, message, data = null) => {
    if (!debugMode) return;
    console.log(`[${category}] ${message}`, data || '');
  };
  
  // Save debug mode preference
  useEffect(() => {
    localStorage.setItem('bangkok_debug_mode', debugMode.toString());
  }, [debugMode]);
  
  // Help content - loaded from config.js
  const helpContent = window.BKK.helpContent;

  const showHelpFor = (context) => {
    setHelpContext(context);
    setShowHelp(true);
  };

  const showConfirm = (message, onConfirm) => {
    setConfirmConfig({ message, onConfirm });
    setShowConfirmDialog(true);
  };

  // Toast notification helper
  const showToast = (message, type = 'success') => {
    setToastMessage({ message, type });
    const duration = Math.min(4000, Math.max(1500, message.length * 50));
    setTimeout(() => setToastMessage(null), duration);
  };

  // Get current GPS location and reverse geocode to address
  const getMyLocation = () => {
    if (!navigator.geolocation) {
      showToast('×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘××™×ª×•×¨ ××™×§×•×', 'error');
      return;
    }
    
    setIsLocating(true);
    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const { latitude: lat, longitude: lng } = position.coords;
        console.log('[GPS] Got location:', lat, lng);
        
        // Try to get address via reverse geocode
        try {
          const address = await window.BKK.reverseGeocode(lat, lng);
          const displayAddress = address || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          setStartPointCoords({ lat, lng, address: displayAddress });
          setFormData(prev => ({ ...prev, startPoint: displayAddress }));
          showToast(address ? 'ğŸ“ ××™×§×•× × ×•×›×—×™ × ×§×œ×˜!' : 'ğŸ“ ××™×§×•× × ×§×œ×˜ (×œ× × ××¦××” ×›×ª×•×‘×ª)', 'success');
        } catch (err) {
          const fallback = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          setStartPointCoords({ lat, lng, address: fallback });
          setFormData(prev => ({ ...prev, startPoint: fallback }));
          showToast('ğŸ“ ××™×§×•× × ×§×œ×˜', 'success');
        }
        
        setIsLocating(false);
      },
      (error) => {
        setIsLocating(false);
        console.error('[GPS] Error:', error);
        if (error.code === 1) {
          showToast('××™×Ÿ ×”×¨×©××ª ××™×§×•× - ×× × ××©×¨ ×’×™×©×” ×œ××™×§×•×', 'error');
        } else if (error.code === 2) {
          showToast('×œ× × ×™×ª×Ÿ ×œ××ª×¨ ××™×§×•×', 'error');
        } else {
          showToast('×©×’×™××” ×‘××™×ª×•×¨ ××™×§×•×', 'error');
        }
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
    );
  };

  // Geocode typed start point address to coordinates
  const validateStartPoint = async () => {
    const text = formData.startPoint?.trim();
    if (!text) {
      showToast('×”×–×Ÿ ×›×ª×•×‘×ª ××• ×©× ××§×•×', 'warning');
      return;
    }
    
    setIsLocating(true);
    try {
      const result = await window.BKK.geocodeAddress(text);
      if (result) {
        const validatedAddress = result.address || result.displayName || text;
        setStartPointCoords({ lat: result.lat, lng: result.lng, address: validatedAddress });
        setFormData(prev => ({ ...prev, startPoint: validatedAddress }));
        showToast(`âœ… ×›×ª×•×‘×ª ××•××ª×”: ${result.displayName || result.address}`, 'success');
        console.log('[START_POINT] Geocoded:', text, '->', result);
      } else {
        showToast('×œ× × ××¦××” ×›×ª×•×‘×ª ×ª×•×××ª', 'warning');
      }
    } catch (err) {
      console.error('[START_POINT] Geocode error:', err);
      showToast('×©×’×™××” ×‘×—×™×¤×•×© ×›×ª×•×‘×ª', 'error');
    }
    setIsLocating(false);
  };

  // Detect which area the user is currently in based on GPS
  const detectArea = () => {
    if (!navigator.geolocation) {
      showToast('×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘××™×§×•×', 'error');
      return;
    }
    setIsLocating(true);
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude: lat, longitude: lng } = position.coords;
        const coords = window.BKK.areaCoordinates;
        
        // Calculate distance to each area center
        let closest = null;
        let closestDist = Infinity;
        
        for (const [areaId, center] of Object.entries(coords)) {
          const dlat = (lat - center.lat) * 111320;
          const dlng = (lng - center.lng) * 111320 * Math.cos(lat * Math.PI / 180);
          const dist = Math.sqrt(dlat * dlat + dlng * dlng);
          
          if (dist <= center.radius && dist < closestDist) {
            closest = areaId;
            closestDist = dist;
          }
        }
        
        if (closest) {
          const areaName = areaOptions.find(a => a.id === closest)?.label || closest;
          setFormData(prev => ({ ...prev, area: closest }));
          showToast(`ğŸ“ × ××¦××ª ×‘××–×•×¨: ${areaName}`, 'success');
        } else {
          showToast('×”××™×§×•× ×”× ×•×›×—×™ ×©×œ×š × ××¦× ××—×•×¥ ×œ××–×•×¨×™ ×”×‘×—×™×¨×”', 'warning');
        }
        setIsLocating(false);
      },
      (error) => {
        setIsLocating(false);
        if (error.code === 1) {
          showToast('××™×Ÿ ×”×¨×©××ª ××™×§×•× - ×× × ××©×¨ ×’×™×©×” ×œ××™×§×•×', 'error');
        } else {
          showToast('×œ× × ×™×ª×Ÿ ×œ××ª×¨ ××™×§×•×', 'error');
        }
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
    );
  };
  useEffect(() => {
    try {
      const saved = localStorage.getItem('bangkok_saved_routes');
      if (saved) {
        setSavedRoutes(JSON.parse(saved));
      }
    } catch (e) {
      // Silent fail
    }
  }, []);

  // Load custom locations from Firebase
  useEffect(() => {
    if (isFirebaseAvailable && database) {
      console.log('[DATA] Using Firebase');
      const locationsRef = database.ref('customLocations');
      
      const unsubscribe = locationsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          const locationsArray = Object.keys(data).map(key => ({
            ...data[key],
            firebaseId: key
          }));
          setCustomLocations(locationsArray);
          console.log('[FIREBASE] Loaded', locationsArray.length, 'locations');
        } else {
          setCustomLocations([]);
        }
        markLoaded('locations');
      });
      
      return () => locationsRef.off('value', unsubscribe);
    } else {
      console.log('[DATA] Firebase not available - using localStorage fallback');
      try {
        const customLocs = localStorage.getItem('bangkok_custom_locations');
        if (customLocs) {
          setCustomLocations(JSON.parse(customLocs));
        }
      } catch (e) {
        console.error('[LOCALSTORAGE] Error loading locations:', e);
      }
      markLoaded('locations');
    }
  }, []);

  // Load custom interests from Firebase
  useEffect(() => {
    if (isFirebaseAvailable && database) {
      const interestsRef = database.ref('customInterests');
      
      const unsubscribe = interestsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          const interestsArray = Object.keys(data).map(key => ({
            ...data[key],
            firebaseId: key
          }));
          setCustomInterests(interestsArray);
          console.log('[FIREBASE] Loaded', interestsArray.length, 'interests');
        } else {
          setCustomInterests([]);
        }
        markLoaded('interests');
      });
      
      return () => interestsRef.off('value', unsubscribe);
    } else {
      try {
        const customInts = localStorage.getItem('bangkok_custom_interests');
        if (customInts) {
          setCustomInterests(JSON.parse(customInts));
        }
      } catch (e) {
        console.error('[LOCALSTORAGE] Error loading interests:', e);
      }
      markLoaded('interests');
    }
  }, []);

  // Load interest search configurations from Firebase
  useEffect(() => {
    // Default configurations
    const defaultConfig = {
      temples: { types: ['hindu_temple', 'buddhist_temple', 'church', 'mosque'], blacklist: [] },
      food: { types: ['restaurant', 'meal_takeaway'], blacklist: ['bar', 'pub', 'club'] },
      graffiti: { textSearch: 'street art', blacklist: [] },
      artisans: { types: ['store', 'art_gallery'], blacklist: ['cannabis', 'weed', 'kratom', 'massage', 'spa'] },
      galleries: { types: ['art_gallery', 'museum'], blacklist: ['cannabis', 'weed', 'kratom', 'massage', 'spa', 'cafe', 'coffee'] },
      architecture: { types: ['historical_landmark'], blacklist: [] },
      canals: { types: ['boat_tour_agency', 'marina'], blacklist: [] },
      cafes: { types: ['cafe', 'coffee_shop'], blacklist: ['cannabis', 'weed', 'kratom'] },
      markets: { types: ['market', 'shopping_mall'], blacklist: [] },
      nightlife: { types: ['bar', 'night_club'], blacklist: [] },
      parks: { types: ['park', 'national_park'], blacklist: [] },
      rooftop: { types: ['bar', 'restaurant'], blacklist: [] },
      entertainment: { types: ['movie_theater', 'amusement_park', 'performing_arts_theater'], blacklist: [] },
      // Uncovered interests (inactive by default)
      massage_spa: { types: ['spa', 'massage'], blacklist: [] },
      fitness: { types: ['gym', 'fitness_center', 'sports_club'], blacklist: [] },
      shopping_special: { types: ['clothing_store', 'jewelry_store', 'shoe_store'], blacklist: [] },
      learning: { types: ['school', 'university'], blacklist: [] },
      health: { types: ['pharmacy', 'hospital', 'doctor'], blacklist: [] },
      accommodation: { types: ['hotel', 'lodging'], blacklist: [] },
      transport: { types: ['car_rental', 'transit_station'], blacklist: [] },
      business: { types: ['coworking_space'], blacklist: [] },
    };
    
    if (isFirebaseAvailable && database) {
      const configRef = database.ref('settings/interestConfig');
      
      configRef.once('value').then((snapshot) => {
        const data = snapshot.val();
        if (data) {
          // Merge with defaults
          setInterestConfig({ ...defaultConfig, ...data });
          console.log('[FIREBASE] Loaded interest config');
        } else {
          // Save defaults to Firebase
          configRef.set(defaultConfig);
          setInterestConfig(defaultConfig);
          console.log('[FIREBASE] Saved default interest config');
        }
        markLoaded('config');
      });
      
      // Listen for changes
      configRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          setInterestConfig({ ...defaultConfig, ...data });
        }
      });
    } else {
      setInterestConfig(defaultConfig);
      markLoaded('config');
    }
  }, []);

  // Load interest active/inactive status
  useEffect(() => {
    // Default status: built-in = active, uncovered = inactive
    const builtInIds = interestOptions.map(i => i.id);
    const uncoveredIds = uncoveredInterests.map(i => i.id || i.name.replace(/\s+/g, '_').toLowerCase());
    
    const defaultStatus = {};
    builtInIds.forEach(id => { defaultStatus[id] = true; });
    uncoveredIds.forEach(id => { defaultStatus[id] = false; });
    
    if (isFirebaseAvailable && database) {
      const statusRef = database.ref('settings/interestStatus');
      
      statusRef.once('value').then((snapshot) => {
        const data = snapshot.val();
        if (data) {
          setInterestStatus({ ...defaultStatus, ...data });
          console.log('[FIREBASE] Loaded interest status');
        } else {
          statusRef.set(defaultStatus);
          setInterestStatus(defaultStatus);
          console.log('[FIREBASE] Saved default interest status');
        }
        markLoaded('status');
      });
      
      // Listen for changes
      statusRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          setInterestStatus(prev => ({ ...defaultStatus, ...data }));
        }
      });
    } else {
      try {
        const saved = localStorage.getItem('bangkok_interest_status');
        if (saved) {
          setInterestStatus({ ...defaultStatus, ...JSON.parse(saved) });
        } else {
          setInterestStatus(defaultStatus);
        }
      } catch (e) {
        setInterestStatus(defaultStatus);
      }
      markLoaded('status');
    }
  }, []);

  // ============================================================
  // Refresh All Data - Manual reload from Firebase & localStorage
  // ============================================================
  const refreshAllData = async () => {
    setIsRefreshing(true);
    console.log('[REFRESH] Starting full data refresh...');
    
    try {
      // 1. Saved Routes (localStorage)
      try {
        const saved = localStorage.getItem('bangkok_saved_routes');
        if (saved) {
          setSavedRoutes(JSON.parse(saved));
          console.log('[REFRESH] Saved routes loaded from localStorage');
        }
      } catch (e) {
        console.error('[REFRESH] Error loading saved routes:', e);
      }
      
      if (isFirebaseAvailable && database) {
        // 2. Custom Locations
        try {
          const locSnap = await database.ref('customLocations').once('value');
          const locData = locSnap.val();
          if (locData) {
            const locationsArray = Object.keys(locData).map(key => ({
              ...locData[key],
              firebaseId: key
            }));
            setCustomLocations(locationsArray);
            console.log('[REFRESH] Loaded', locationsArray.length, 'locations');
          } else {
            setCustomLocations([]);
          }
        } catch (e) {
          console.error('[REFRESH] Error loading locations:', e);
        }
        
        // 3. Custom Interests
        try {
          const intSnap = await database.ref('customInterests').once('value');
          const intData = intSnap.val();
          if (intData) {
            const interestsArray = Object.keys(intData).map(key => ({
              ...intData[key],
              firebaseId: key
            }));
            setCustomInterests(interestsArray);
            console.log('[REFRESH] Loaded', interestsArray.length, 'interests');
          } else {
            setCustomInterests([]);
          }
        } catch (e) {
          console.error('[REFRESH] Error loading interests:', e);
        }
        
        // 4. Interest Config
        try {
          const configSnap = await database.ref('settings/interestConfig').once('value');
          const configData = configSnap.val();
          if (configData) {
            setInterestConfig(prev => ({ ...prev, ...configData }));
            console.log('[REFRESH] Loaded interest config');
          }
        } catch (e) {
          console.error('[REFRESH] Error loading interest config:', e);
        }
        
        // 5. Interest Status
        try {
          const statusSnap = await database.ref('settings/interestStatus').once('value');
          const statusData = statusSnap.val();
          if (statusData) {
            const builtInIds = interestOptions.map(i => i.id);
            const uncoveredIds = uncoveredInterests.map(i => i.id || i.name.replace(/\s+/g, '_').toLowerCase());
            const defaultStatus = {};
            builtInIds.forEach(id => { defaultStatus[id] = true; });
            uncoveredIds.forEach(id => { defaultStatus[id] = false; });
            setInterestStatus({ ...defaultStatus, ...statusData });
            console.log('[REFRESH] Loaded interest status');
          }
        } catch (e) {
          console.error('[REFRESH] Error loading interest status:', e);
        }
        
        // 6. Admin Settings
        try {
          const pwSnap = await database.ref('settings/adminPassword').once('value');
          setAdminPassword(pwSnap.val() || '');
          
          const usersSnap = await database.ref('settings/adminUsers').once('value');
          const usersData = usersSnap.val() || {};
          const usersList = Object.entries(usersData).map(([oderId, data]) => ({
            oderId,
            ...data
          }));
          setAdminUsers(usersList);
          
          const userId = localStorage.getItem('bangkok_user_id');
          const isInAdminList = usersList.some(u => u.oderId === userId);
          const passwordEmpty = !pwSnap.val();
          const userIsAdmin = isInAdminList || passwordEmpty;
          setIsUnlocked(userIsAdmin);
          setIsCurrentUserAdmin(userIsAdmin);
          console.log('[REFRESH] Loaded admin settings');
        } catch (e) {
          console.error('[REFRESH] Error loading admin settings:', e);
        }
        
        showToast('ğŸ”„ ×›×œ ×”× ×ª×•× ×™× ×¨×•×¢× × ×• ×‘×”×¦×œ×—×”!', 'success');
      } else {
        // Firebase not available - load from localStorage fallbacks
        try {
          const customLocs = localStorage.getItem('bangkok_custom_locations');
          if (customLocs) setCustomLocations(JSON.parse(customLocs));
        } catch (e) {}
        try {
          const customInts = localStorage.getItem('bangkok_custom_interests');
          if (customInts) setCustomInterests(JSON.parse(customInts));
        } catch (e) {}
        try {
          const saved = localStorage.getItem('bangkok_interest_status');
          if (saved) {
            const builtInIds = interestOptions.map(i => i.id);
            const uncoveredIds = uncoveredInterests.map(i => i.id || i.name.replace(/\s+/g, '_').toLowerCase());
            const defaultStatus = {};
            builtInIds.forEach(id => { defaultStatus[id] = true; });
            uncoveredIds.forEach(id => { defaultStatus[id] = false; });
            setInterestStatus({ ...defaultStatus, ...JSON.parse(saved) });
          }
        } catch (e) {}
        
        showToast('ğŸ”„ × ×ª×•× ×™× ×¨×•×¢× × ×• (localStorage ×‘×œ×‘×“ - Firebase ×œ× ×–××™×Ÿ)', 'warning');
      }
    } catch (error) {
      console.error('[REFRESH] Unexpected error:', error);
      showToast('âŒ ×©×’×™××” ×‘×¨×¢× ×•×Ÿ ×”× ×ª×•× ×™×', 'error');
    } finally {
      setIsRefreshing(false);
      console.log('[REFRESH] Complete');
    }
  };

  // Save routeType to localStorage when it changes
  useEffect(() => {
    localStorage.setItem('bangkok_route_type', routeType);
  }, [routeType]);

  // Access Log System - Track visits
  useEffect(() => {
    if (!isFirebaseAvailable || !database) return;
    
    // Generate or retrieve user ID
    let userId = localStorage.getItem('bangkok_user_id');
    if (!userId) {
      userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
      localStorage.setItem('bangkok_user_id', userId);
    }
    
    console.log('[ACCESS LOG] User ID:', userId);
    
    // Admin detection: Password-based system
    const loadAdminSettings = async () => {
      try {
        // Load admin password
        const pwSnapshot = await database.ref('settings/adminPassword').once('value');
        const storedPassword = pwSnapshot.val() || '';
        setAdminPassword(storedPassword);
        
        // Load admin users list
        const usersSnapshot = await database.ref('settings/adminUsers').once('value');
        const usersData = usersSnapshot.val() || {};
        const usersList = Object.entries(usersData).map(([oderId, data]) => ({
          oderId,
          ...data
        }));
        setAdminUsers(usersList);
        
        // Check if user is admin: either in list OR password is empty
        const isInAdminList = usersList.some(u => u.oderId === userId);
        const passwordEmpty = !storedPassword || storedPassword === '';
        const userIsAdmin = isInAdminList || passwordEmpty;
        
        setIsUnlocked(userIsAdmin);
        setIsCurrentUserAdmin(userIsAdmin);
        localStorage.setItem('bangkok_is_admin', userIsAdmin ? 'true' : 'false');
        
        console.log('[ADMIN] Password empty:', passwordEmpty, 'In list:', isInAdminList, 'Unlocked:', userIsAdmin);
      } catch (err) {
        console.error('[ADMIN] Error loading settings:', err);
      }
    };
    
    loadAdminSettings();
    
    // Listen to admin settings changes
    database.ref('settings/adminPassword').on('value', (snap) => {
      const pw = snap.val() || '';
      setAdminPassword(pw);
      const cachedUserId = localStorage.getItem('bangkok_user_id');
      database.ref('settings/adminUsers').once('value').then(usersSnap => {
        const usersData = usersSnap.val() || {};
        const isInList = Object.keys(usersData).includes(cachedUserId);
        setIsUnlocked(isInList || !pw);
      });
    });
    
    database.ref('settings/adminUsers').on('value', (snap) => {
      const usersData = snap.val() || {};
      const usersList = Object.entries(usersData).map(([oderId, data]) => ({
        oderId,
        ...data
      }));
      setAdminUsers(usersList);
    });
    
    // Log access (skip if admin)
    const isAdmin = localStorage.getItem('bangkok_is_admin') === 'true';
    
    if (!isAdmin) {
      const lastLogTime = parseInt(localStorage.getItem('bangkok_last_log_time') || '0');
      const oneHour = 60 * 60 * 1000;
      
      if (Date.now() - lastLogTime >= oneHour) {
        localStorage.setItem('bangkok_last_log_time', Date.now().toString());
        
        const { browser, os } = window.BKK.parseUserAgent(navigator.userAgent);
        
        const accessEntry = {
          userId, 
          timestamp: Date.now(), 
          date: new Date().toISOString(),
          userAgent: navigator.userAgent.substring(0, 100),
          browser, 
          os,
          screenSize: `${screen.width}x${screen.height}`,
          language: navigator.language || 'unknown',
          country: '', 
          city: '', 
          region: ''
        };
        
        const entryRef = database.ref('accessLog').push();
        entryRef.set(accessEntry)
          .then(() => {
            console.log('[ACCESS LOG] Visit logged');
            fetch('https://ipapi.co/json/')
              .then(r => r.json())
              .then(geo => {
                entryRef.update({
                  country: geo.country_name || '',
                  countryCode: geo.country_code || '',
                  city: geo.city || '',
                  region: geo.region || '',
                  ip: geo.ip ? geo.ip.substring(0, 12) + '***' : '',
                  isp: geo.org || ''
                });
              })
              .catch(err => console.log('[ACCESS LOG] Geo lookup failed:', err));
          })
          .catch(err => console.error('[ACCESS LOG] Error:', err));
      }
    }
    
    // Listen to access log (admin only)
    if (isAdmin) {
      const logRef = database.ref('accessLog').orderByChild('timestamp').limitToLast(50);
      const lastSeen = parseInt(localStorage.getItem('bangkok_last_seen') || '0');
      
      const unsubscribe = logRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          const logsArray = Object.keys(data).map(key => ({
            ...data[key], 
            id: key
          })).sort((a, b) => b.timestamp - a.timestamp);
          
          setAccessLogs(logsArray);
          
          const hasNew = logsArray.some(log => log.timestamp > lastSeen);
          if (hasNew && lastSeen > 0) {
            setHasNewEntries(true);
            showToast('×™×© ×›× ×™×¡×•×ª ×—×“×©×•×ª!', 'info');
          }
        } else {
          setAccessLogs([]);
        }
      });
      
      return () => logRef.off('value', unsubscribe);
    }
  }, []);

  // Mark logs as seen
  const markLogsAsSeen = () => {
    const latest = accessLogs.length > 0 ? accessLogs[0].timestamp : Date.now();
    localStorage.setItem('bangkok_last_seen', latest.toString());
    setHasNewEntries(false);
  };

  // Config - loaded from config.js
  const interestOptions = window.BKK.interestOptions;

  const interestToGooglePlaces = window.BKK.interestToGooglePlaces;

  const uncoveredInterests = window.BKK.uncoveredInterests;

  const interestTooltips = window.BKK.interestTooltips;

  const areaCoordinates = window.BKK.areaCoordinates;
  
  // Utility functions - loaded from utils.js
  const checkLocationInArea = window.BKK.checkLocationInArea;
  const getButtonStyle = window.BKK.getButtonStyle;

  // Text Search URL
  const GOOGLE_PLACES_TEXT_SEARCH_URL = window.BKK.GOOGLE_PLACES_TEXT_SEARCH_URL || 'https://places.googleapis.com/v1/places:searchText';

  const fetchGooglePlaces = async (area, interests) => {
    const center = areaCoordinates[area];
    if (!center) {
      addDebugLog('API', `No coordinates for area: ${area}`);
      console.error('[DYNAMIC] No coordinates for area:', area);
      return [];
    }

    // Filter out invalid interests (those without search config)
    const validInterests = interests.filter(id => isInterestValid(id));
    if (validInterests.length === 0) {
      const names = interests.map(id => allInterestOptions.find(o => o.id === id)?.label || id).join(', ');
      addDebugLog('API', `No valid config for: ${names}`);
      console.warn('[DYNAMIC] No valid interests - all are missing search config:', names);
      return [];
    }
    
    if (validInterests.length < interests.length) {
      const skipped = interests.filter(id => !isInterestValid(id));
      const skippedNames = skipped.map(id => allInterestOptions.find(o => o.id === id)?.label || id).join(', ');
      addDebugLog('API', `Skipped interests without config: ${skippedNames}`);
      console.warn('[DYNAMIC] Skipped invalid interests:', skippedNames);
    }

    try {
      // Get config for the first valid interest (primary)
      const primaryInterest = validInterests[0];
      
      // Check if this interest has direct config or through baseCategory
      let config = interestConfig[primaryInterest];
      if (!config) {
        const customInterest = customInterests.find(ci => ci.id === primaryInterest);
        if (customInterest?.baseCategory) {
          config = interestConfig[customInterest.baseCategory] || {};
        } else {
          config = {};
        }
      }
      
      // Check if this interest uses text search
      const textSearchQuery = config.textSearch;
      
      // Collect blacklist words from all valid interests
      const blacklistWords = validInterests
        .flatMap(interest => {
          const directConfig = interestConfig[interest];
          if (directConfig?.blacklist) return directConfig.blacklist;
          const ci = customInterests.find(c => c.id === interest);
          if (ci?.baseCategory) return interestConfig[ci.baseCategory]?.blacklist || [];
          return [];
        })
        .map(word => word.toLowerCase());
      
      let response;
      let placeTypes = [];
      
      if (textSearchQuery) {
        // Use Text Search API for interests like "graffiti" -> "street art"
        const areaName = areaOptions.find(a => a.id === area)?.labelEn || area;
        const searchQuery = `${textSearchQuery} ${areaName} Bangkok`;
        
        addDebugLog('API', `Text Search`, { query: searchQuery, area });
        console.log('[DYNAMIC] Using Text Search:', searchQuery);
        
        response = await fetch(GOOGLE_PLACES_TEXT_SEARCH_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Goog-Api-Key': GOOGLE_PLACES_API_KEY,
            'X-Goog-FieldMask': 'places.displayName,places.formattedAddress,places.location,places.rating,places.userRatingCount,places.types,places.primaryType,places.currentOpeningHours'
          },
          body: JSON.stringify({
            textQuery: searchQuery,
            maxResultCount: 20,
            locationBias: {
              circle: {
                center: {
                  latitude: center.lat,
                  longitude: center.lng
                },
                radius: 3000.0
              }
            }
          })
        });
      } else {
        // Use Nearby Search API with types from interestConfig
        placeTypes = [...new Set(
          validInterests.flatMap(interest => {
            // First check if this interest has direct config
            if (interestConfig[interest]?.types) {
              return interestConfig[interest].types;
            }
            // Fallback to baseCategory if it's a custom interest
            const customInterest = customInterests.find(ci => ci.id === interest);
            if (customInterest?.baseCategory && interestConfig[customInterest.baseCategory]?.types) {
              return interestConfig[customInterest.baseCategory].types;
            }
            // Fallback to interestToGooglePlaces
            return interestToGooglePlaces[interest] || interestToGooglePlaces[customInterest?.baseCategory] || ['point_of_interest'];
          })
        )];

        addDebugLog('API', `Fetching Google Places`, { area, validInterests, placeTypes: placeTypes.slice(0, 10), center });
        console.log('[DYNAMIC] Fetching from Google Places API:', { area, validInterests });

        response = await fetch(GOOGLE_PLACES_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Goog-Api-Key': GOOGLE_PLACES_API_KEY,
            'X-Goog-FieldMask': 'places.displayName,places.formattedAddress,places.location,places.rating,places.userRatingCount,places.types,places.primaryType,places.currentOpeningHours'
          },
          body: JSON.stringify({
            includedTypes: placeTypes.slice(0, 10),
            maxResultCount: 20,
            locationRestriction: {
              circle: {
                center: {
                  latitude: center.lat,
                  longitude: center.lng
                },
                radius: 2000
              }
            },
            rankPreference: 'POPULARITY'
          })
        });
      }

      console.log('[DYNAMIC] Google Places Response:', { 
        status: response.status, 
        ok: response.ok,
        statusText: response.statusText
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('[DYNAMIC] Error fetching Google Places:', {
          status: response.status,
          error: errorText,
          area,
          placeTypes
        });
        
        // Handle 400 Unsupported types - retry without bad types
        if (response.status === 400 && errorText.includes('Unsupported types') && !isTextSearch && placeTypes.length > 1) {
          console.warn('[DYNAMIC] Unsupported types detected, retrying one type at a time...');
          let allRetryPlaces = [];
          for (const singleType of placeTypes) {
            try {
              const retryResponse = await fetch(GOOGLE_PLACES_API_URL, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-Goog-Api-Key': GOOGLE_PLACES_API_KEY,
                  'X-Goog-FieldMask': 'places.displayName,places.formattedAddress,places.location,places.rating,places.userRatingCount,places.types,places.primaryType,places.currentOpeningHours'
                },
                body: JSON.stringify({
                  includedTypes: [singleType],
                  maxResultCount: 20,
                  locationRestriction: {
                    circle: {
                      center: { latitude: center.lat, longitude: center.lng },
                      radius: 2000
                    }
                  }
                })
              });
              if (retryResponse.ok) {
                const retryData = await retryResponse.json();
                if (retryData.places) {
                  allRetryPlaces.push(...retryData.places);
                  console.log(`[DYNAMIC] Retry success for type: ${singleType}, got ${retryData.places.length} places`);
                }
              } else {
                const interestNames = validInterests.map(id => allInterestOptions.find(o => o.id === id)?.label || id).join(', ');
                addDebugLog('API', `Type "${singleType}" not supported by Google (${interestNames})`);
                console.warn(`[DYNAMIC] Type "${singleType}" not supported, skipping`);
              }
            } catch (retryErr) {
              console.warn(`[DYNAMIC] Retry failed for type: ${singleType}`, retryErr);
            }
          }
          if (allRetryPlaces.length > 0) {
            // Process retry results - jump to processing section
            const data = { places: allRetryPlaces };
            response = { ok: true }; // Fake ok response
            // Continue with processing below using data
            const isTextSearchRetry = false;
            const textSearchPhraseRetry = '';
            let typeFilteredCountRetry = 0;
            let blacklistFilteredCountRetry = 0;
            let relevanceFilteredCountRetry = 0;
            
            const places = data.places.map(place => {
              const name = place.displayName?.text || 'Unknown';
              const placeTypesFromGoogle = place.types || [];
              const openingHours = place.currentOpeningHours;
              const todayIndex = new Date().getDay();
              const googleDayIndex = todayIndex === 0 ? 6 : todayIndex - 1;
              const todayHours = openingHours?.weekdayDescriptions?.[googleDayIndex] || '';
              const hoursOnly = todayHours.includes(':') ? todayHours.substring(todayHours.indexOf(':') + 1).trim() : todayHours;
              return {
                name,
                description: place.formattedAddress || '',
                address: place.formattedAddress || '',
                lat: place.location?.latitude || 0,
                lng: place.location?.longitude || 0,
                rating: place.rating || 0,
                ratingCount: place.userRatingCount || 0,
                duration: 45,
                interests: validInterests,
                googleTypes: placeTypesFromGoogle,
                primaryType: place.primaryType || null,
                openNow: openingHours?.openNow ?? null,
                todayHours: hoursOnly || '',
                custom: false
              };
            }).filter(place => place.lat !== 0 && place.lng !== 0);
            
            addDebugLog('API', `Got ${places.length} results from retry`, { names: places.slice(0, 5).map(p => p.name) });
            return places;
          }
          return []; // No results from any type
        }
        
        throw new Error(`Google API Error ${response.status}: ${errorText}`);
      }

      const data = await response.json();
      
      console.log('[DYNAMIC] Google Places Response:', {
        area,
        interests,
        placeTypes,
        foundPlaces: data.places?.length || 0
      });
      
      if (!data.places) {
        console.warn('[DYNAMIC] No places found in response');
        return [];
      }

      // Check if this was a text search
      const isTextSearch = !!textSearchQuery;
      
      // For text search: use the full query phrase for relevance filtering
      const textSearchPhrase = isTextSearch ? textSearchQuery.toLowerCase().trim() : '';
      
      // Filter and transform Google Places data
      let typeFilteredCount = 0;
      let blacklistFilteredCount = 0;
      let relevanceFilteredCount = 0;
      
      const transformed = data.places
        .filter(place => {
          const placeName = (place.displayName?.text || '').toLowerCase();
          const placeTypesFromGoogle = place.types || [];
          
          // Filter 1: Blacklist check - filter out places with blacklisted words in name
          if (blacklistWords.length > 0) {
            const isBlacklisted = blacklistWords.some(word => placeName.includes(word));
            if (isBlacklisted) {
              blacklistFilteredCount++;
              console.log('[DYNAMIC] âŒ Filtered out (blacklist):', {
                name: place.displayName?.text,
                matchedWord: blacklistWords.find(word => placeName.includes(word))
              });
              return false;
            }
          }
          
          // Filter 2: For text search - relevance check
          // Place name must contain the FULL search phrase (e.g. "street art")
          if (isTextSearch && textSearchPhrase) {
            const nameHasPhrase = placeName.includes(textSearchPhrase);
            
            if (!nameHasPhrase) {
              relevanceFilteredCount++;
              console.log('[DYNAMIC] âŒ Filtered out (text search irrelevant):', {
                name: place.displayName?.text,
                searchPhrase: textSearchPhrase
              });
              return false;
            }
          }
          
          // Filter 3: Type validation - for category search only
          if (!isTextSearch && placeTypes.length > 0) {
            const placeTypesFromGoogle = place.types || [];
            const hasValidType = placeTypesFromGoogle.some(type => placeTypes.includes(type));
            
            if (!hasValidType) {
              typeFilteredCount++;
              console.log('[DYNAMIC] âŒ Filtered out (invalid type):', {
                name: place.displayName?.text,
                googleTypes: placeTypesFromGoogle,
                expectedTypes: placeTypes
              });
              return false;
            }
          }
          
          console.log('[DYNAMIC] âœ… Kept:', {
            name: place.displayName?.text,
            isTextSearch
          });
          
          return true;
        })
        .map((place, index) => {
          // Extract today's opening hours
          const openingHours = place.currentOpeningHours;
          const todayIndex = new Date().getDay(); // 0=Sun, need to map to weekdayDescriptions (0=Mon in Google)
          const googleDayIndex = todayIndex === 0 ? 6 : todayIndex - 1; // Convert: Sun=6, Mon=0, Tue=1...
          const todayHours = openingHours?.weekdayDescriptions?.[googleDayIndex] || '';
          // Remove day name prefix (e.g. "Monday: 9:00 AM â€“ 5:00 PM" -> "9:00 AM â€“ 5:00 PM")
          const hoursOnly = todayHours.includes(':') ? todayHours.substring(todayHours.indexOf(':') + 1).trim() : todayHours;
          
          return {
            name: place.displayName?.text || 'Unknown Place',
            lat: place.location?.latitude || center.lat,
            lng: place.location?.longitude || center.lng,
            description: `â­ ${place.rating?.toFixed(1) || 'N/A'} (${place.userRatingCount || 0} ×‘×™×§×•×¨×•×ª)`,
            duration: 45,
            googlePlace: true,
            rating: place.rating || 0,
            ratingCount: place.userRatingCount || 0,
            googleTypes: place.types || [],
            primaryType: place.primaryType || '',
            address: place.formattedAddress || '',
            openNow: openingHours?.openNow ?? null,
            todayHours: hoursOnly || '',
            interests: interests
          };
        });
      
      console.log('[DYNAMIC] Filtering summary:', {
        received: data.places.length,
        typeFiltered: typeFilteredCount,
        blacklistFiltered: blacklistFilteredCount,
        relevanceFiltered: relevanceFilteredCount,
        final: transformed.length
      });
      
      addDebugLog('API', `Got ${transformed.length} results (filtered ${blacklistFilteredCount} blacklist, ${typeFilteredCount} type, ${relevanceFilteredCount} irrelevant)`, {
        names: transformed.slice(0, 5).map(p => p.name)
      });
      
      return transformed;
    } catch (error) {
      console.error('[DYNAMIC] Error fetching Google Places:', {
        error: error.message,
        stack: error.stack,
        area,
        interests
      });
      
      // Throw error to be handled by caller
      throw {
        type: 'GOOGLE_API_ERROR',
        message: error.message,
        details: { area, interests, stack: error.stack }
      };
    }
  };

  // Function to fetch Google Place info for a location
  const fetchGooglePlaceInfo = async (location) => {
    if (!location || (!location.lat && !location.name)) {
      showToast('××™×Ÿ ××¡×¤×™×§ ××™×“×¢ ×¢×œ ×”××§×•×', 'error');
      return null;
    }
    
    setLoadingGoogleInfo(true);
    
    try {
      // Use Text Search to find the place
      const searchQuery = location.name + ' Bangkok';
      
      const response = await fetch(GOOGLE_PLACES_TEXT_SEARCH_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Goog-Api-Key': GOOGLE_PLACES_API_KEY,
          'X-Goog-FieldMask': 'places.displayName,places.formattedAddress,places.location,places.rating,places.userRatingCount,places.types,places.primaryType,places.primaryTypeDisplayName,places.currentOpeningHours'
        },
        body: JSON.stringify({
          textQuery: searchQuery,
          maxResultCount: 5,
          locationBias: location.lat && location.lng ? {
            circle: {
              center: { latitude: location.lat, longitude: location.lng },
              radius: 1000.0
            }
          } : undefined
        })
      });
      
      if (!response.ok) {
        throw new Error('Google API error');
      }
      
      const data = await response.json();
      
      if (!data.places || data.places.length === 0) {
        setGooglePlaceInfo({ notFound: true, searchQuery });
        showToast('×”××§×•× ×œ× × ××¦× ×‘-Google', 'warning');
        return null;
      }
      
      // Find best match (closest to our coordinates if available)
      let bestMatch = data.places[0];
      
      if (location.lat && location.lng && data.places.length > 1) {
        const getDistance = (place) => {
          const lat = place.location?.latitude || 0;
          const lng = place.location?.longitude || 0;
          return Math.sqrt(Math.pow(lat - location.lat, 2) + Math.pow(lng - location.lng, 2));
        };
        
        bestMatch = data.places.reduce((best, place) => 
          getDistance(place) < getDistance(best) ? place : best
        );
      }
      
      const placeInfo = {
        name: bestMatch.displayName?.text,
        address: bestMatch.formattedAddress,
        types: bestMatch.types || [],
        primaryType: bestMatch.primaryType,
        primaryTypeDisplayName: bestMatch.primaryTypeDisplayName?.text,
        rating: bestMatch.rating,
        ratingCount: bestMatch.userRatingCount,
        location: bestMatch.location,
        allResults: data.places.map(p => ({
          name: p.displayName?.text,
          types: p.types,
          primaryType: p.primaryType
        }))
      };
      
      setGooglePlaceInfo(placeInfo);
      addDebugLog('API', 'Fetched Google Place Info', { name: placeInfo.name, types: placeInfo.types });
      
      return placeInfo;
    } catch (error) {
      console.error('Error fetching Google place info:', error);
      showToast('×©×’×™××” ×‘×©×œ×™×¤×ª ××™×“×¢ ×-Google', 'error');
      return null;
    } finally {
      setLoadingGoogleInfo(false);
    }
  };

  // Combine all interests: built-in + uncovered + custom
  const allInterestOptions = [...interestOptions, ...uncoveredInterests, ...(customInterests || [])];

  // Save preferences whenever they change
  useEffect(() => {
    localStorage.setItem('bangkok_preferences', JSON.stringify(formData));
  }, [formData]);

  // Sync editingLocation to newLocation when edit dialog opens
  useEffect(() => {
    if (showEditLocationDialog && editingLocation) {
      console.log('[useEffect] Syncing editingLocation to newLocation');
      setNewLocation({
        name: editingLocation.name || '',
        description: editingLocation.description || '',
        notes: editingLocation.notes || '',
        area: editingLocation.area || formData.area,
        interests: editingLocation.interests || [],
        lat: editingLocation.lat || null,
        lng: editingLocation.lng || null,
        mapsUrl: editingLocation.mapsUrl || '',
        address: editingLocation.address || '',
        uploadedImage: editingLocation.uploadedImage || null,
        imageUrls: editingLocation.imageUrls || [],
        inProgress: editingLocation.inProgress || false
      });
    }
  }, [showEditLocationDialog, editingLocation]);

  const areaOptions = window.BKK.areaOptions;

  // Image handling - loaded from utils.js
  const compressImage = window.BKK.compressImage;
  
  const handleImageUpload = async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
      showToast('×× × ×‘×—×¨ ×§×•×‘×¥ ×ª××•× ×”', 'error');
      return;
    }
    
    try {
      const compressed = await compressImage(file);
      setNewLocation(prev => ({ ...prev, uploadedImage: compressed }));
    } catch (error) {
      console.error('[IMAGE] Upload error:', error);
      showToast('×©×’×™××” ×‘×”×¢×œ××ª ×”×ª××•× ×”', 'error');
    }
  };

  const toggleInterest = (id) => {
    setFormData(prev => ({
      ...prev,
      interests: prev.interests.includes(id)
        ? prev.interests.filter(i => i !== id)
        : [...prev.interests, id]
    }));
  };

  // Auto-clean: remove selected interests that are no longer valid/visible
  useEffect(() => {
    if (formData.interests.length === 0) return;
    const visibleIds = allInterestOptions
      .filter(opt => opt && opt.id && isInterestValid(opt.id))
      .map(opt => opt.id);
    const cleaned = formData.interests.filter(id => visibleIds.includes(id));
    if (cleaned.length !== formData.interests.length) {
      const removed = formData.interests.filter(id => !visibleIds.includes(id));
      const removedNames = removed.map(id => allInterestOptions.find(o => o.id === id)?.label || id).join(', ');
      console.log('[CLEANUP] Removed invalid interests from selection:', removedNames);
      setFormData(prev => ({ ...prev, interests: cleaned }));
    }
  }, [interestConfig, customInterests]);

  // Button styles - loaded from utils.js

  const getStopsForInterests = () => {
    // Now we only collect CUSTOM locations - Google Places will be fetched in generateRoute
    
    // Filter custom locations that match current area and selected interests
    const matchingCustomLocations = customLocations.filter(loc => {
      // CRITICAL: Skip blacklisted locations!
      if (loc.status === 'blacklist') return false;
      
      if (loc.area !== formData.area) return false;
      if (!loc.interests || loc.interests.length === 0) return false;
      
      // Check if location interests match selected interests
      return loc.interests.some(locInterest => {
        // Direct match
        if (formData.interests.includes(locInterest)) return true;
        
        // Check if selected interest is a custom one with baseCategory that matches
        for (const selectedInterest of formData.interests) {
          const customInterest = allInterestOptions.find(opt => 
            opt.id === selectedInterest && opt.custom && opt.baseCategory
          );
          
          if (customInterest && locInterest === customInterest.baseCategory) {
            return true;
          }
        }
        
        return false;
      });
    });
    
    // Remove duplicates
    const seen = new Set();
    return matchingCustomLocations.filter(stop => {
      const key = `${stop.lat},${stop.lng}`;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });
  };

  const generateRoute = async () => {
    if (!formData.area || formData.interests.length === 0) {
      showToast('×× × ×‘×—×¨ ××™×–×•×¨ ×•×œ×¤×—×•×ª ×ª×—×•× ×¢× ×™×™×Ÿ ××—×“', 'warning');
      return;
    }
    
    setIsGenerating(true);
    
    try {
      addDebugLog('ROUTE', 'Starting route generation', { area: formData.area, interests: formData.interests, maxStops: formData.maxStops });
      console.log('[ROUTE] Starting route generation');
      
      // Get custom locations (always included)
      const customStops = getStopsForInterests();
      addDebugLog('ROUTE', `Found ${customStops.length} custom stops`);
      console.log('[ROUTE] Custom stops:', customStops.length);
      
      // Calculate stops needed per interest
      const numInterests = formData.interests.length || 1;
      const maxStops = formData.maxStops || 10;
      const stopsPerInterest = Math.ceil(maxStops / numInterests);
      
      // Track results per interest for smart completion
      const interestResults = {};
      const allStops = [...customStops]; // Start with custom stops (highest priority)
      let fetchErrors = [];
      
      // ROUND 1: Get places from Google Places API
      for (const interest of formData.interests) {
        // Check how many custom stops we already have for this interest
        const customStopsForInterest = customStops.filter(stop => 
          stop.interests && stop.interests.includes(interest)
        );
        
        const neededForInterest = Math.max(0, stopsPerInterest - customStopsForInterest.length);
        
        if (neededForInterest > 0) {
          let fetchedPlaces = [];
          
          try {
            console.log(`[ROUTE] Fetching for interest: ${interest}`);
            fetchedPlaces = await fetchGooglePlaces(formData.area, [interest]);
          } catch (error) {
            // Track errors for user notification
            fetchErrors.push({
              interest,
              error: error.message || 'Unknown error',
              details: error.details || {}
            });
            console.error(`[ERROR] Failed to fetch for ${interest}:`, error);
            fetchedPlaces = [];
          }
          
          // Filter blacklisted places (status='blacklist') BEFORE sorting
          fetchedPlaces = filterBlacklist(fetchedPlaces);
          
          // Filter out Google places that duplicate custom locations
          fetchedPlaces = filterDuplicatesOfCustom(fetchedPlaces);
          
          // Sort by rating and take what we need (or all if less available)
          const sortedPlaces = fetchedPlaces
            .sort((a, b) => (b.rating * Math.log10((b.ratingCount || 0) + 1)) - (a.rating * Math.log10((a.ratingCount || 0) + 1)))
            .slice(0, neededForInterest);
          
          // Track results
          interestResults[interest] = {
            requested: stopsPerInterest,
            custom: customStopsForInterest.length,
            fetched: sortedPlaces.length,
            total: customStopsForInterest.length + sortedPlaces.length,
            allPlaces: fetchedPlaces // Keep all for round 2
          };
          
          // Add to allStops
          allStops.push(...sortedPlaces);
        } else {
          // Already have enough from custom
          interestResults[interest] = {
            requested: stopsPerInterest,
            custom: customStopsForInterest.length,
            fetched: 0,
            total: customStopsForInterest.length,
            allPlaces: []
          };
        }
      }
      
      // Remove duplicates after round 1 - check ONLY exact name match
      // Allow same coordinates with different names (same physical location, different interests)
      const seen = new Set();
      let uniqueStops = allStops.filter(stop => {
        const normalizedName = stop.name.toLowerCase().trim();
        
        if (seen.has(normalizedName)) {
          console.log('[DEDUP] Removed duplicate by exact name:', stop.name);
          return false;
        }
        
        seen.add(normalizedName);
        return true;
      });
      
      // ROUND 2: If we didn't reach maxStops, try to add more from successful interests
      const totalFound = uniqueStops.length;
      const missing = maxStops - totalFound;
      
      console.log('[ROUTE] Round 1 complete:', { totalFound, maxStops, missing });
      
      if (missing > 0) {
        // Find interests that might have more places available
        const additionalPlaces = [];
        
        for (const interest of formData.interests) {
          const result = interestResults[interest];
          const alreadyUsed = result.fetched;
          const available = result.allPlaces.length;
          const canAddMore = available - alreadyUsed;
          
          if (canAddMore > 0) {
            // This interest has more places we can use
            const morePlaces = result.allPlaces
              .sort((a, b) => (b.rating * Math.log10((b.ratingCount || 0) + 1)) - (a.rating * Math.log10((a.ratingCount || 0) + 1)))
              .slice(alreadyUsed, alreadyUsed + canAddMore);
            
            additionalPlaces.push(...morePlaces);
          }
        }
        
        // Add additional places up to the missing amount
        const sorted = additionalPlaces
          .sort((a, b) => (b.rating * Math.log10((b.ratingCount || 0) + 1)) - (a.rating * Math.log10((a.ratingCount || 0) + 1)))
          .slice(0, missing);
        
        uniqueStops = [...uniqueStops, ...sorted];
        
        // Remove duplicates again - check ONLY exact name match
        const seenNames = new Set();
        const finalStops = [];
        
        for (const stop of uniqueStops) {
          const normalizedName = stop.name.toLowerCase().trim();
          
          if (!seenNames.has(normalizedName)) {
            finalStops.push(stop);
            seenNames.add(normalizedName);
          } else {
            console.log('[DEDUP Round 2] Removed duplicate:', stop.name);
          }
        }
        
        uniqueStops = finalStops;
        
        console.log('[ROUTE] Round 2 complete:', { added: sorted.length, total: uniqueStops.length });
      }
      
      // Show errors if any occurred
      if (fetchErrors.length > 0) {
        const errorMsg = fetchErrors.map(e => `${e.interest}: ${e.error}`).join(', ');
        
        console.error('[ROUTE] Data source errors:', fetchErrors);
        showToast(`×©×’×™××•×ª ×‘×§×‘×œ×ª ××§×•××•×ª: ${errorMsg}`, 'warning');
      }
      
      if (uniqueStops.length === 0) {
        showToast('×œ× × ××¦××• ××§×•××•×ª. × ×¡×” ×ª×—×•××™ ×¢× ×™×™×Ÿ ××• ××–×•×¨ ××—×¨.', 'error');
        setIsGenerating(false);
        return;
      }

      const selectedArea = areaOptions.find(a => a.id === formData.area);
      
      // Generate default name: "Area - interests #number"
      const areaName = selectedArea?.label || '×‘× ×§×•×§';
      const interestsText = formData.interests
        .map(id => allInterestOptions.filter(o => o && o.id).find(o => o.id === id)?.label)
        .filter(Boolean)
        .join(', ');
      
      // Find highest sequential number for similar routes
      const baseName = `${areaName} - ${interestsText}`;
      const existingNumbers = savedRoutes
        .filter(r => r.name && r.name.startsWith(baseName))
        .map(r => {
          const match = r.name.match(/#(\d+)$/);
          return match ? parseInt(match[1]) : 0;
        });
      const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
      const defaultName = `${baseName} #${nextNumber}`;
      
      const newRoute = {
        id: Date.now(),
        name: '', // Will be set when user saves
        defaultName: defaultName,
        createdAt: new Date().toISOString(),
        areaName: areaName,
        interestsText: interestsText,
        title: `${areaName} - ${uniqueStops.length} ××§×•××•×ª`,
        description: `××¡×œ×•×œ ${routeType === 'circular' ? '××¢×’×œ×™' : '×œ×™× ××¨×™'}`,
        duration: formData.hours, // Keep for backward compatibility but not displayed
        circular: routeType === 'circular',
        startPoint: (startPointCoords?.address) || formData.startPoint || '×”×ª×—×œ×” ××”××§×•× ×”×¨××©×•×Ÿ ×‘×¨×©×™××”',
        startPointCoords: startPointCoords || null,
        stops: uniqueStops,
        preferences: { ...formData },
        stats: {
          custom: customStops.length,
          fetched: uniqueStops.length - customStops.length,
          total: uniqueStops.length
        },
        // Warning if didn't reach maxStops
        incomplete: uniqueStops.length < maxStops ? {
          requested: maxStops,
          found: uniqueStops.length,
          missing: maxStops - uniqueStops.length
        } : null,
        // Errors if any
        errors: fetchErrors.length > 0 ? fetchErrors : null
      };

      console.log('[ROUTE] Route created successfully:', {
        stops: newRoute.stops.length,
        stats: newRoute.stats,
        incomplete: newRoute.incomplete,
        errors: newRoute.errors
      });

      setRoute(newRoute);
      console.log('[ROUTE] Route set, staying in form view');
      console.log('[ROUTE] Route object:', newRoute);
      
      // Scroll to results
      setTimeout(() => {
        document.getElementById('route-results')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
      
      // Stay in form view to show compact list
    } catch (error) {
      console.error('[ROUTE] Fatal error generating route:', error);
      showToast(`×©×’×™××”: ${error.message || '×©×’×™××” ×œ× ×™×“×•×¢×”'}`, 'error');
    } finally {
      setIsGenerating(false);
    }
  };

  // Fetch more places for a specific interest
  const fetchMoreForInterest = async (interest) => {
    if (!route) return;
    
    setIsGenerating(true);
    
    try {
      const fetchCount = formData.fetchMoreCount || 3;
      console.log(`[FETCH_MORE] Fetching ${fetchCount} more for interest: ${interest}`);
      
      let newPlaces = await fetchGooglePlaces(formData.area, [interest]);
      
      // Filter blacklisted places and duplicates of custom locations
      newPlaces = filterBlacklist(newPlaces);
      newPlaces = filterDuplicatesOfCustom(newPlaces);
      
      // Filter duplicates of places already in route (by name)
      const existingNames = route.stops.map(s => s.name.toLowerCase());
      newPlaces = newPlaces.filter(p => !existingNames.includes(p.name.toLowerCase()));
      
      // Sort by rating (descending) - rating is for prioritization only
      newPlaces.sort((a, b) => (b.rating * Math.log10((b.ratingCount || 0) + 1)) - (a.rating * Math.log10((a.ratingCount || 0) + 1)));
      
      // Take only what we need and mark as addedLater
      const placesToAdd = newPlaces.slice(0, fetchCount).map(p => ({
        ...p,
        addedLater: true
      }));
      
      if (placesToAdd.length === 0) {
        showToast(`×œ× × ××¦××• ×¢×•×“ ××§×•××•×ª ×‘${allInterestOptions.find(o => o.id === interest)?.label}`, 'warning');
        return;
      }
      
      // Append new places at the end of the route
      const updatedRoute = {
        ...route,
        stops: [...route.stops, ...placesToAdd]
      };
      
      setRoute(updatedRoute);
      showToast(`× ×•×¡×¤×• ${placesToAdd.length} ××§×•××•×ª ×œ${allInterestOptions.find(o => o.id === interest)?.label}!`, 'success');
      
    } catch (error) {
      console.error('[FETCH_MORE] Error:', error);
      showToast('×©×’×™××” ×‘×”×•×¡×¤×ª ××§×•××•×ª', 'error');
    } finally {
      setIsGenerating(false);
    }
  };

  // Fetch more places for all interests
  const fetchMoreAll = async () => {
    if (!route) return;
    
    setIsGenerating(true);
    
    try {
      const fetchCount = formData.fetchMoreCount || 3;
      const perInterest = Math.ceil(fetchCount / formData.interests.length);
      
      console.log(`[FETCH_MORE_ALL] Fetching ${perInterest} per interest, total: ${fetchCount}`);
      
      const allNewPlaces = [];
      
      for (const interest of formData.interests) {
        let newPlaces = await fetchGooglePlaces(formData.area, [interest]);
        
        // Filter blacklisted places and duplicates of custom locations
        newPlaces = filterBlacklist(newPlaces);
        newPlaces = filterDuplicatesOfCustom(newPlaces);
        
        // Filter duplicates
        const existingNames = [...route.stops, ...allNewPlaces].map(s => s.name.toLowerCase());
        newPlaces = newPlaces.filter(p => !existingNames.includes(p.name.toLowerCase()));
        
        allNewPlaces.push(...newPlaces.slice(0, perInterest));
      }
      
      if (allNewPlaces.length === 0) {
        showToast('×œ× × ××¦××• ×¢×•×“ ××§×•××•×ª', 'warning');
        return;
      }
      
      const updatedRoute = {
        ...route,
        stops: [...route.stops, ...allNewPlaces]
      };
      
      setRoute(updatedRoute);
      showToast(`× ×•×¡×¤×• ${allNewPlaces.length} ××§×•××•×ª!`, 'success');
      
      // Scroll to results
      setTimeout(() => {
        document.getElementById('route-results')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
      
    } catch (error) {
      console.error('[FETCH_MORE_ALL] Error:', error);
      showToast('×©×’×™××” ×‘×”×•×¡×¤×ª ××§×•××•×ª', 'error');
    } finally {
      setIsGenerating(false);
    }
  };

  // Filter blacklisted places
  // Filter out places that exist in custom locations with status='blacklist' (exact name match)
  const filterBlacklist = (places) => {
    const blacklistedNames = customLocations
      .filter(loc => loc.status === 'blacklist')
      .map(loc => loc.name.toLowerCase().trim());
    
    if (blacklistedNames.length === 0) return places;
    
    return places.filter(place => {
      const placeName = place.name.toLowerCase().trim();
      const isBlacklisted = blacklistedNames.includes(placeName);
      if (isBlacklisted) {
        console.log(`[BLACKLIST] Filtered out: ${place.name}`);
      }
      return !isBlacklisted;
    });
  };
  
  // Filter out Google places that already exist in custom locations (exact name match)
  const filterDuplicatesOfCustom = (places) => {
    const customNames = customLocations
      .filter(loc => loc.status !== 'blacklist')
      .map(loc => loc.name.toLowerCase().trim());
    
    if (customNames.length === 0) return places;
    
    return places.filter(place => {
      const placeName = place.name.toLowerCase().trim();
      const isDuplicate = customNames.includes(placeName);
      if (isDuplicate) {
        console.log(`[DEDUP] Filtered Google duplicate of custom location: ${place.name}`);
      }
      return !isDuplicate;
    });
  };

  // Strip heavy data (base64 images) from route before localStorage save
  const stripRouteForStorage = (r) => {
    const stripped = { ...r };
    if (stripped.stops) {
      stripped.stops = stripped.stops.map(s => {
        const { uploadedImage, ...rest } = s;
        return rest;
      });
    }
    return stripped;
  };

  const saveRoutesToStorage = (routes) => {
    try {
      const stripped = routes.map(stripRouteForStorage);
      localStorage.setItem('bangkok_saved_routes', JSON.stringify(stripped));
    } catch (e) {
      console.error('[STORAGE] Failed to save routes:', e);
      showToast('×©×’×™××” ×‘×©××™×¨×” - ××—×¡×•×Ÿ ××œ×. × ×¡×” ×œ××—×•×§ ××¡×œ×•×œ×™× ×™×©× ×™×', 'error');
    }
  };

  const quickSaveRoute = () => {
    const name = route.defaultName || route.name || `××¡×œ×•×œ ${Date.now()}`;
    
    const routeToSave = {
      ...route,
      name: name,
      notes: '',
      savedAt: new Date().toISOString(),
      inProgress: true,
      locked: false
    };

    const updated = [routeToSave, ...savedRoutes];
    setSavedRoutes(updated);
    saveRoutesToStorage(updated);
    
    setRoute(routeToSave);
    showToast('×”××¡×œ×•×œ × ×©××¨!', 'success');
    
    // Open new route dialog
    setEditingRoute({...routeToSave});
    setRouteDialogMode('add');
    setShowRouteDialog(true);
  };

  const deleteRoute = (routeId) => {
    const updated = savedRoutes.filter(r => r.id !== routeId);
    setSavedRoutes(updated);
    saveRoutesToStorage(updated);
    showToast('×”××¡×œ×•×œ × ××—×§', 'success');
  };

  const updateRoute = (routeId, updates) => {
    const updated = savedRoutes.map(r => r.id === routeId ? { ...r, ...updates } : r);
    setSavedRoutes(updated);
    saveRoutesToStorage(updated);
    showToast('×”××¡×œ×•×œ ×¢×•×“×›×Ÿ', 'success');
  };

  const loadSavedRoute = (savedRoute) => {
    setRoute(savedRoute);
    // Restore startPoint: prefer startPointCoords.address (validated), then route.startPoint, then preferences
    const coords = savedRoute.startPointCoords || null;
    const validatedAddress = coords?.address || '';
    const startPointText = validatedAddress || 
      (savedRoute.startPoint !== '×”×ª×—×œ×” ××”××§×•× ×”×¨××©×•×Ÿ ×‘×¨×©×™××”' ? savedRoute.startPoint : '') || 
      '';
    setFormData({...savedRoute.preferences, startPoint: startPointText });
    setStartPointCoords(coords);
    // Restore route type (circular/linear)
    setRouteType(savedRoute.circular ? 'circular' : 'linear');
    setCurrentView('route');
  };

  // NOTE: addCustomInterest logic is now inline in the dialog footer (see Add Interest Dialog)
  // This allows direct configuration of search settings when creating an interest

  const deleteCustomInterest = (interestId) => {
    const interestToDelete = customInterests.find(i => i.id === interestId);
    
    // Check if any custom locations use this interest
    const locationsUsingInterest = customLocations.filter(loc => 
      loc.interests && loc.interests.includes(interestId)
    );
    
    // Delete from Firebase (or localStorage fallback)
    if (isFirebaseAvailable && database) {
      // DYNAMIC MODE: Firebase (shared)
      if (interestToDelete && interestToDelete.firebaseId) {
        database.ref(`customInterests/${interestToDelete.firebaseId}`).remove()
          .then(() => {
            console.log('[FIREBASE] Interest deleted from shared database');
            if (locationsUsingInterest.length > 0) {
              showToast(`×ª×—×•× × ××—×§ (${locationsUsingInterest.length} ××§×•××•×ª ×¢×“×™×™×Ÿ ××©×ª××©×™× ×‘×•)`, 'success');
            } else {
              showToast('×ª×—×•× × ××—×§!', 'success');
            }
          })
          .catch((error) => {
            console.error('[FIREBASE] Error deleting interest:', error);
            showToast('×©×’×™××” ×‘××—×™×§×”', 'error');
          });
      }
    } else {
      // STATIC MODE: localStorage (local)
      const updated = customInterests.filter(i => i.id !== interestId);
      setCustomInterests(updated);
      localStorage.setItem('bangkok_custom_interests', JSON.stringify(updated));
      
      if (locationsUsingInterest.length > 0) {
        showToast(`×ª×—×•× × ××—×§ (${locationsUsingInterest.length} ××§×•××•×ª ×¢×“×™×™×Ÿ ××©×ª××©×™× ×‘×•)`, 'success');
      } else {
        showToast('×ª×—×•× × ××—×§!', 'success');
      }
    }
  };

  // Toggle interest active/inactive status
  const toggleInterestStatus = (interestId) => {
    const newStatus = !interestStatus[interestId];
    const updatedStatus = { ...interestStatus, [interestId]: newStatus };
    setInterestStatus(updatedStatus);
    
    if (isFirebaseAvailable && database) {
      database.ref(`settings/interestStatus/${interestId}`).set(newStatus)
        .then(() => {
          console.log('[FIREBASE] Interest status updated:', interestId, newStatus);
        })
        .catch(err => {
          console.error('Error updating interest status:', err);
        });
    } else {
      localStorage.setItem('bangkok_interest_status', JSON.stringify(updatedStatus));
    }
  };

  // Check if interest has valid search config
  const isInterestValid = (interestId) => {
    const config = interestConfig[interestId];
    if (!config) return false;
    
    // Valid if has textSearch OR has types array with items
    if (config.textSearch && config.textSearch.trim()) return true;
    if (config.types && Array.isArray(config.types) && config.types.length > 0) return true;
    
    return false;
  };

  const deleteCustomLocation = (locationId) => {
    const locationToDelete = customLocations.find(loc => loc.id === locationId);
    
    // Delete from Firebase (or localStorage fallback)
    if (isFirebaseAvailable && database) {
      // DYNAMIC MODE: Firebase (shared)
      if (locationToDelete && locationToDelete.firebaseId) {
        database.ref(`customLocations/${locationToDelete.firebaseId}`).remove()
          .then(() => {
            console.log('[FIREBASE] Location deleted from shared database');
            showToast('×”××§×•× × ××—×§!', 'success');
          })
          .catch((error) => {
            console.error('[FIREBASE] Error deleting location:', error);
            showToast('×©×’×™××” ×‘××—×™×§×”', 'error');
          });
      }
    } else {
      // STATIC MODE: localStorage (local)
      const updated = customLocations.filter(loc => loc.id !== locationId);
      setCustomLocations(updated);
      localStorage.setItem('bangkok_custom_locations', JSON.stringify(updated));
      showToast('×”××§×•× × ××—×§!', 'success');
    }
  };
  
  // Toggle location status with review state
  const toggleLocationStatus = (locationId) => {
    const location = customLocations.find(loc => loc.id === locationId);
    if (!location) return;
    
    let newStatus = location.status;
    let newInProgress = location.inProgress;
    
    if (location.status === 'blacklist') {
      // From blacklist â†’ review (with inProgress badge)
      newStatus = 'review';
      newInProgress = true;
    } else if (location.status === 'review') {
      // From review â†’ active (remove badge)
      newStatus = 'active';
      newInProgress = false;
    } else {
      // From active â†’ blacklist
      newStatus = 'blacklist';
      newInProgress = false;
    }
    
    // Update in Firebase (or localStorage fallback)
    if (isFirebaseAvailable && database) {
      // DYNAMIC MODE: Firebase (shared)
      if (location.firebaseId) {
        database.ref(`customLocations/${location.firebaseId}`).update({
          status: newStatus,
          inProgress: newInProgress
        })
          .then(() => {
            const statusText = 
              newStatus === 'blacklist' ? 'ğŸš« ×“×œ×’ ×ª××™×“' : 
              newStatus === 'review' ? 'ğŸ› ï¸ ×‘×‘×“×™×§×”' : 
              'âœ… ×›×œ×•×œ';
            showToast(`${location.name}: ${statusText}`, 'success');
          })
          .catch((error) => {
            console.error('[FIREBASE] Error updating status:', error);
            showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ', 'error');
          });
      }
    } else {
      // STATIC MODE: localStorage (local)
      const updated = customLocations.map(loc => {
        if (loc.id === locationId) {
          return { ...loc, status: newStatus, inProgress: newInProgress };
        }
        return loc;
      });
      setCustomLocations(updated);
      localStorage.setItem('bangkok_custom_locations', JSON.stringify(updated));
      
      const statusText = 
        newStatus === 'blacklist' ? 'ğŸš« ×“×œ×’ ×ª××™×“' : 
        newStatus === 'review' ? 'ğŸ› ï¸ ×‘×‘×“×™×§×”' : 
        'âœ… ×›×œ×•×œ';
      showToast(`${location.name}: ${statusText}`, 'success');
    }
  };
  
  // Handle edit location - populate form with existing data
  const handleEditLocation = (loc) => {
    console.log('[EDIT] ====== Opening edit ======');
    console.log('[EDIT] Location object:', JSON.stringify(loc, null, 2));
    console.log('[EDIT] Name:', loc.name);
    console.log('[EDIT] Description:', loc.description);
    console.log('[EDIT] Interests:', loc.interests);
    
    setEditingLocation(loc);
    const editFormData = {
      name: loc.name || '',
      description: loc.description || '',
      notes: loc.notes || '',
      area: loc.area || formData.area,
      interests: loc.interests || [],
      lat: loc.lat || null,
      lng: loc.lng || null,
      mapsUrl: loc.mapsUrl || '',
      address: loc.address || '',
      uploadedImage: loc.uploadedImage || null,
      imageUrls: loc.imageUrls || [],
      inProgress: loc.inProgress || false,
      locked: loc.locked || false
    };
    
    console.log('[EDIT] Form data prepared:', JSON.stringify(editFormData, null, 2));
    setNewLocation(editFormData);
    console.log('[EDIT] newLocation state updated');
    setGooglePlaceInfo(null);
    setShowEditLocationDialog(true);
    console.log('[EDIT] Dialog opened');
  };
  
  // Add Google place to My Locations
  const addGooglePlaceToCustom = async (place) => {
    // Check if already exists (by name, case-insensitive)
    const exists = customLocations.find(loc => 
      loc.name.toLowerCase().trim() === place.name.toLowerCase().trim()
    );
    
    if (exists) {
      showToast(`"${place.name}" ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××” ×©×œ×š`, 'warning');
      return false;
    }
    
    // Set adding state for dimmed button
    const placeId = place.id || place.name;
    setAddingPlaceIds(prev => [...prev, placeId]);
    
    const boundaryCheck = checkLocationInArea(place.lat, place.lng, formData.area);
    
    const locationToAdd = {
      id: Date.now(),
      name: place.name,
      description: place.description || '× ×•×¡×£ ×-Google',
      notes: '',
      area: formData.area,
      interests: place.interests || [],
      lat: place.lat,
      lng: place.lng,
      uploadedImage: null,
      imageUrls: [],
      outsideArea: !boundaryCheck.valid,
      duration: 45,
      custom: true,
      status: 'active',
      inProgress: false,
      addedAt: new Date().toISOString(),
      fromGoogle: true // Mark as added from Google
    };
    
    // Save to Firebase (or localStorage fallback)
    if (isFirebaseAvailable && database) {
      try {
        await database.ref('customLocations').push(locationToAdd);
        addDebugLog('ADD', `Added "${place.name}" to Firebase`);
        showToast(`"${place.name}" × ×•×¡×£ ×œ×¨×©×™××” ×©×œ×š!`, 'success');
        setAddingPlaceIds(prev => prev.filter(id => id !== placeId));
        return true;
      } catch (error) {
        console.error('[FIREBASE] Error adding Google place:', error);
        addDebugLog('ERROR', `Failed to add "${place.name}"`, error);
        showToast('×©×’×™××” ×‘×©××™×¨×”', 'error');
        setAddingPlaceIds(prev => prev.filter(id => id !== placeId));
        return false;
      }
    } else {
      const updated = [...customLocations, locationToAdd];
      setCustomLocations(updated);
      localStorage.setItem('bangkok_custom_locations', JSON.stringify(updated));
      showToast(`"${place.name}" × ×•×¡×£ ×œ×¨×©×™××” ×©×œ×š!`, 'success');
      setAddingPlaceIds(prev => prev.filter(id => id !== placeId));
      return true;
    }
  };
  
  // Skip place permanently (add to blacklist)
  const skipPlacePermanently = (place) => {
    // Check if already exists
    const exists = customLocations.find(loc => 
      loc.name.toLowerCase() === place.name.toLowerCase()
    );
    
    if (exists) {
      // Already exists - just update status to blacklist
      if (exists.status === 'blacklist') {
        showToast(`"${place.name}" ×›×‘×¨ ×‘×¨×©×™××ª ×“×™×œ×•×’`, 'warning');
        return;
      }
      
      // Update existing location to blacklist
      const locationId = exists.id;
      
      if (isFirebaseAvailable && database && exists.firebaseId) {
        database.ref(`customLocations/${exists.firebaseId}`).update({
          status: 'blacklist',
          inProgress: false
        })
          .then(() => {
            showToast(`"${place.name}" × ×•×¡×£ ×œ×“×™×œ×•×’ ×§×‘×•×¢`, 'success');
          })
          .catch((error) => {
            console.error('[FIREBASE] Error updating to blacklist:', error);
            showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ', 'error');
          });
      } else {
        const updated = customLocations.map(loc => {
          if (loc.id === locationId) {
            return { ...loc, status: 'blacklist', inProgress: false };
          }
          return loc;
        });
        setCustomLocations(updated);
        localStorage.setItem('bangkok_custom_locations', JSON.stringify(updated));
        showToast(`"${place.name}" × ×•×¡×£ ×œ×“×™×œ×•×’ ×§×‘×•×¢`, 'success');
      }
      return;
    }
    
    // Doesn't exist - create new with blacklist status
    const boundaryCheck = checkLocationInArea(place.lat, place.lng, formData.area);
    
    // IMPORTANT: Copy interests from the place - blacklist needs same validation as active
    const locationToAdd = {
      id: Date.now(),
      name: place.name,
      description: place.description || '× ×•×¡×£ ××—×™×¤×•×©',
      notes: '',
      area: formData.area,
      interests: place.interests && place.interests.length > 0 ? place.interests : [],
      lat: place.lat,
      lng: place.lng,
      uploadedImage: null,
      imageUrls: [],
      outsideArea: !boundaryCheck.valid,
      duration: 45,
      custom: true,
      status: 'blacklist', // Start as blacklisted!
      inProgress: false,
      addedAt: new Date().toISOString(),
      fromGoogle: true
    };
    
    // Save to Firebase (or localStorage fallback)
    if (isFirebaseAvailable && database) {
      database.ref('customLocations').push(locationToAdd)
        .then(() => {
          console.log('[FIREBASE] Place added to blacklist');
          showToast(`"${place.name}" × ×•×¡×£ ×œ×“×™×œ×•×’ ×§×‘×•×¢`, 'success');
        })
        .catch((error) => {
          console.error('[FIREBASE] Error adding to blacklist:', error);
          showToast('×©×’×™××” ×‘×©××™×¨×”', 'error');
        });
    } else {
      const updated = [...customLocations, locationToAdd];
      setCustomLocations(updated);
      localStorage.setItem('bangkok_custom_locations', JSON.stringify(updated));
      showToast(`"${place.name}" × ×•×¡×£ ×œ×“×™×œ×•×’ ×§×‘×•×¢`, 'success');
    }
  };
  
  // Import function - add new only, skip existing
  const handleImportMerge = async () => {
    let addedInterests = 0;
    let skippedInterests = 0;
    let addedLocations = 0;
    let skippedLocations = 0;
    let addedRoutes = 0;
    let skippedRoutes = 0;
    let updatedConfigs = 0;
    let updatedStatuses = 0;
    
    // Helper to check if interest exists by label (not id)
    const interestExistsByLabel = (label) => {
      return customInterests.find(i => (i.label || i.name || '').toLowerCase() === label.toLowerCase());
    };
    
    // Helper to check if location exists by name (not id)
    const locationExistsByName = (name) => {
      return customLocations.find(l => l.name.toLowerCase() === name.toLowerCase());
    };
    
    // Import to Firebase (or localStorage fallback)
    if (isFirebaseAvailable && database) {
      // DYNAMIC MODE: Firebase (shared)
      
      // 1. Import custom interests
      for (const interest of (importedData.customInterests || [])) {
        const label = interest.label || interest.name;
        if (!label) continue;
        
        const exists = interestExistsByLabel(label);
        if (exists) {
          skippedInterests++;
          continue;
        }
        
        try {
          const interestId = interest.id || `custom_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
          const newInterest = {
            id: interestId,
            label: label,
            name: label,
            icon: interest.icon || 'ğŸ“',
            inProgress: interest.inProgress || false,
            locked: interest.locked || false
          };
          await database.ref(`customInterests/${interestId}`).set(newInterest);
          addedInterests++;
        } catch (error) {
          console.error('[FIREBASE] Error importing interest:', error);
        }
      }
      
      // 2. Import interest configurations (search settings)
      if (importedData.interestConfig) {
        for (const [interestId, config] of Object.entries(importedData.interestConfig)) {
          try {
            await database.ref(`settings/interestConfig/${interestId}`).set(config);
            updatedConfigs++;
          } catch (error) {
            console.error('[FIREBASE] Error importing config:', error);
          }
        }
      }
      
      // 3. Import interest statuses (active/inactive)
      if (importedData.interestStatus) {
        for (const [interestId, status] of Object.entries(importedData.interestStatus)) {
          try {
            await database.ref(`settings/interestStatus/${interestId}`).set(status);
            updatedStatuses++;
          } catch (error) {
            console.error('[FIREBASE] Error importing status:', error);
          }
        }
      }
      
      // 4. Import locations
      for (const loc of (importedData.customLocations || [])) {
        if (!loc.name) continue;
        
        const exists = locationExistsByName(loc.name);
        if (exists) {
          skippedLocations++;
          continue;
        }
        
        try {
          const newLocation = {
            id: loc.id || Date.now() + Math.floor(Math.random() * 1000),
            name: loc.name.trim(),
            description: loc.description || loc.notes || '',
            notes: loc.notes || '',
            area: loc.area || 'sukhumvit',
            interests: Array.isArray(loc.interests) ? loc.interests : [],
            lat: loc.lat || null,
            lng: loc.lng || null,
            mapsUrl: loc.mapsUrl || '',
            address: loc.address || '',
            uploadedImage: loc.uploadedImage || null,
            imageUrls: Array.isArray(loc.imageUrls) ? loc.imageUrls : [],
            outsideArea: loc.outsideArea || false,
            missingCoordinates: !loc.lat || !loc.lng,
            duration: loc.duration || 45,
            custom: true,
            status: loc.status || 'active',
            inProgress: loc.inProgress || false,
            locked: loc.locked || false,
            rating: loc.rating || null,
            ratingCount: loc.ratingCount || null,
            fromGoogle: loc.fromGoogle || false,
            addedAt: loc.addedAt || new Date().toISOString()
          };
          
          await database.ref('customLocations').push(newLocation);
          addedLocations++;
        } catch (error) {
          console.error('[FIREBASE] Error importing location:', error);
        }
      }
      
      // 5. Import saved routes
      const newRoutes = [...savedRoutes];
      (importedData.savedRoutes || []).forEach(route => {
        if (!route.name) return;
        
        const exists = newRoutes.find(r => r.name.toLowerCase() === route.name.toLowerCase());
        if (exists) {
          skippedRoutes++;
          return;
        }
        
        newRoutes.push({
          ...route,
          id: route.id || Date.now() + Math.floor(Math.random() * 1000),
          importedAt: new Date().toISOString()
        });
        addedRoutes++;
      });
      
      setSavedRoutes(newRoutes);
      saveRoutesToStorage(newRoutes);
      
    } else {
      // STATIC MODE: localStorage (local)
      const newInterests = [...customInterests];
      const newLocations = [...customLocations];
      const newConfig = { ...interestConfig };
      const newStatus = { ...interestStatus };
      
      // 1. Import custom interests
      (importedData.customInterests || []).forEach(interest => {
        const label = interest.label || interest.name;
        if (!label) return;
        
        const exists = newInterests.find(i => (i.label || i.name || '').toLowerCase() === label.toLowerCase());
        if (exists) {
          skippedInterests++;
          return;
        }
        
        const interestId = interest.id || `custom_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
        newInterests.push({
          id: interestId,
          label: label,
          name: label,
          icon: interest.icon || 'ğŸ“',
          inProgress: interest.inProgress || false,
          locked: interest.locked || false
        });
        addedInterests++;
      });
      
      // 2. Import interest configurations
      if (importedData.interestConfig) {
        Object.entries(importedData.interestConfig).forEach(([id, config]) => {
          newConfig[id] = config;
          updatedConfigs++;
        });
      }
      
      // 3. Import interest statuses
      if (importedData.interestStatus) {
        Object.entries(importedData.interestStatus).forEach(([id, status]) => {
          newStatus[id] = status;
          updatedStatuses++;
        });
      }
      
      // 4. Import locations
      (importedData.customLocations || []).forEach(loc => {
        if (!loc.name) return;
        
        const exists = newLocations.find(l => l.name.toLowerCase() === loc.name.toLowerCase());
        if (exists) {
          skippedLocations++;
          return;
        }
        
        const newLocation = {
          id: loc.id || Date.now() + Math.floor(Math.random() * 1000),
          name: loc.name.trim(),
          description: loc.description || loc.notes || '',
          notes: loc.notes || '',
          area: loc.area || 'sukhumvit',
          interests: Array.isArray(loc.interests) ? loc.interests : [],
          lat: loc.lat || null,
          lng: loc.lng || null,
          mapsUrl: loc.mapsUrl || '',
          address: loc.address || '',
          uploadedImage: loc.uploadedImage || null,
          imageUrls: Array.isArray(loc.imageUrls) ? loc.imageUrls : [],
          outsideArea: loc.outsideArea || false,
          missingCoordinates: !loc.lat || !loc.lng,
          duration: loc.duration || 45,
          custom: true,
          status: loc.status || 'active',
          inProgress: loc.inProgress || false,
          locked: loc.locked || false,
          rating: loc.rating || null,
          ratingCount: loc.ratingCount || null,
          fromGoogle: loc.fromGoogle || false,
          addedAt: loc.addedAt || new Date().toISOString()
        };
        
        newLocations.push(newLocation);
        addedLocations++;
      });
      
      // 5. Import saved routes
      const newRoutes = [...savedRoutes];
      (importedData.savedRoutes || []).forEach(route => {
        if (!route.name) return;
        
        const exists = newRoutes.find(r => r.name.toLowerCase() === route.name.toLowerCase());
        if (exists) {
          skippedRoutes++;
          return;
        }
        
        newRoutes.push({
          ...route,
          id: route.id || Date.now() + Math.floor(Math.random() * 1000),
          importedAt: new Date().toISOString()
        });
        addedRoutes++;
      });
      
      setCustomInterests(newInterests);
      setCustomLocations(newLocations);
      setSavedRoutes(newRoutes);
      setInterestConfig(newConfig);
      setInterestStatus(newStatus);
      
      localStorage.setItem('bangkok_custom_interests', JSON.stringify(newInterests));
      localStorage.setItem('bangkok_custom_locations', JSON.stringify(newLocations));
      saveRoutesToStorage(newRoutes);
      localStorage.setItem('bangkok_interest_status', JSON.stringify(newStatus));
    }
    
    setShowImportDialog(false);
    setImportedData(null);
    
    // Build detailed report
    const report = [];
    if (addedInterests > 0 || skippedInterests > 0) {
      report.push(`×ª×—×•××™×: +${addedInterests}`);
    }
    if (updatedConfigs > 0) {
      report.push(`×”×’×“×¨×•×ª: +${updatedConfigs}`);
    }
    if (addedLocations > 0 || skippedLocations > 0) {
      report.push(`××§×•××•×ª: +${addedLocations}`);
    }
    if (addedRoutes > 0 || skippedRoutes > 0) {
      report.push(`××¡×œ×•×œ×™×: +${addedRoutes}`);
    }
    
    const totalAdded = addedInterests + addedLocations + addedRoutes + updatedConfigs;
    showToast(report.join(' | ') || '×œ× × ××¦××• ×¤×¨×™×˜×™× ×œ×™×™×‘×•×', totalAdded > 0 ? 'success' : 'warning');
  };

  const addCustomLocation = (closeAfter = true) => {
    if (!newLocation.name.trim() || newLocation.interests.length === 0) {
      return; // Just don't add if validation fails
    }
    
    // Check for duplicate name
    const exists = customLocations.find(loc => 
      loc.name.toLowerCase().trim() === newLocation.name.toLowerCase().trim()
    );
    if (exists) {
      showToast(`"${newLocation.name}" ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××”`, 'warning');
      return;
    }
    
    // Use provided coordinates (can be null)
    let lat = newLocation.lat;
    let lng = newLocation.lng;
    let outsideArea = false;
    let hasCoordinates = (lat !== null && lng !== null && lat !== 0 && lng !== 0);
    
    // Check if location is within area boundaries (only if has coordinates)
    if (hasCoordinates) {
      const boundaryCheck = checkLocationInArea(lat, lng, newLocation.area);
      const areaName = areaOptions.find(a => a.id === newLocation.area)?.label || newLocation.area;
      outsideArea = !boundaryCheck.valid;
      
      if (!boundaryCheck.valid) {
        showToast(
          `××–×”×¨×”: ×”××™×§×•× ${boundaryCheck.distanceKm} ×§"× ××—×•×¥ ×œ××–×•×¨ ${areaName}. × ×©××¨ ×‘×›×œ ×–××ª.`,
          'warning'
        );
      }
    }
    
    const newId = Date.now();
    const locationToAdd = {
      id: newId,
      name: newLocation.name.trim(),
      description: newLocation.description.trim() || newLocation.notes?.trim() || '××§×•× ×©×”×•×¡×¤×ª×™',
      notes: newLocation.notes?.trim() || '',
      area: newLocation.area,
      interests: newLocation.interests,
      lat: lat,
      lng: lng,
      mapsUrl: newLocation.mapsUrl || '',
      address: newLocation.address || '',
      uploadedImage: newLocation.uploadedImage || null,
      imageUrls: newLocation.imageUrls || [],
      outsideArea: outsideArea, // Flag for outside area
      missingCoordinates: !hasCoordinates, // Flag for missing coordinates
      duration: 45,
      custom: true,
      status: 'active',
      inProgress: newLocation.inProgress || false,
      locked: newLocation.locked || false,
      addedAt: new Date().toISOString()
    };
    
    // Save to Firebase (or localStorage fallback)
    if (isFirebaseAvailable && database) {
      // DYNAMIC MODE: Firebase (shared)
      database.ref('customLocations').push(locationToAdd)
        .then((ref) => {
          console.log('[FIREBASE] Location added to shared database');
          showToast('×”××§×•× × ×•×¡×£ ×•× ×©××¨ ×œ×›×•×œ×!', 'success');
          
          // If staying open, switch to edit mode
          if (!closeAfter) {
            const addedWithFirebaseId = { ...locationToAdd, firebaseId: ref.key };
            setEditingLocation(addedWithFirebaseId);
            setShowAddLocationDialog(false);
            setShowEditLocationDialog(true);
          }
        })
        .catch((error) => {
          console.error('[FIREBASE] Error adding location:', error);
          showToast('×©×’×™××” ×‘×©××™×¨×”', 'error');
        });
    } else {
      // STATIC MODE: localStorage (local)
      const updated = [...customLocations, locationToAdd];
      setCustomLocations(updated);
      localStorage.setItem('bangkok_custom_locations', JSON.stringify(updated));
      showToast('×”××§×•× × ×•×¡×£!', 'success');
      
      // If staying open, switch to edit mode
      if (!closeAfter) {
        setEditingLocation(locationToAdd);
        setShowAddLocationDialog(false);
        setShowEditLocationDialog(true);
      }
    }
    
    // Add to current route if exists (only if has coordinates)
    if (route && hasCoordinates) {
      const updatedRoute = {
        ...route,
        stops: [...route.stops, locationToAdd]
      };
      setRoute(updatedRoute);
    }
    
    if (closeAfter) {
      setShowAddLocationDialog(false);
      setNewLocation({ 
        name: '', 
        description: '', 
        notes: '',
        area: formData.area, 
        interests: [], 
        lat: null, 
        lng: null, 
        mapsUrl: '',
        address: '',
        uploadedImage: null,
        imageUrls: []
      });
    }
  };
  
  // Update existing location
  const updateCustomLocation = (closeAfter = true) => {
    if (!newLocation.name?.trim()) {
      showToast('×× × ×”×–×Ÿ ×©× ×œ××§×•×', 'warning');
      return;
    }
    
    // Check for duplicate name (exclude current location)
    const exists = customLocations.find(loc => 
      loc.name.toLowerCase().trim() === newLocation.name.toLowerCase().trim() &&
      loc.id !== editingLocation.id
    );
    if (exists) {
      showToast(`"${newLocation.name}" ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××”`, 'warning');
      return;
    }
    
    // Use provided coordinates (can be null)
    let hasCoordinates = (newLocation.lat !== null && newLocation.lng !== null && 
                          newLocation.lat !== 0 && newLocation.lng !== 0);
    let outsideArea = false;
    
    // Check if location is within area boundaries (only if has coordinates)
    if (hasCoordinates) {
      const boundaryCheck = checkLocationInArea(newLocation.lat, newLocation.lng, newLocation.area);
      const areaName = areaOptions.find(a => a.id === newLocation.area)?.label || newLocation.area;
      outsideArea = !boundaryCheck.valid;
      
      if (!boundaryCheck.valid) {
        showToast(
          `××–×”×¨×”: ×”××™×§×•× ${boundaryCheck.distanceKm} ×§"× ××—×•×¥ ×œ××–×•×¨ ${areaName}. × ×©××¨ ×‘×›×œ ×–××ª.`,
          'warning'
        );
      }
    }
    
    const updatedLocation = { 
      ...editingLocation, // Keep existing fields like status, inProgress
      ...newLocation, // Override with edited fields
      custom: true, 
      id: editingLocation.id,
      outsideArea: outsideArea, // Flag for outside area
      missingCoordinates: !hasCoordinates // Flag for missing coordinates
    };
    
    // Update in Firebase (or localStorage fallback)
    if (isFirebaseAvailable && database) {
      // DYNAMIC MODE: Firebase (shared)
      const { firebaseId, ...locationData } = updatedLocation;
      
      if (firebaseId) {
        database.ref(`customLocations/${firebaseId}`).set(locationData)
          .then(() => {
            console.log('[FIREBASE] Location updated in shared database');
            showToast('×”××§×•× ×¢×•×“×›×Ÿ!', 'success');
            // Update editingLocation with latest data
            if (!closeAfter) {
              setEditingLocation({ ...updatedLocation, firebaseId });
            }
          })
          .catch((error) => {
            console.error('[FIREBASE] Error updating location:', error);
            showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ', 'error');
          });
      }
    } else {
      // STATIC MODE: localStorage (local)
      const updated = customLocations.map(loc => 
        loc.id === editingLocation.id ? updatedLocation : loc
      );
      setCustomLocations(updated);
      localStorage.setItem('bangkok_custom_locations', JSON.stringify(updated));
      showToast('×”××§×•× ×¢×•×“×›×Ÿ!', 'success');
      // Update editingLocation with latest data
      if (!closeAfter) {
        setEditingLocation(updatedLocation);
      }
    }
    
    if (closeAfter) {
      setShowEditLocationDialog(false);
      setEditingLocation(null);
      setNewLocation({ 
        name: '', 
        description: '', 
        notes: '',
        area: formData.area, 
        interests: [], 
        lat: null, 
        lng: null, 
        mapsUrl: '',
        address: '',
        uploadedImage: null,
        imageUrls: []
      });
    }
  };

  // Get current location from GPS
  const getCurrentLocation = () => {
    if (!navigator.geolocation) {
      showToast('×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘××™×§×•× GPS', 'error');
      return;
    }
    
    showToast('××—×¤×© ××™×§×•×...', 'info');
    
    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        // First update with coordinates
        setNewLocation(prev => ({
          ...prev,
          lat: lat,
          lng: lng,
          mapsUrl: `https://maps.google.com/?q=${lat},${lng}`
        }));
        
        showToast(`××™×§×•× × ×§×œ×˜: ${lat.toFixed(5)}, ${lng.toFixed(5)}`, 'success');
        
        // Then try to get address (reverse geocode)
        try {
          const address = await reverseGeocode(lat, lng);
          if (address) {
            setNewLocation(prev => ({
              ...prev,
              address: address
            }));
          }
        } catch (err) {
          console.log('[GPS] Reverse geocode failed (ok):', err);
        }
      },
      (error) => {
        let errorMessage = '×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ ××ª ×”××™×§×•×.';
        
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = '× ×“×¨×©×ª ×”×¨×©××” ×œ××™×§×•×. ×× × ××¤×©×¨ ×’×™×©×” ×‘××™×§×•× ×‘×”×’×“×¨×•×ª ×”×“×¤×“×¤×Ÿ.';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = '×”××™×§×•× ×œ× ×–××™×Ÿ ×›×¨×’×¢. × ×¡×” ×©×•×‘.';
            break;
          case error.TIMEOUT:
            errorMessage = '×ª× ×”×–××Ÿ ×œ×§×‘×œ×ª ×”××™×§×•×. × ×¡×” ×©×•×‘.';
            break;
        }
        
        showToast(`${errorMessage}`, 'error');
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  };

  // Parse Google Maps URL to extract coordinates
  const parseMapsUrl = (url) => {
    if (!url || !url.trim()) {
      setNewLocation({ ...newLocation, lat: null, lng: null, mapsUrl: '' });
      return;
    }

    // Try different Google Maps URL formats
    let lat = null, lng = null;
    
    // Format 1: https://maps.google.com/?q=13.7465,100.4927
    let match = url.match(/[?&]q=([-\d.]+),([-\d.]+)/);
    if (match) {
      lat = parseFloat(match[1]);
      lng = parseFloat(match[2]);
    }
    
    // Format 2: https://www.google.com/maps/@13.7465,100.4927,17z
    if (!match) {
      match = url.match(/@([-\d.]+),([-\d.]+)/);
      if (match) {
        lat = parseFloat(match[1]);
        lng = parseFloat(match[2]);
      }
    }
    
    // Format 3: https://maps.google.com/maps?q=...&ll=13.7465,100.4927
    if (!match) {
      match = url.match(/[?&]ll=([-\d.]+),([-\d.]+)/);
      if (match) {
        lat = parseFloat(match[1]);
        lng = parseFloat(match[2]);
      }
    }
    
    // Format 4: https://goo.gl/maps/... or https://maps.app.goo.gl/...
    // These shortened URLs need to be opened first, so just inform user
    if (!match && (url.includes('goo.gl') || url.includes('maps.app'))) {
      showToast('×§×™×©×•×¨×™× ××§×•×¦×¨×™×: ×¤×ª×— ×‘×“×¤×“×¤×Ÿ ×•×”×¢×ª×§ ××ª ×”×§×™×©×•×¨ ×”××œ×', 'warning');
      setNewLocation({ ...newLocation, mapsUrl: url });
      return;
    }
    
    // Format 5: Just coordinates: 13.7465,100.4927 or 13.7465, 100.4927
    if (!match) {
      match = url.match(/^([-\d.]+)\s*,\s*([-\d.]+)$/);
      if (match) {
        lat = parseFloat(match[1]);
        lng = parseFloat(match[2]);
      }
    }
    
    if (lat !== null && lng !== null) {
      setNewLocation({ ...newLocation, lat, lng, mapsUrl: url });
      showToast(`×§×•××•×¨×“×™× ×˜×•×ª × ×§×œ×˜×•: ${lat.toFixed(5)}, ${lng.toFixed(5)}`, 'success');
    } else {
      showToast('×œ× ×–×™×”×™×ª×™ ×§×•××•×¨×“×™× ×˜×•×ª. × ×¡×” ×§×™×©×•×¨ Google Maps ××•: 13.7465,100.4927', 'error');
      setNewLocation({ ...newLocation, mapsUrl: url });
    }
  };

  // Search address using Google Places API (instead of Geocoding)
  const geocodeAddress = async (address) => {
    if (!address || !address.trim()) {
      showToast('×× × ×”×–×Ÿ ×›×ª×•×‘×ª', 'warning');
      return;
    }

    try {
      showToast('××—×¤×© ×›×ª×•×‘×ª...', 'info');
      
      // Add "Bangkok, Thailand" if not already included
      const searchQuery = address.toLowerCase().includes('bangkok') 
        ? address 
        : `${address}, Bangkok, Thailand`;
      
      // Use Google Places API Text Search
      const response = await fetch(
        `https://places.googleapis.com/v1/places:searchText`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Goog-Api-Key': GOOGLE_PLACES_API_KEY,
            'X-Goog-FieldMask': 'places.displayName,places.location,places.formattedAddress'
          },
          body: JSON.stringify({
            textQuery: searchQuery,
            maxResultCount: 1
          })
        }
      );
      
      const data = await response.json();
      
      if (data.places && data.places.length > 0) {
        const place = data.places[0];
        const location = place.location;
        const formattedAddress = place.formattedAddress || place.displayName?.text || searchQuery;
        
        setNewLocation({
          ...newLocation,
          lat: location.latitude,
          lng: location.longitude,
          address: formattedAddress,
          mapsUrl: `https://maps.google.com/?q=${location.latitude},${location.longitude}`
        });
        
        showToast(`× ××¦×! ${formattedAddress}`, 'success');
      } else {
        showToast('×œ× × ××¦××” ×›×ª×•×‘×ª. × ×¡×” ×›×ª×•×‘×ª ××—×¨×ª', 'error');
      }
    } catch (error) {
      console.error('[GEOCODING] Error:', error);
      showToast('×©×’×™××” ×‘×—×™×¤×•×© ×”×›×ª×•×‘×ª. × ×¡×” ×‘×××¦×¢×•×ª ×§×™×©×•×¨ Google Maps', 'error');
    }
  };

  // Search coordinates by place name
  const geocodeByName = async (name) => {
    if (!name || !name.trim()) {
      showToast('×× × ×”×–×Ÿ ×©× ××§×•×', 'warning');
      return;
    }

    try {
      showToast('××—×¤×© ×œ×¤×™ ×©×...', 'info');
      
      // Add "Bangkok, Thailand" for better results
      const searchQuery = name.toLowerCase().includes('bangkok') 
        ? name 
        : `${name}, Bangkok, Thailand`;
      
      const response = await fetch(
        `https://places.googleapis.com/v1/places:searchText`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Goog-Api-Key': GOOGLE_PLACES_API_KEY,
            'X-Goog-FieldMask': 'places.displayName,places.location,places.formattedAddress'
          },
          body: JSON.stringify({
            textQuery: searchQuery,
            maxResultCount: 1
          })
        }
      );
      
      const data = await response.json();
      
      if (data.places && data.places.length > 0) {
        const place = data.places[0];
        const location = place.location;
        const formattedAddress = place.formattedAddress || '';
        
        setNewLocation({
          ...newLocation,
          lat: location.latitude,
          lng: location.longitude,
          address: formattedAddress,
          mapsUrl: `https://maps.google.com/?q=${location.latitude},${location.longitude}`
        });
        
        showToast(`× ××¦×: ${place.displayName?.text || name}`, 'success');
      } else {
        showToast('×œ× × ××¦× ××§×•×. × ×¡×” ×©× ××—×¨ ××• ×›×ª×•×‘×ª', 'error');
      }
    } catch (error) {
      console.error('[GEOCODE BY NAME] Error:', error);
      showToast('×©×’×™××” ×‘×—×™×¤×•×©', 'error');
    }
  };

  // Reverse geocode: get address from coordinates
  const reverseGeocode = async (lat, lng) => {
    try {
      const response = await fetch(
        `https://places.googleapis.com/v1/places:searchText`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Goog-Api-Key': GOOGLE_PLACES_API_KEY,
            'X-Goog-FieldMask': 'places.formattedAddress'
          },
          body: JSON.stringify({
            textQuery: `${lat},${lng}`,
            maxResultCount: 1
          })
        }
      );
      
      const data = await response.json();
      
      if (data.places && data.places.length > 0) {
        return data.places[0].formattedAddress || '';
      }
      return '';
    } catch (error) {
      console.error('[REVERSE GEOCODE] Error:', error);
      return '';
    }
  };

  const toggleStopActive = (stopIndex) => {
    const stopId = route.stops[stopIndex].id || stopIndex;
    const newDisabledStops = disabledStops.includes(stopId)
      ? disabledStops.filter(id => id !== stopId)
      : [...disabledStops, stopId];
    
    setDisabledStops(newDisabledStops);
    
    // Regenerate map URL with only active stops
    const activeStops = route.stops.filter((_, i) => 
      !newDisabledStops.includes(route.stops[i].id || i)
    );
    
    let waypoints = activeStops.map(s => `${s.lat},${s.lng}`);
    
    if (route.preferences.circular && activeStops.length > 1) {
      waypoints.push(waypoints[0]);
    }
    
    const origin = waypoints[0];
    const destination = waypoints[waypoints.length - 1];
    const middlePoints = waypoints.slice(1, -1).join('|');
    
    let mapUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
    if (middlePoints) {
      mapUrl += `&waypoints=${middlePoints}`;
    }
    mapUrl += '&travelmode=walking';
    
    setRoute({...route, mapUrl});
  };




  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-pink-50" dir="rtl">
      {/* Loading Overlay */}
      {!isDataLoaded && (
        <div className="fixed inset-0 bg-gradient-to-br from-orange-50 to-pink-50 z-[100] flex flex-col items-center justify-center">
          <div className="text-center">
            <div className="text-5xl mb-4 animate-bounce">ğŸ‡¹ğŸ‡­</div>
            <h2 className="text-xl font-bold text-gray-700 mb-2">Bangkok Explorer</h2>
            <div className="flex items-center justify-center gap-2 text-gray-500">
              <svg className="animate-spin h-5 w-5 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
              <span className="text-sm">...×˜×•×¢×Ÿ × ×ª×•× ×™×</span>
            </div>
          </div>
        </div>
      )}

      <div className="bg-gradient-to-r from-orange-500 to-pink-500 text-white p-4 shadow-lg">
        <div className="flex justify-between items-center">
          <h1 className="text-2xl font-bold">Bangkok Explorer ğŸ‡¹ğŸ‡­</h1>
          <div className="text-left">
            <span className="text-xs opacity-70 block">v{window.BKK.VERSION}</span>
            <span className="text-[8px] opacity-50">Â© 2026 Eitan Fisher</span>
          </div>
        </div>
      </div>

      <div className="max-w-4xl mx-auto p-4 pb-32">
        {/* Navigation Tabs */}
        <div className="flex flex-wrap gap-1 mb-4 bg-white rounded-lg p-1.5 shadow">
          <button
            onClick={() => setCurrentView('form')}
            className={`flex-1 min-w-0 py-2 px-1 rounded-lg font-medium transition text-[10px] sm:text-xs leading-tight ${
              currentView === 'form' || currentView === 'route' ? 'bg-orange-500 text-white' : 'text-gray-600 hover:bg-gray-100'
            }`}
          >
            <div className="truncate text-center">ğŸ—ºï¸ ××¡×œ×•×œ</div>
          </button>
          <button
            onClick={() => setCurrentView('saved')}
            className={`flex-1 min-w-0 py-2 px-1 rounded-lg font-medium transition text-[10px] sm:text-xs leading-tight ${
              currentView === 'saved' ? 'bg-orange-500 text-white' : 'text-gray-600 hover:bg-gray-100'
            }`}
          >
            <div className="truncate text-center">ğŸ’¾ {savedRoutes.length > 0 ? `(${savedRoutes.length})` : ''}</div>
          </button>
          <button
            onClick={() => setCurrentView('myPlaces')}
            className={`flex-1 min-w-0 py-2 px-1 rounded-lg font-medium transition text-[10px] sm:text-xs leading-tight ${
              currentView === 'myPlaces' || currentView === 'search' ? 'bg-orange-500 text-white' : 'text-gray-600 hover:bg-gray-100'
            }`}
          >
            <div className="truncate text-center">ğŸ“ {customLocations.length > 0 ? `(${customLocations.length})` : ''}</div>
          </button>
          <button
            onClick={() => setCurrentView('myInterests')}
            className={`flex-1 min-w-0 py-2 px-1 rounded-lg font-medium transition text-[10px] sm:text-xs leading-tight ${
              currentView === 'myInterests' ? 'bg-purple-500 text-white' : 'text-gray-600 hover:bg-gray-100'
            }`}
          >
            <div className="truncate text-center">ğŸ·ï¸ {Object.values(interestStatus).filter(Boolean).length > 0 ? `(${Object.values(interestStatus).filter(Boolean).length})` : ''}</div>
          </button>
          <button
            onClick={() => {
              if (isUnlocked || !adminPassword) {
                setCurrentView('settings');
              } else {
                setShowPasswordDialog(true);
              }
            }}
            className={`flex-1 min-w-0 py-2 px-1 rounded-lg font-medium transition text-[10px] sm:text-xs leading-tight ${
              currentView === 'settings' ? 'bg-orange-500 text-white' : 'text-gray-600 hover:bg-gray-100'
            }`}
          >
            <div className="truncate text-center">{(isUnlocked || !adminPassword) ? 'ğŸ”“' : 'ğŸ”’'}</div>
          </button>
        </div>

        {/* Form View */}

        {/* === VIEWS (from views.js) === */}
        {currentView === 'form' && (
          <div className="bg-white rounded-xl shadow-lg p-3 space-y-3">
            <div className="flex items-center justify-center gap-2">
              <h2 className="text-base font-bold text-center">×ª×›× ×Ÿ ××ª ×”×˜×™×•×œ</h2>
              <button
                onClick={() => showHelpFor('main')}
                className="text-gray-400 hover:text-blue-500 text-sm"
                title="×¢×–×¨×”"
              >
                â“
              </button>
            </div>

            {/* Split Layout: Areas (right) | Interests (left) */}
            <div className="grid grid-cols-[95px_1fr] gap-3 items-start" style={{ paddingBottom: '60px' }}>
              
              {/* Right Column: Areas */}
              <div className="flex flex-col">
                <div className="flex items-center justify-center gap-1 mb-1.5">
                  <label className="font-medium text-xs block text-center">ğŸ—ºï¸ ××™×–×•×¨</label>
                  <button
                    onClick={detectArea}
                    disabled={isLocating}
                    className={`px-1 py-0.5 rounded text-[10px] ${isLocating ? 'bg-gray-200 text-gray-400' : 'bg-blue-100 text-blue-600 hover:bg-blue-200'}`}
                    title="×–×”×” ××™×–×•×¨ ×œ×¤×™ ××™×§×•× × ×•×›×—×™"
                  >
                    {isLocating ? 'â³' : 'ğŸ“'}
                  </button>
                </div>
                <div className="border border-gray-200 rounded-lg p-1.5">
                  <div className="space-y-1.5">
                    {areaOptions.map(area => (
                      <button
                        key={area.id}
                        onClick={() => setFormData({...formData, area: area.id})}
                        style={{
                          border: formData.area === area.id ? '3px solid #3b82f6' : '2px solid #d1d5db',
                          backgroundColor: formData.area === area.id ? '#dbeafe' : '#ffffff',
                          boxShadow: formData.area === area.id ? '0 4px 6px -1px rgba(59, 130, 246, 0.3)' : 'none'
                        }}
                        className="w-full p-1.5 rounded-lg text-xs"
                      >
                        <div className="text-base mb-0.5">{area.icon}</div>
                        <div style={{
                          fontWeight: 'bold',
                          fontSize: '10px',
                          color: formData.area === area.id ? '#1e40af' : '#374151'
                        }}>{area.label}</div>
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {/* Left Column: Interests */}
              <div className="flex flex-col">
                <label className="font-medium text-xs mb-1.5 block">â­ ××” ××¢× ×™×™×Ÿ?</label>
                <div className="grid grid-cols-3 gap-2 border border-gray-200 rounded-lg p-2">
                {allInterestOptions.filter(option => {
                  if (!option || !option.id) return false;
                  // Must be valid (have search config)
                  if (!isInterestValid(option.id)) return false;
                  // Custom interests always shown (if valid)
                  const isCustom = customInterests.some(ci => ci.id === option.id);
                  if (isCustom) return true;
                  // Built-in/uncovered shown only if active
                  return interestStatus[option.id] !== false;
                }).map(option => {
                  const tooltip = interestTooltips[option.id] || option.label;
                  const customInterest = customInterests.find(ci => ci.id === option.id);
                  const isCustom = !!customInterest;
                  
                  return (
                    <button
                      key={option.id}
                      onClick={() => toggleInterest(option.id)}
                      title={tooltip}
                      style={{
                        border: formData.interests.includes(option.id) ? '3px solid #f97316' : '2px solid #d1d5db',
                        backgroundColor: formData.interests.includes(option.id) ? '#fed7aa' : '#ffffff',
                        boxShadow: formData.interests.includes(option.id) ? '0 4px 6px -1px rgba(0, 0, 0, 0.2)' : 'none',
                        position: 'relative'
                      }}
                      className="p-1.5 rounded-lg text-xs"
                    >
                      <div className="text-lg mb-1">{option.icon}</div>
                      <div style={{
                        fontWeight: '600',
                        fontSize: '11px',
                        color: formData.interests.includes(option.id) ? '#c2410c' : '#374151'
                      }}>{option.label}</div>
                    </button>
                  );
                })}
              </div>
              {formData.interests.length > 0 && (
                <div style={{
                  marginTop: '8px',
                  fontSize: '14px',
                  fontWeight: 'bold',
                  color: '#059669',
                  backgroundColor: '#d1fae5',
                  padding: '8px',
                  borderRadius: '8px'
                }}>
                  âœ“ {formData.interests.length} × ×‘×—×¨×•
                </div>
              )}
              </div>
              {/* End of Left Column */}
              
            </div>
            {/* End of Split Layout */}

            {/* Generate Button - sticky at bottom for mobile */}
            <div style={{
              position: 'sticky',
              bottom: '20px',
              zIndex: 100,
              marginTop: '20px'
            }}>
              <button
                onClick={generateRoute}
                disabled={formData.interests.length === 0}
                style={{
                  width: '100%',
                  backgroundColor: '#2563eb',
                  color: 'white',
                  padding: '10px',
                  borderRadius: '12px',
                  fontWeight: 'bold',
                  fontSize: '14px',
                  border: 'none',
                  boxShadow: '0 4px 6px rgba(0, 0, 0, 0.2)',
                  opacity: formData.interests.length === 0 ? 0.5 : 1
                }}
              >
                {isGenerating ? '××—×¤×©...' : `ğŸ” ××¦× × ×§×•×“×•×ª ×¢× ×™×™×Ÿ (${formData.maxStops} ××§×•××•×ª)`}
              </button>
              <button
                onClick={() => showHelpFor('searchLogic')}
                className="bg-white text-blue-600 hover:bg-blue-50 rounded-full w-7 h-7 flex items-center justify-center text-sm font-bold shadow border border-blue-200"
                title="××™×š ×”××¢×¨×›×ª ××•×¦××ª ××§×•××•×ª?"
              >
                ?
              </button>
            </div>
            
            {formData.interests.length === 0 && (
              <p className="text-center text-gray-500 text-xs">×‘×—×¨ ×œ×¤×—×•×ª ×ª×—×•× ×¢× ×™×™×Ÿ ××—×“</p>
            )}

            {/* Show stops list ONLY after route is calculated */}
            {route && (
              <div id="route-results" className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 mt-4" dir="rtl">
                <div className="flex items-center gap-2 mb-2">
                  <h3 className="font-bold text-blue-900 text-sm">××§×•××•×ª ×‘{route.areaName} ({route.stops.length}):</h3>
                  <button
                    onClick={() => showHelpFor('placesListing')}
                    className="text-blue-400 hover:text-blue-600 text-sm"
                    title="×¢×–×¨×”"
                  >
                    â“
                  </button>
                </div>
                <div className="space-y-3 max-h-96 overflow-y-auto">
                  {(() => {
                    // Group stops by interest
                    const groupedStops = {};
                    let stopCounter = 0;
                    
                    route.stops.forEach((stop, i) => {
                      const interests = stop.interests || [];
                      interests.forEach(interest => {
                        if (!groupedStops[interest]) {
                          groupedStops[interest] = [];
                        }
                        groupedStops[interest].push({ ...stop, originalIndex: i, displayNumber: stopCounter + 1 });
                      });
                      stopCounter++;
                    });
                    
                    return Object.entries(groupedStops).map(([interest, stops]) => {
                      const interestObj = allInterestOptions.find(opt => opt.id === interest);
                      if (!interestObj) return null;
                      
                      return (
                        <div key={interest} className="bg-white rounded-lg p-2 border border-gray-200">
                          {/* Interest header with fetch-more button */}
                          <div className="flex items-center justify-between mb-1.5">
                            <div className="font-bold text-xs text-gray-700 flex items-center gap-1">
                              <span style={{ fontSize: '14px' }}>{interestObj.icon}</span>
                              <span>{interestObj.label} ({stops.length})</span>
                            </div>
                            <button
                              onClick={async () => {
                                // Fetch more for this specific interest
                                await fetchMoreForInterest(interest);
                              }}
                              className="text-[10px] px-2 py-0.5 rounded bg-blue-500 text-white hover:bg-blue-600"
                              title={`×”×•×¡×£ ×¢×•×“ ${interestObj.label}`}
                            >
                              + ×¢×•×“
                            </button>
                          </div>
                          
                          {/* Stops in this interest */}
                          <div className="space-y-1.5">
                            {stops.map((stop) => {
                              const hasValidCoords = stop.lat && stop.lng && stop.lat !== 0 && stop.lng !== 0;
                              const stopId = stop.id || stop.originalIndex;
                              const isDisabled = disabledStops.includes(stopId);
                              const isCustom = stop.custom;
                              const isAddedLater = stop.addedLater;
                              
                              return (
                                <div key={stop.originalIndex} className="p-1.5 rounded border relative" style={{ 
                                  borderColor: !hasValidCoords ? '#ef4444' : isAddedLater ? '#60a5fa' : isDisabled ? '#9ca3af' : '#e5e7eb',
                                  borderWidth: isAddedLater ? '2px' : '1px',
                                  borderStyle: isAddedLater ? 'dashed' : 'solid',
                                  backgroundColor: !hasValidCoords ? '#fef2f2' : isAddedLater ? '#eff6ff' : isDisabled ? '#f3f4f6' : '#fafafa',
                                  opacity: isDisabled ? 0.6 : 1
                                }}>
                                  {/* Action buttons */}
                                  <div className="absolute top-0.5 left-0.5 flex gap-0.5">
                                    {/* Temporary skip button - toggles between active/paused */}
                                    <button
                                      onClick={() => toggleStopActive(stop.originalIndex)}
                                      className={`text-[9px] px-1 py-0.5 rounded ${isDisabled ? 'bg-yellow-500 text-white' : 'bg-gray-400 text-white'}`}
                                      title={isDisabled ? '×”×—×–×¨ ×œ××¡×œ×•×œ' : '×“×œ×’ ×–×× ×™×ª'}
                                    >
                                      {isDisabled ? 'â¸ï¸' : 'âœ•'}
                                    </button>
                                    
                                    {(() => {
                                      // Check if this place is in blacklist
                                      const blacklisted = customLocations.find(loc => 
                                        loc.name.toLowerCase() === stop.name.toLowerCase() && 
                                        loc.status === 'blacklist'
                                      );
                                      
                                      if (blacklisted) {
                                        // Show GREEN undo button - removes from blacklist
                                        return (
                                          <button
                                            onClick={() => {
                                              deleteCustomLocation(blacklisted.id);
                                              showToast(`"${stop.name}" ×—×–×¨ ×œ×¨×©×™××” ×”×¨×’×™×œ×”`, 'success');
                                            }}
                                            className="text-[9px] px-1 py-0.5 rounded bg-green-500 text-white hover:bg-green-600"
                                            title="×‘×˜×œ ×“×™×œ×•×’ ×§×‘×•×¢"
                                          >
                                            âœ…
                                          </button>
                                        );
                                      }
                                      
                                      // Show permanent skip button (for non-custom places, regardless of isDisabled)
                                      if (!isCustom) {
                                        return (
                                          <button
                                            onClick={() => skipPlacePermanently(stop)}
                                            className="text-[9px] px-1 py-0.5 rounded bg-red-500 text-white hover:bg-red-600"
                                            title="×“×œ×’ ×œ×¦××™×ª×•×ª"
                                          >
                                            ğŸš«
                                          </button>
                                        );
                                      }
                                      
                                      return null;
                                    })()}
                                    
                                    {!isCustom && (
                                      (() => {
                                        const placeId = stop.id || stop.name;
                                        const isAdding = addingPlaceIds.includes(placeId);
                                        const existingLoc = customLocations.find(loc => 
                                          loc.name.toLowerCase().trim() === stop.name.toLowerCase().trim()
                                        );
                                        
                                        if (existingLoc) {
                                          // Place was added - show edit button
                                          return (
                                            <button
                                              onClick={() => handleEditLocation(existingLoc)}
                                              className="text-[9px] px-1 py-0.5 rounded bg-blue-500 text-white hover:bg-blue-600"
                                              title="×¢×¨×•×š (× ×•×¡×£ ×œ×¨×©×™××”)"
                                            >
                                              âœï¸
                                            </button>
                                          );
                                        }
                                        
                                        return (
                                          <button
                                            onClick={() => addGooglePlaceToCustom(stop)}
                                            disabled={isAdding}
                                            className={`text-[9px] px-1 py-0.5 rounded ${
                                              isAdding 
                                                ? 'bg-gray-300 text-gray-500 cursor-wait' 
                                                : 'bg-purple-500 text-white hover:bg-purple-600'
                                            }`}
                                            title="×”×•×¡×£ ×œ×¨×©×™××” ×©×œ×™"
                                          >
                                            {isAdding ? '...' : '+'}
                                          </button>
                                        );
                                      })()
                                    )}
                                    
                                    {isCustom && (
                                      <button
                                        onClick={() => {
                                          const customLoc = customLocations.find(loc => loc.name === stop.name);
                                          if (customLoc) {
                                            handleEditLocation(customLoc);
                                          }
                                        }}
                                        className="text-[9px] px-1 py-0.5 rounded bg-blue-500 text-white hover:bg-blue-600"
                                        title="×¢×¨×•×š"
                                      >
                                        âœï¸
                                      </button>
                                    )}
                                  </div>
                                  
                                  <a
                                    href={hasValidCoords ? `https://www.google.com/maps/search/?api=1&query=${stop.address?.trim() ? encodeURIComponent(stop.address.trim()) : `${stop.lat},${stop.lng}`}` : '#'}
                                    target={hasValidCoords ? "_blank" : undefined}
                                    rel={hasValidCoords ? "noopener noreferrer" : undefined}
                                    className="block hover:bg-gray-100 transition pr-2"
                                    onClick={(e) => {
                                      if (!hasValidCoords) {
                                        e.preventDefault();
                                        showToast('×œ××§×•× ×–×” ××™×Ÿ ×§×•××•×¨×“×™× ×˜×•×ª. ×œ×—×¥ ×¢×œ âœï¸ ×›×“×™ ×œ×¢×¨×•×š.', 'warning');
                                      }
                                    }}
                                  >
                                    <div className="font-bold text-[11px] flex items-center gap-1" style={{
                                      color: hasValidCoords ? '#2563eb' : '#dc2626'
                                    }}>
                                      {!hasValidCoords && (
                                        <span title="××™×Ÿ ×§×•××•×¨×“×™× ×˜×•×ª - ×œ× ×™×›×œ×œ ×‘××¡×œ×•×œ" style={{ fontSize: '11px' }}>
                                          â—
                                        </span>
                                      )}
                                      <span>{stop.name}</span>
                                      {stop.outsideArea && (
                                        <span className="text-orange-500" title="××§×•× ××—×•×¥ ×œ×’×‘×•×œ×•×ª ×”××–×•×¨" style={{ fontSize: '10px' }}>
                                          ğŸ”º
                                        </span>
                                      )}
                                      {isCustom && (
                                        <span title="××§×•× ×©×œ×™" style={{ fontSize: '11px' }}>ğŸ–ï¸</span>
                                      )}
                                      {isAddedLater && (
                                        <span className="text-blue-500 font-bold" title="× ×•×¡×£ ×‘+×¢×•×“" style={{ fontSize: '9px' }}>+×¢×•×“</span>
                                      )}
                                      {/* Camera icon for custom locations with image */}
                                      {isCustom && stop.uploadedImage && (
                                        <button
                                          onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            setModalImage(stop.uploadedImage);
                                            setShowImageModal(true);
                                          }}
                                          className="hover:scale-110 transition"
                                          title="×”×¦×’ ×ª××•× ×”"
                                          style={{ fontSize: '11px' }}
                                        >
                                          ğŸ“·
                                        </button>
                                      )}
                                      {/* Interest icons */}
                                      {stop.interests?.map((int, idx) => {
                                        const intObj = allInterestOptions.find(opt => opt.id === int);
                                        return intObj?.icon ? (
                                          <span 
                                            key={idx}
                                            title={intObj.label}
                                            style={{ fontSize: '11px' }}
                                          >
                                            {intObj.icon}
                                          </span>
                                        ) : null;
                                      })}
                                    </div>
                                    <div className="text-[10px]" style={{
                                      color: hasValidCoords ? '#6b7280' : '#991b1b'
                                    }}>
                                      {hasValidCoords ? stop.description : 'âš ï¸ ×—×¡×¨×•×ª ×§×•××•×¨×“×™× ×˜×•×ª'}
                                    </div>
                                    {stop.todayHours && (
                                      <div className="text-[9px]" style={{ color: stop.openNow ? '#059669' : '#dc2626' }}>
                                        ğŸ• {stop.openNow ? '×¤×ª×•×—' : '×¡×’×•×¨'} Â· {stop.todayHours}
                                      </div>
                                    )}
                                  </a>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    });
                  })()}
                </div>
                
                <div className="mt-3 space-y-2">
                  <a
                    href={(() => {
                      // Filter active stops with valid coordinates
                      const activeStops = route.stops.filter((s, i) => {
                        const isActive = !disabledStops.includes(s.id || i);
                        const hasValidCoords = s.lat && s.lng && s.lat !== 0 && s.lng !== 0;
                        return isActive && hasValidCoords;
                      });
                      
                      if (activeStops.length === 0) {
                        return '#';
                      }
                      
                      // Calculate center
                      const avgLat = activeStops.reduce((sum, s) => sum + s.lat, 0) / activeStops.length;
                      const avgLng = activeStops.reduce((sum, s) => sum + s.lng, 0) / activeStops.length;
                      
                      // Create search query with all active place names
                      const query = activeStops.map(s => s.name).join(' OR ');
                      
                      // Return search URL with active places
                      return `https://www.google.com/maps/search/${encodeURIComponent(query)}/@${avgLat},${avgLng},13z`;
                    })()}
                    target="_blank"
                    rel="noopener noreferrer"
                    onClick={(e) => {
                      const activeStops = route.stops.filter((s, i) => {
                        const isActive = !disabledStops.includes(s.id || i);
                        const hasValidCoords = s.lat && s.lng && s.lat !== 0 && s.lng !== 0;
                        return isActive && hasValidCoords;
                      });
                      if (activeStops.length === 0) {
                        e.preventDefault();
                        showToast('××™×Ÿ ××§×•××•×ª ×¢× ×§×•××•×¨×“×™× ×˜×•×ª ×ª×§×™× ×•×ª', 'warning');
                      }
                    }}
                    style={{
                      display: 'block',
                      width: '100%',
                      backgroundColor: '#f59e0b',
                      color: 'white',
                      textAlign: 'center',
                      padding: '10px',
                      borderRadius: '12px',
                      fontWeight: 'bold',
                      textDecoration: 'none',
                      fontSize: '14px',
                      boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.3)',
                      marginBottom: '4px'
                    }}
                  >
                    ğŸ—ºï¸ ×”×¦×’ ××ª ×›×œ ×”××§×•××•×ª ×¢×œ ×”××¤×”
                  </a>
                  
                  
                  {/* URL limit note */}
                  <p style={{
                    fontSize: '10px',
                    color: '#6b7280',
                    textAlign: 'center',
                    marginBottom: '8px',
                    fontStyle: 'italic'
                  }}>
                    ××’×‘×œ×ª ×˜×œ×¤×•×Ÿ: ×¢×“ ~6 ××§×•××•×ª (250 ×ª×•×•×™×)
                  </p>
                  
                  {/* Route Type + Button */}
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {/* Route Type Radio Buttons - Small and Simple */}
                    <div style={{
                      display: 'flex',
                      gap: '16px',
                      fontSize: '13px',
                      paddingRight: '4px'
                    }}>
                      <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                        <input
                          type="radio"
                          name="routeType"
                          checked={routeType === 'circular'}
                          onChange={() => setRouteType('circular')}
                          style={{ cursor: 'pointer' }}
                        />
                        <span>××¢×’×œ×™</span>
                      </label>
                      <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                        <input
                          type="radio"
                          name="routeType"
                          checked={routeType === 'linear'}
                          onChange={() => setRouteType('linear')}
                          style={{ cursor: 'pointer' }}
                        />
                        <span>×œ×™× ××¨×™</span>
                      </label>
                    </div>
                    
                    {/* Start Point Input with GPS + validate buttons */}
                    <div>
                      <label className="text-xs text-gray-600 mb-1 block">ğŸ“ × ×§×•×“×ª ×”×ª×—×œ×” (××•×¤×¦×™×•× ×œ×™)</label>
                      <div className="flex gap-1">
                        <input
                          type="text"
                          value={formData.startPoint}
                          onChange={(e) => {
                            setFormData({...formData, startPoint: e.target.value});
                            setStartPointCoords(null);
                          }}
                          placeholder="×œ×“×•×’××”: BTS Asok, ×©× ××œ×•×Ÿ..."
                          className="flex-1 p-1.5 border border-gray-300 rounded-lg text-xs"
                          style={{ direction: 'rtl' }}
                        />
                        <button
                          onClick={validateStartPoint}
                          disabled={isLocating || !formData.startPoint?.trim()}
                          className={`px-1.5 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap ${
                            isLocating || !formData.startPoint?.trim() ? 'bg-gray-300 text-gray-500' : 'bg-green-500 text-white hover:bg-green-600'
                          }`}
                          title="×××ª ×›×ª×•×‘×ª"
                        >
                          ğŸ”
                        </button>
                        <button
                          onClick={getMyLocation}
                          disabled={isLocating}
                          className={`px-1.5 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap ${isLocating ? 'bg-gray-300 text-gray-500' : 'bg-blue-500 text-white hover:bg-blue-600'}`}
                          title="××™×§×•× × ×•×›×—×™"
                        >
                          {isLocating ? 'â³' : 'ğŸ“'}
                        </button>
                        {(formData.startPoint?.trim() || startPointCoords) && (
                          <button
                            onClick={() => {
                              setFormData({...formData, startPoint: ''});
                              setStartPointCoords(null);
                            }}
                            className="px-1.5 py-1.5 rounded-lg text-xs font-bold bg-gray-200 text-gray-600 hover:bg-red-100 hover:text-red-600"
                            title="× ×§×” × ×§×•×“×ª ×”×ª×—×œ×”"
                          >
                            âœ•
                          </button>
                        )}
                      </div>
                      {startPointCoords ? (
                        <p style={{ fontSize: '10px', color: '#16a34a', marginTop: '3px', fontWeight: 'bold' }}>
                          âœ… × ×§×•×“×ª ×”×ª×—×œ×” × ×§×œ×˜×” ({startPointCoords.lat.toFixed(4)}, {startPointCoords.lng.toFixed(4)})
                        </p>
                      ) : formData.startPoint?.trim() ? (
                        <p style={{ fontSize: '10px', color: '#d97706', marginTop: '3px' }}>
                          âš ï¸ ×œ×—×¥ ğŸ” ×œ××™××•×ª ×”×›×ª×•×‘×ª ×›×“×™ ×©×ª×©××© ×›× ×§×•×“×ª ×”×ª×—×œ×” ×‘××¤×”
                        </p>
                      ) : (
                        <p style={{ fontSize: '10px', color: '#6b7280', marginTop: '3px', fontStyle: 'italic' }}>
                          ğŸ’¡ ×× ×œ× ×ª×‘×—×¨ - ×”××¡×œ×•×œ ×™×ª×—×™×œ ××”××§×•× ×”×¨××©×•×Ÿ
                        </p>
                      )}
                    </div>
                    
                    {/* Buttons row: Open in Google + Save */}
                    <div style={{ display: 'flex', gap: '8px', marginBottom: '4px' }}>
                      {/* Open in Google Maps Button */}
                      <button
                        onClick={() => {
                          // Build Google Maps URL based on routeType
                          const activeStops = route.stops.filter((stop, i) => {
                            const isActive = !disabledStops.includes(stop.id || i);
                            const hasValidCoords = stop.lat && stop.lng && stop.lat !== 0 && stop.lng !== 0;
                            return isActive && hasValidCoords;
                          });
                          
                          if (activeStops.length === 0) {
                            showToast('××™×Ÿ ××§×•××•×ª ×¢× ×§×•××•×¨×“×™× ×˜×•×ª ×ª×§×™× ×•×ª', 'warning');
                            return;
                          }

                          // Use startPointCoords as origin if available, otherwise first stop
                          const hasStartPoint = startPointCoords && startPointCoords.lat && startPointCoords.lng;
                          const origin = hasStartPoint 
                            ? `${startPointCoords.lat},${startPointCoords.lng}`
                            : `${activeStops[0].lat},${activeStops[0].lng}`;
                          // If using startPoint, all stops are waypoints; otherwise first stop is origin
                          const stopsForRoute = hasStartPoint ? activeStops : activeStops.slice(1);
                          let destination, waypointsStr, mapUrl;

                          if (activeStops.length === 1 && !hasStartPoint) {
                            // Single stop, no start point - just show location
                            mapUrl = `https://www.google.com/maps/search/?api=1&query=${activeStops[0].lat},${activeStops[0].lng}`;
                          } else {
                            // Multiple stops or has start point - create route
                            if (routeType === 'circular') {
                              destination = origin; // Return to start
                              waypointsStr = (hasStartPoint ? activeStops : activeStops.slice(1)).map(s => `${s.lat},${s.lng}`).join('|');
                            } else {
                              destination = `${activeStops[activeStops.length - 1].lat},${activeStops[activeStops.length - 1].lng}`;
                              const middleStops = hasStartPoint ? activeStops.slice(0, -1) : activeStops.slice(1, -1);
                              waypointsStr = middleStops.map(s => `${s.lat},${s.lng}`).join('|');
                            }
                            
                            mapUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
                            if (waypointsStr) mapUrl += `&waypoints=${waypointsStr}`;
                            mapUrl += '&travelmode=walking';
                          }

                          // Open in new tab
                          window.open(mapUrl, '_blank');
                        }}
                        style={{
                          flex: 1,
                          backgroundColor: '#22c55e',
                          color: 'white',
                          textAlign: 'center',
                          padding: '10px',
                          borderRadius: '12px',
                          fontWeight: 'bold',
                          fontSize: '14px',
                          border: 'none',
                          boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.3)',
                          cursor: 'pointer'
                        }}
                      >
                        ğŸ—ºï¸ ×¤×ª×— ××¡×œ×•×œ ×‘×’×•×’×œ
                      </button>
                      
                      {/* Save Route Button - no background */}
                      {route.name ? (
                        <span
                          style={{
                            padding: '10px',
                            fontSize: '18px',
                            display: 'flex',
                            alignItems: 'center'
                          }}
                          title={`× ×©××¨: ${route.name}`}
                        >
                          âœ…
                        </span>
                      ) : (
                        <button
                          onClick={() => quickSaveRoute()}
                          style={{
                            background: 'none',
                            border: 'none',
                            padding: '10px',
                            fontSize: '18px',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center'
                          }}
                          title="×©××•×¨ ××¡×œ×•×œ"
                        >
                          ğŸ’¾
                        </button>
                      )}
                    </div>
                    
                    {/* Waypoints limit note */}
                    <p style={{
                      fontSize: '10px',
                      color: '#6b7280',
                      textAlign: 'center',
                      marginTop: '4px',
                      fontStyle: 'italic'
                    }}>
                      ××’×‘×œ×ª ×˜×œ×¤×•×Ÿ: ×¢×“ 25 ××§×•××•×ª
                    </p>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {currentView === 'route' && route && (
          <div className="bg-white rounded-xl shadow-lg p-4">
            <button
              onClick={() => setCurrentView('form')}
              style={getButtonStyle(false)}
              className="mb-4"
            >
              â† ×—×–×¨×” ×œ×˜×•×¤×¡
            </button>

            {/* Save Route Button */}
            {!route.name && (
              <button
                onClick={() => quickSaveRoute()}
                className="w-full bg-purple-500 text-white py-3 rounded-lg font-bold hover:bg-purple-600 mb-4"
              >
                ğŸ’¾ ×©××•×¨ ××¡×œ×•×œ ×–×”
              </button>
            )}

            {route.name && (
              <div className="bg-green-50 border-2 border-green-500 p-3 rounded-lg mb-4">
                <p className="text-green-800 font-medium">ğŸ“Œ {route.name}</p>
                {route.notes && (
                  <p className="text-xs text-green-700 mt-1">ğŸ“ {route.notes}</p>
                )}
                <p className="text-xs text-green-600">× ×©××¨ ×‘-{new Date(route.savedAt).toLocaleDateString('he-IL')}</p>
              </div>
            )}

            <div className="flex items-center gap-2 mb-2">
              <h2 className="text-2xl font-bold">{route.areaName} - {route.interestsText || '×›×œ×œ×™'}</h2>
              <button
                onClick={() => showHelpFor('route')}
                className="text-gray-400 hover:text-blue-500 text-sm"
                title="×¢×–×¨×”"
              >
                â“
              </button>
            </div>
            <p className="text-sm text-gray-600 mb-2">
              × ×§×•×“×ª ×”×ª×—×œ×”: {route.startPoint}
            </p>
            
            {/* Stats - show breakdown of place sources */}
            {route.stats && (route.stats.custom > 0 || route.stats.fetched > 0) && (
              <div className="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-lg p-3 mb-4">
                <div className="text-xs font-bold text-gray-700 mb-2">ğŸ“Š ××§×•×¨×•×ª ×”××§×•××•×ª:</div>
                <div className="flex gap-2 flex-wrap">
                  {route.stats.custom > 0 && (
                    <span className="bg-purple-500 text-white text-xs px-2 py-1 rounded-full font-bold">
                      â­ {route.stats.custom} ××•×ª×××™× ××™×©×™×ª
                    </span>
                  )}
                  {route.stats.fetched > 0 && (
                    <span className={`text-white text-xs px-2 py-1 rounded-full font-bold ${
                      route.stats.source === 'static' ? 'bg-purple-600' : 'bg-green-600'
                    }`}>
                      {route.stats.source === 'static' ? 'ğŸ“š' : 'ğŸŒ'} {route.stats.fetched} {route.stats.source === 'static' ? '×¡×˜×˜×™' : '×-Google API'}
                    </span>
                  )}
                </div>
              </div>
            )}

            {/* Errors display if any */}
            {route.errors && route.errors.length > 0 && (
              <div className="bg-red-50 border-2 border-red-400 rounded-lg p-3 mb-4">
                <div className="flex items-start gap-2">
                  <span className="text-xl">âŒ</span>
                  <div className="flex-1">
                    <p className="text-sm font-bold text-red-800 mb-1">×©×’×™××•×ª ×‘×§×‘×œ×ª ××§×•××•×ª</p>
                    <div className="text-xs text-red-700 space-y-1">
                      {route.errors.map((err, i) => (
                        <div key={i}>â€¢ {err.interest}: {err.error}</div>
                      ))}
                    </div>
                    <p className="text-xs text-red-600 mt-2">
                      ×¤×¨×˜×™× ××œ××™× ×‘-Console (F12) - ×”×¢×ª×§ ×•×©×œ×— ×œ×ª×™×§×•×Ÿ
                    </p>
                  </div>
                </div>
              </div>
            )}

            {/* Warning if didn't reach requested max stops */}
            {route.incomplete && (
              <div className="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-3 mb-4">
                <div className="flex items-start gap-2">
                  <span className="text-xl">âš ï¸</span>
                  <div className="flex-1">
                    <p className="text-sm font-bold text-yellow-800 mb-1">
                      × ××¦××• {route.incomplete.found} ××§×•××•×ª ×‘××§×•× {route.incomplete.requested} ×”××‘×•×§×©×™×
                    </p>
                    <p className="text-xs text-yellow-700">
                      {formData.interests.length === 1 
                        ? '××™×Ÿ ××¡×¤×™×§ ××§×•××•×ª ×ª×•×××™× ×‘×ª×—×•× ×–×” ×‘××–×•×¨ ×”× ×‘×—×¨'
                        : '×œ× × ××¦××• ××¡×¤×™×§ ××§×•××•×ª ×ª×•×××™× ×‘×—×œ×§ ××ª×—×•××™ ×”×¢× ×™×™×Ÿ ×‘××–×•×¨ ×”× ×‘×—×¨'}
                    </p>
                  </div>
                </div>
              </div>
            )}

            <div className="space-y-3 mb-6">
              <div className="flex justify-between items-center mb-3">
                <h3 className="font-bold">×ª×—× ×•×ª ({route.stops.length}):</h3>
                <button
                  onClick={() => {
                    setNewLocation(prev => ({...prev, area: formData.area}));
                    setShowAddLocationDialog(true);
                  }}
                  className="bg-purple-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-purple-600"
                >
                  â• ×”×•×¡×£ ××§×•×
                </button>
              </div>
              {route.stops.map((stop, i) => {
                const stopId = stop.id || i;
                const isDisabled = disabledStops.includes(stopId);
                const isCustom = stop.custom;
                const hasValidCoords = stop.lat && stop.lng && stop.lat !== 0 && stop.lng !== 0;
                
                // Determine source badge
                let sourceBadge = null;
                if (stop.custom) {
                  sourceBadge = { text: 'ğŸ–ï¸ ×©×œ×™', color: 'bg-purple-500', title: '××§×•× ××•×ª×× ××™×©×™×ª' };
                } else {
                  // Everything else is from Google Places
                  sourceBadge = { text: 'ğŸ” Google', color: 'bg-blue-500', title: '×××§×•××•×ª Google Places' };
                }
                
                return (
                  <div key={i} className={`border-r-4 pr-3 py-2 ${isDisabled ? 'border-gray-300 opacity-50' : hasValidCoords ? 'border-orange-500' : 'border-red-500'}`}
                    style={{ backgroundColor: hasValidCoords ? 'transparent' : '#fef2f2' }}
                  >
                    <div className="flex justify-between items-start gap-2">
                      <div className="flex gap-2 flex-1">
                        <div className={`rounded-full w-6 h-6 flex items-center justify-center font-bold text-sm flex-shrink-0 ${isDisabled ? 'bg-gray-400 text-white' : hasValidCoords ? 'bg-orange-500 text-white' : 'bg-red-500 text-white'}`}>
                          {isDisabled ? 'âœ•' : hasValidCoords ? i + 1 : 'â—'}
                        </div>
                        <div className="flex-1">
                          <div className="flex items-center gap-2 flex-wrap">
                            {!hasValidCoords && (
                              <span 
                                title="××™×Ÿ ×§×•××•×¨×“×™× ×˜×•×ª - ×œ× ×™×›×œ×œ ×‘××¡×œ×•×œ"
                                style={{ fontSize: '14px', color: '#dc2626' }}
                              >
                                â—
                              </span>
                            )}
                            <a
                              href={hasValidCoords ? `https://www.google.com/maps/search/?api=1&query=${stop.address?.trim() ? encodeURIComponent(stop.address.trim()) : `${stop.lat},${stop.lng}`}` : '#'}
                              target={hasValidCoords ? "_blank" : undefined}
                              rel={hasValidCoords ? "noopener noreferrer" : undefined}
                              className={`font-bold text-sm ${isDisabled ? 'line-through text-gray-500' : hasValidCoords ? 'text-blue-600 hover:text-blue-800' : 'text-red-600'}`}
                              onClick={(e) => {
                                if (!hasValidCoords) {
                                  e.preventDefault();
                                  showToast('×œ××§×•× ×–×” ××™×Ÿ ×§×•××•×¨×“×™× ×˜×•×ª. ×¢×¨×•×š ××ª ×”××§×•× ×›×“×™ ×œ×”×•×¡×™×£.', 'warning');
                                }
                              }}
                            >
                              {stop.name}
                            </a>
                            {stop.outsideArea && (
                              <span 
                                className="text-orange-500" 
                                title="××§×•× ××—×•×¥ ×œ×’×‘×•×œ×•×ª ×”××–×•×¨"
                                style={{ fontSize: '14px' }}
                              >
                                ğŸ”º
                              </span>
                            )}
                            {stop.interests && stop.interests.length > 0 && (
                              <>
                                {stop.interests.map((interest, idx) => {
                                  const interestObj = allInterestOptions.find(opt => opt.id === interest);
                                  return interestObj?.icon ? (
                                    <span 
                                      key={idx}
                                      title={interestObj.label}
                                      style={{ fontSize: '16px' }}
                                    >
                                      {interestObj.icon}
                                    </span>
                                  ) : null;
                                })}
                              </>
                            )}
                            {stop.custom ? (
                              <div className="relative group">
                                <button
                                  onClick={() => {
                                    const customLoc = customLocations.find(loc => loc.name === stop.name);
                                    if (customLoc) {
                                      handleEditLocation(customLoc);
                                    }
                                  }}
                                  className={`${sourceBadge.color} text-white text-[10px] px-2 py-0.5 rounded-full font-bold cursor-pointer hover:opacity-80 transition`}
                                  title="×œ×—×¥ ×œ×¤×¨×˜×™× ××œ××™×"
                                >
                                  {sourceBadge.text}
                                </button>
                                
                                {/* Hover Tooltip */}
                                <div className="absolute bottom-full left-0 mb-2 hidden group-hover:block z-50 w-64">
                                  <div className="bg-gray-900 text-white p-3 rounded-lg shadow-2xl text-xs">
                                    {stop.uploadedImage && (
                                      <img 
                                        src={stop.uploadedImage} 
                                        alt={stop.name}
                                        className="w-full h-24 object-cover rounded mb-2"
                                      />
                                    )}
                                    <div className="font-bold mb-1">{stop.name}</div>
                                    {stop.description && (
                                      <div className="text-gray-300 mb-1">{stop.description}</div>
                                    )}
                                    {stop.todayHours && (
                                      <div className="mb-1" style={{ color: stop.openNow ? '#34d399' : '#f87171' }}>
                                        ğŸ• {stop.openNow ? '×¤×ª×•×—' : '×¡×’×•×¨'} Â· {stop.todayHours}
                                      </div>
                                    )}
                                    {stop.notes && (
                                      <div className="text-gray-400 italic">ğŸ’­ {stop.notes}</div>
                                    )}
                                    <div className="text-gray-400 mt-2 text-[9px]">ğŸ‘† ×œ×—×¥ ×œ×¤×¨×˜×™× ××œ××™×</div>
                                  </div>
                                </div>
                              </div>
                            ) : (
                              <span 
                                className={`${sourceBadge.color} text-white text-[10px] px-2 py-0.5 rounded-full font-bold`}
                                title={sourceBadge.title}
                              >
                                {sourceBadge.text}
                              </span>
                            )}
                          </div>
                          <p className="text-xs" style={{
                            color: hasValidCoords ? '#4b5563' : '#991b1b'
                          }}>
                            {hasValidCoords ? stop.description : 'âš ï¸ ×—×¡×¨×•×ª ×§×•××•×¨×“×™× ×˜×•×ª - ×œ× ×™×›×œ×œ ×‘××¡×œ×•×œ'}
                          </p>
                          {stop.todayHours && (
                            <p className="text-[10px]" style={{ color: stop.openNow ? '#059669' : '#dc2626' }}>
                              ğŸ• {stop.openNow ? '×¤×ª×•×—' : '×¡×’×•×¨'} Â· {stop.todayHours}
                            </p>
                          )}
                        </div>
                      </div>
                      <div className="flex gap-1 flex-shrink-0">
                        {/* Temporary skip button */}
                        <button
                          onClick={() => toggleStopActive(i)}
                          className={`text-xs px-2 py-1 rounded ${isDisabled ? 'bg-yellow-500 text-white' : 'bg-gray-400 text-white'}`}
                          title={isDisabled ? '×”×—×–×¨ ×œ××¡×œ×•×œ' : '×“×œ×’ ×–×× ×™×ª'}
                        >
                          {isDisabled ? 'â¸ï¸' : 'âœ•'}
                        </button>
                        
                        {(() => {
                          // Check if this place is in blacklist
                          const blacklisted = customLocations.find(loc => 
                            loc.name.toLowerCase() === stop.name.toLowerCase() && 
                            loc.status === 'blacklist'
                          );
                          
                          if (blacklisted) {
                            // Show GREEN undo button - removes from blacklist
                            return (
                              <button
                                onClick={() => {
                                  deleteCustomLocation(blacklisted.id);
                                  showToast(`"${stop.name}" ×—×–×¨ ×œ×¨×©×™××” ×”×¨×’×™×œ×”`, 'success');
                                }}
                                className="text-xs px-2 py-1 rounded bg-green-500 text-white hover:bg-green-600"
                                title="×‘×˜×œ ×“×™×œ×•×’ ×§×‘×•×¢"
                              >
                                âœ…
                              </button>
                            );
                          }
                          
                          // Show permanent skip button (for non-custom places)
                          if (!isCustom) {
                            return (
                              <button
                                onClick={() => skipPlacePermanently(stop)}
                                className="text-xs px-2 py-1 rounded bg-red-500 text-white hover:bg-red-600"
                                title="×“×œ×’ ×œ×¦××™×ª×•×ª"
                              >
                                ğŸš«
                              </button>
                            );
                          }
                          
                          return null;
                        })()}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>

            <div className="space-y-3 mb-4">
              <a
                href={(() => {
                  // Filter active stops with valid coordinates
                  const activeStops = route.stops.filter((s, i) => {
                    const isActive = !disabledStops.includes(s.id || i);
                    const hasValidCoords = s.lat && s.lng && s.lat !== 0 && s.lng !== 0;
                    return isActive && hasValidCoords;
                  });
                  
                  if (activeStops.length === 0) {
                    return '#';
                  }
                  
                  // Calculate center
                  const avgLat = activeStops.reduce((sum, s) => sum + s.lat, 0) / activeStops.length;
                  const avgLng = activeStops.reduce((sum, s) => sum + s.lng, 0) / activeStops.length;
                  
                  // Create search query with all active place names
                  const query = activeStops.map(s => s.name).join(' OR ');
                  
                  // Return search URL with active places
                  return `https://www.google.com/maps/search/${encodeURIComponent(query)}/@${avgLat},${avgLng},13z`;
                })()}
                target="_blank"
                rel="noopener noreferrer"
                onClick={(e) => {
                  const activeStops = route.stops.filter((s, i) => {
                    const isActive = !disabledStops.includes(s.id || i);
                    const hasValidCoords = s.lat && s.lng && s.lat !== 0 && s.lng !== 0;
                    return isActive && hasValidCoords;
                  });
                  if (activeStops.length === 0) {
                    e.preventDefault();
                    showToast('××™×Ÿ ××§×•××•×ª ×¢× ×§×•××•×¨×“×™× ×˜×•×ª ×ª×§×™× ×•×ª', 'warning');
                  }
                }}
                style={{
                  display: 'block',
                  width: '100%',
                  backgroundColor: '#f59e0b',
                  color: 'white',
                  textAlign: 'center',
                  padding: '10px',
                  borderRadius: '12px',
                  fontWeight: 'bold',
                  textDecoration: 'none',
                  fontSize: '14px',
                  boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.3)',
                  marginBottom: '4px'
                }}
              >
                ğŸ—ºï¸ ×”×¦×’ ××ª ×›×œ ×”××§×•××•×ª ×¢×œ ×”××¤×”
              </a>
              
              {/* URL limit note */}
              <p style={{
                fontSize: '10px',
                color: '#6b7280',
                textAlign: 'center',
                marginBottom: '12px',
                fontStyle: 'italic'
              }}>
                ××’×‘×œ×ª ×˜×œ×¤×•×Ÿ: ×¢×“ ~6 ××§×•××•×ª (250 ×ª×•×•×™×)
              </p>

              {/* Route Type + Button */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {/* Route Type Radio Buttons - Small and Simple */}
                <div style={{
                  display: 'flex',
                  gap: '16px',
                  fontSize: '13px',
                  paddingRight: '4px'
                }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                    <input
                      type="radio"
                      name="routeTypeExpanded"
                      checked={routeType === 'circular'}
                      onChange={() => setRouteType('circular')}
                      style={{ cursor: 'pointer' }}
                    />
                    <span>××¢×’×œ×™</span>
                  </label>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                    <input
                      type="radio"
                      name="routeTypeExpanded"
                      checked={routeType === 'linear'}
                      onChange={() => setRouteType('linear')}
                      style={{ cursor: 'pointer' }}
                    />
                    <span>×œ×™× ××¨×™</span>
                  </label>
                </div>
                
                {/* Calculate Route Button */}
                <a
                  href={(() => {
                    // Build Google Maps URL based on routeType
                    const activeStops = route.stops.filter((stop, i) => {
                      const isActive = !disabledStops.includes(stop.id || i);
                      const hasValidCoords = stop.lat && stop.lng && stop.lat !== 0 && stop.lng !== 0;
                      return isActive && hasValidCoords;
                    });
                    
                    if (activeStops.length === 0) {
                      return '#';
                    }

                    // Use startPointCoords as origin if available
                    const hasStartPoint = startPointCoords && startPointCoords.lat && startPointCoords.lng;
                    const origin = hasStartPoint 
                      ? `${startPointCoords.lat},${startPointCoords.lng}`
                      : `${activeStops[0].lat},${activeStops[0].lng}`;
                    let destination, waypointsStr, mapUrl;

                    if (activeStops.length === 1 && !hasStartPoint) {
                      mapUrl = `https://www.google.com/maps/search/?api=1&query=${activeStops[0].lat},${activeStops[0].lng}`;
                    } else {
                      if (routeType === 'circular') {
                        destination = origin;
                        waypointsStr = (hasStartPoint ? activeStops : activeStops.slice(1)).map(s => `${s.lat},${s.lng}`).join('|');
                      } else {
                        destination = `${activeStops[activeStops.length - 1].lat},${activeStops[activeStops.length - 1].lng}`;
                        const middleStops = hasStartPoint ? activeStops.slice(0, -1) : activeStops.slice(1, -1);
                        waypointsStr = middleStops.map(s => `${s.lat},${s.lng}`).join('|');
                      }
                      
                      mapUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
                      if (waypointsStr) mapUrl += `&waypoints=${waypointsStr}`;
                      mapUrl += '&travelmode=walking';
                    }

                    return mapUrl;
                  })()}
                  target="_blank"
                  rel="noopener noreferrer"
                  style={{
                    width: '100%',
                    backgroundColor: '#22c55e',
                    color: 'white',
                    textAlign: 'center',
                    padding: '10px',
                    borderRadius: '12px',
                    fontWeight: 'bold',
                    textDecoration: 'none',
                    fontSize: '14px',
                    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.3)',
                    display: 'block',
                    marginBottom: '4px'
                  }}
                >
                  ğŸ—ºï¸ ×¤×ª×— ××¡×œ×•×œ ×‘×’×•×’×œ
                </a>
                
                {/* Waypoints limit note */}
                <p style={{
                  fontSize: '10px',
                  color: '#6b7280',
                  textAlign: 'center',
                  fontStyle: 'italic'
                }}>
                  ××’×‘×œ×ª ×˜×œ×¤×•×Ÿ: ×¢×“ 25 ××§×•××•×ª
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Saved Routes View */}
        {/* Search View */}
        {currentView === 'search' && (
          <div className="bg-white rounded-xl shadow-lg p-4">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-2xl font-bold">ğŸ” ×—×™×¤×•×© ×‘××§×•××•×ª ×©×œ×™</h2>
              <button
                onClick={() => setCurrentView('myContent')}
                className="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-gray-300 flex items-center gap-1"
              >
                â† ×—×–×¨×”
              </button>
            </div>
            
            <div className="mb-4">
              <input
                type="text"
                placeholder="×—×¤×© ×‘×©×, ×ª×™××•×¨ ××• ×”×¢×¨×•×ª..."
                value={searchQuery}
                className="w-full p-3 border-3 border-gray-300 rounded-xl text-base focus:border-orange-500 focus:ring-2 focus:ring-orange-200"
                style={{ textAlign: 'right', direction: 'rtl' }}
                onChange={(e) => {
                  const query = e.target.value;
                  setSearchQuery(query);
                  
                  if (!query.trim()) {
                    setSearchResults([]);
                    return;
                  }
                  
                  const queryLower = query.toLowerCase();
                  const results = customLocations.filter(loc => 
                    loc.name.toLowerCase().includes(queryLower) ||
                    (loc.description && loc.description.toLowerCase().includes(queryLower)) ||
                    (loc.notes && loc.notes.toLowerCase().includes(queryLower))
                  );
                  setSearchResults(results);
                }}
              />
            </div>
            
            {/* Search Results */}
            {searchQuery && searchResults.length > 0 ? (
              <div className="space-y-3">
                <p className="text-sm text-gray-600 font-bold">× ××¦××• {searchResults.length} ×ª×•×¦××•×ª:</p>
                {searchResults.map(loc => (
                  <div
                    key={loc.id}
                    className="bg-gradient-to-r from-green-50 to-teal-50 border-3 border-green-400 rounded-xl p-4"
                  >
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex-1">
                        <h3 className="text-lg font-bold text-green-900 flex items-center gap-2">
                          <span>{loc.name}</span>
                          {loc.outsideArea && (
                            <span 
                              className="text-orange-500" 
                              title="××§×•× ××—×•×¥ ×œ×’×‘×•×œ×•×ª ×”××–×•×¨"
                              style={{ fontSize: '16px' }}
                            >
                              ğŸ”º
                            </span>
                          )}
                        </h3>
                        <p className="text-sm text-green-700 mt-1">{loc.description || '××™×Ÿ ×ª×™××•×¨'}</p>
                        {loc.notes && (
                          <p className="text-xs text-green-600 mt-1 italic">ğŸ’­ {loc.notes}</p>
                        )}
                      </div>
                      <button
                        onClick={() => handleEditLocation(loc)}
                        className="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-bold"
                      >
                        âœï¸ ×¢×¨×•×š
                      </button>
                    </div>
                    
                    {/* Image Preview */}
                    {loc.uploadedImage && (
                      <img 
                        src={loc.uploadedImage} 
                        alt={loc.name}
                        className="w-full max-max-h-32 object-contain rounded-lg mt-2 cursor-pointer border-2 border-green-300"
                        onClick={() => {
                          setModalImage(loc.uploadedImage);
                          setShowImageModal(true);
                        }}
                      />
                    )}
                    
                    {/* Interests Tags */}
                    {loc.interests && loc.interests.length > 0 && (
                      <div className="flex flex-wrap gap-1 mt-2">
                        {loc.interests.map(intId => {
                          const interest = allInterestOptions.find(opt => opt.id === intId);
                          return interest ? (
                            <span key={intId} className="bg-green-600 text-white text-xs px-2 py-1 rounded-full">
                              {interest.icon} {interest.label}
                            </span>
                          ) : null;
                        })}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            ) : searchQuery && searchResults.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <div className="text-6xl mb-4">ğŸ”</div>
                <p className="font-bold">×œ× × ××¦××• ×ª×•×¦××•×ª ×¢×‘×•×¨ "{searchQuery}"</p>
                <p className="text-sm mt-2">× ×¡×” ×œ×—×¤×© ××©×”×• ××—×¨</p>
              </div>
            ) : customLocations.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <div className="text-6xl mb-4">ğŸ“</div>
                <p className="font-bold">×¢×“×™×™×Ÿ ××™×Ÿ ××§×•××•×ª ××•×ª×××™× ××™×©×™×ª</p>
                <p className="text-sm mt-2">×”×•×¡×£ ××§×•××•×ª ×›×“×™ ×œ×—×¤×© ×‘×”×</p>
              </div>
            ) : (
              <div className="text-center py-12 text-gray-500">
                <div className="text-6xl mb-4">ğŸ”</div>
                <p className="font-bold">×”×ª×—×œ ×œ×”×§×œ×™×“ ×›×“×™ ×œ×—×¤×©</p>
                <p className="text-sm mt-2">×™×© ×œ×š {customLocations.length} ××§×•××•×ª ××•×ª×××™× ××™×©×™×ª</p>
              </div>
            )}
          </div>
        )}

        {currentView === 'saved' && (
          <div className="bg-white rounded-xl shadow-lg p-3">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-2">
                <h2 className="text-lg font-bold">ğŸ—ºï¸ ××¡×œ×•×œ×™× ×©××•×¨×™×</h2>
                <span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">
                  {savedRoutes.length}
                </span>
                <button
                  onClick={() => showHelpFor('saved')}
                  className="text-gray-400 hover:text-blue-500 text-sm"
                  title="×¢×–×¨×”"
                >â“</button>
              </div>
              <div className="flex items-center gap-2">
                {/* Sort toggle */}
                <div className="flex bg-gray-200 rounded-lg p-0.5">
                  <button
                    onClick={() => setRoutesSortBy('area')}
                    className={`px-2 py-0.5 rounded text-[10px] font-bold ${routesSortBy === 'area' ? 'bg-white shadow text-blue-700' : 'text-gray-500'}`}
                  >×œ×¤×™ ××™×–×•×¨</button>
                  <button
                    onClick={() => setRoutesSortBy('name')}
                    className={`px-2 py-0.5 rounded text-[10px] font-bold ${routesSortBy === 'name' ? 'bg-white shadow text-blue-700' : 'text-gray-500'}`}
                  >×œ×¤×™ ×©×</button>
                </div>
              </div>
            </div>
            
            {savedRoutes.length === 0 ? (
              <div className="text-center py-8">
                <div className="text-4xl mb-2">ğŸ—ºï¸</div>
                <p className="text-gray-600 mb-3 text-sm">×¢×“×™×™×Ÿ ××™×Ÿ ××¡×œ×•×œ×™× ×©××•×¨×™×</p>
                <button
                  onClick={() => setCurrentView('form')}
                  className="bg-orange-500 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-orange-600"
                >×¦×•×¨ ××¡×œ×•×œ ×—×“×©</button>
              </div>
            ) : (
              <div className="space-y-1">
                {(() => {
                  const sorted = [...savedRoutes].sort((a, b) => {
                    if (routesSortBy === 'name') return (a.name || '').localeCompare(b.name || '', 'he');
                    return (a.areaName || '').localeCompare(b.areaName || '', 'he');
                  });
                  
                  let lastGroup = null;
                  return sorted.map(savedRoute => {
                    const groupKey = routesSortBy === 'area' ? (savedRoute.areaName || '×œ×œ× ××™×–×•×¨') : null;
                    const showGroupHeader = routesSortBy === 'area' && groupKey !== lastGroup;
                    if (showGroupHeader) lastGroup = groupKey;
                    
                    // Collect interest icons from route stops
                    const routeInterestIds = [...new Set((savedRoute.stops || []).flatMap(s => s.interests || []))];
                    
                    return (
                      <React.Fragment key={savedRoute.id}>
                        {showGroupHeader && (
                          <div className="text-xs font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded mt-2 mb-1">
                            ğŸ“ {groupKey}
                          </div>
                        )}
                        <div
                          className={`flex items-center justify-between gap-2 rounded-lg p-2 border ${
                            savedRoute.inProgress ? 'border-orange-300 bg-orange-50' : 'border-gray-200 bg-white'
                          } hover:bg-blue-50 cursor-pointer`}
                          onClick={() => loadSavedRoute(savedRoute)}
                        >
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-1 flex-wrap">
                              <span className="font-medium text-sm truncate">{savedRoute.name}</span>
                              {savedRoute.locked && <span title="× ×¢×•×œ" style={{ fontSize: '11px' }}>ğŸ”’</span>}
                              {savedRoute.inProgress && <span title="×‘×¢×‘×•×“×”" style={{ fontSize: '12px' }}>ğŸ› ï¸</span>}
                              {routeInterestIds.slice(0, 5).map((intId, idx) => {
                                const obj = allInterestOptions.find(o => o.id === intId);
                                return obj?.icon ? <span key={idx} title={obj.label} style={{ fontSize: '12px' }}>{obj.icon}</span> : null;
                              })}
                              <span className="text-[10px] text-gray-400 flex-shrink-0">{savedRoute.stops?.length || 0} ×ª×—× ×•×ª</span>
                            </div>
                            {savedRoute.notes && (
                              <div className="text-[10px] text-gray-500 truncate mt-0.5">ğŸ“ {savedRoute.notes}</div>
                            )}
                          </div>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setEditingRoute({...savedRoute});
                              setRouteDialogMode('edit');
                              setShowRouteDialog(true);
                            }}
                            className="text-xs px-1 py-0.5 rounded hover:bg-blue-100 flex-shrink-0"
                            title="×¤×¨×˜×™× / ×¢×¨×•×š"
                          >âœï¸</button>
                        </div>
                      </React.Fragment>
                    );
                  });
                })()}
              </div>
            )}
          </div>
        )}

                {/* My Content View */}
        {/* My Content View - Compact Design */}
        {currentView === 'myPlaces' && (
          <div className="bg-white rounded-xl shadow-lg p-3">
            <div className="flex items-center gap-2 mb-3">
              <h2 className="text-lg font-bold">ğŸ“ ×”××§×•××•×ª ×©×œ×™</h2>
              <button
                onClick={() => showHelpFor('myPlaces')}
                className="text-gray-400 hover:text-blue-500 text-sm"
                title="×¢×–×¨×”"
              >
                â“
              </button>
            </div>
            
            {/* Custom Locations Section - Split by status */}
            <div className="mb-4">
              <div className="flex justify-between items-center mb-2">
                <h3 className="text-base font-bold">××§×•××•×ª ({customLocations.length})</h3>
                <div className="flex items-center gap-2">
                  {/* Group by toggle */}
                  <div className="flex bg-gray-200 rounded-lg p-0.5">
                    <button
                      onClick={() => setPlacesGroupBy('interest')}
                      className={`px-2 py-0.5 rounded text-[10px] font-bold ${placesGroupBy === 'interest' ? 'bg-white shadow text-purple-700' : 'text-gray-500'}`}
                    >
                      ×œ×¤×™ ×ª×—×•×
                    </button>
                    <button
                      onClick={() => setPlacesGroupBy('area')}
                      className={`px-2 py-0.5 rounded text-[10px] font-bold ${placesGroupBy === 'area' ? 'bg-white shadow text-purple-700' : 'text-gray-500'}`}
                    >
                      ×œ×¤×™ ××™×–×•×¨
                    </button>
                  </div>
                  <button
                    onClick={() => setCurrentView('search')}
                    className="text-blue-500 hover:text-blue-700 text-xl"
                    title="×—×™×¤×•×©"
                  >
                    ğŸ”
                  </button>
                  <button
                    onClick={() => setShowAddLocationDialog(true)}
                    className="bg-emerald-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-emerald-600"
                  >
                    â• ×”×•×¡×£ ××§×•×
                  </button>
                </div>
              </div>
              
              {customLocations.length === 0 ? (
                <div className="text-center py-6 bg-gray-50 rounded-lg">
                  <div className="text-3xl mb-2">ğŸ“</div>
                  <p className="text-gray-600 text-sm">×¢×“×™×™×Ÿ ××™×Ÿ ××§×•××•×ª ××•×ª×××™× ××™×©×™×ª</p>
                  <p className="text-xs text-gray-500 mt-1">×œ×—×¥ "×”×•×¡×£ ××§×•×" ×›×“×™ ×œ×™×¦×•×¨</p>
                </div>
              ) : (
                <>
                  {/* Active Locations - Grouped */}
                  {(() => {
                    const activeLocations = customLocations.filter(loc => loc.status !== 'blacklist');
                    if (activeLocations.length === 0) return null;
                    
                    // Group locations
                    const groups = {};
                    const ungrouped = [];
                    
                    activeLocations.forEach(loc => {
                      if (placesGroupBy === 'interest') {
                        const interests = loc.interests || [];
                        if (interests.length === 0) {
                          ungrouped.push(loc);
                        } else {
                          interests.forEach(int => {
                            if (!groups[int]) groups[int] = [];
                            groups[int].push(loc);
                          });
                        }
                      } else {
                        // Group by area
                        const area = loc.area || 'unknown';
                        if (!groups[area]) groups[area] = [];
                        groups[area].push(loc);
                      }
                    });
                    
                    // Sort groups
                    const sortedGroupKeys = Object.keys(groups).sort((a, b) => {
                      if (placesGroupBy === 'interest') {
                        const aObj = allInterestOptions.find(o => o.id === a);
                        const bObj = allInterestOptions.find(o => o.id === b);
                        return (aObj?.label || a).localeCompare(bObj?.label || b, 'he');
                      } else {
                        const aObj = areaOptions.find(o => o.id === a);
                        const bObj = areaOptions.find(o => o.id === b);
                        return (aObj?.label || a).localeCompare(bObj?.label || b, 'he');
                      }
                    });
                    
                    // Sort locations within each group by the secondary dimension
                    const sortWithin = (locs) => {
                      return [...locs].sort((a, b) => {
                        if (placesGroupBy === 'interest') {
                          // Sort by area within interest group
                          const aArea = areaOptions.find(o => o.id === a.area)?.label || '';
                          const bArea = areaOptions.find(o => o.id === b.area)?.label || '';
                          return aArea.localeCompare(bArea, 'he') || a.name.localeCompare(b.name, 'he');
                        } else {
                          // Sort by interest within area group
                          const aInt = (a.interests?.[0]) || '';
                          const bInt = (b.interests?.[0]) || '';
                          return aInt.localeCompare(bInt) || a.name.localeCompare(b.name, 'he');
                        }
                      });
                    };
                    
                    // Render a single location row
                    const renderLocationRow = (loc) => {
                      const mapUrl = loc.address?.trim() 
                        ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc.address.trim())}`
                        : (loc.lat && loc.lng) 
                          ? `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}`
                          : null;
                      const canEdit = !loc.locked || isUnlocked;
                      return (
                      <div
                        key={loc.id}
                        className="flex items-center justify-between gap-2 border border-emerald-300 rounded p-1.5 bg-emerald-50 hover:bg-emerald-100"
                      >
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-1 flex-wrap">
                            {mapUrl ? (
                              <a href={mapUrl} target="_blank" rel="noopener noreferrer"
                                className="font-medium text-sm text-blue-600 hover:text-blue-800 hover:underline truncate"
                              >{loc.name}</a>
                            ) : (
                              <span className="font-medium text-sm truncate">{loc.name}</span>
                            )}
                            {loc.locked && <span title="× ×¢×•×œ" style={{ fontSize: '12px' }}>ğŸ”’</span>}
                            {loc.inProgress && <span className="text-orange-600" title="×‘×¢×‘×•×“×”" style={{ fontSize: '14px' }}>ğŸ› ï¸</span>}
                            {loc.outsideArea && <span className="text-orange-500 text-xs" title="××—×•×¥ ×œ×’×‘×•×œ×•×ª">ğŸ”º</span>}
                            {loc.missingCoordinates && <span className="text-red-500 text-xs" title="××™×Ÿ ××™×§×•×">âš ï¸</span>}
                            {placesGroupBy === 'area' && loc.interests?.map((int, idx) => {
                              const obj = allInterestOptions.find(o => o.id === int);
                              return obj?.icon ? <span key={idx} title={obj.label} style={{ fontSize: '13px' }}>{obj.icon}</span> : null;
                            })}
                            {placesGroupBy === 'interest' && loc.area && (
                              <span className="text-[10px] bg-gray-200 text-gray-600 px-1 rounded">{areaOptions.find(a => a.id === loc.area)?.label || loc.area}</span>
                            )}
                          </div>
                        </div>
                        <div className="flex gap-0.5">
                          <button onClick={() => handleEditLocation(loc)}
                            className="text-xs px-1 py-0.5 rounded hover:bg-blue-100"
                            title="×¤×¨×˜×™× / ×¢×¨×•×š">âœï¸</button>
                        </div>
                      </div>
                    );
                    };
                    
                    return (
                      <div className="mb-3">
                        <h4 className="text-sm font-bold text-green-700 mb-2">
                          âœ… ××§×•××•×ª ×›×œ×•×œ×™× ({activeLocations.length})
                        </h4>
                        <div className="space-y-2 max-h-[55vh] overflow-y-auto">
                          {sortedGroupKeys.map(key => {
                            const locs = sortWithin(groups[key]);
                            let groupLabel, groupIcon;
                            if (placesGroupBy === 'interest') {
                              const obj = allInterestOptions.find(o => o.id === key);
                              groupLabel = obj?.label || key;
                              groupIcon = obj?.icon || 'ğŸ·ï¸';
                            } else {
                              const obj = areaOptions.find(o => o.id === key);
                              groupLabel = obj?.label || key;
                              groupIcon = 'ğŸ“';
                            }
                            return (
                              <div key={key} className="border border-gray-200 rounded-lg overflow-hidden">
                                <div className="bg-gray-100 px-2 py-1 flex items-center gap-1 text-xs font-bold text-gray-700">
                                  <span>{groupIcon}</span>
                                  <span>{groupLabel}</span>
                                  <span className="text-gray-400 font-normal">({locs.length})</span>
                                </div>
                                <div className="space-y-0.5 p-1">
                                  {locs.map(renderLocationRow)}
                                </div>
                              </div>
                            );
                          })}
                          {ungrouped.length > 0 && (
                            <div className="border border-gray-200 rounded-lg overflow-hidden">
                              <div className="bg-gray-100 px-2 py-1 text-xs font-bold text-gray-500">
                                ×œ×œ× ×ª×—×•× ({ungrouped.length})
                              </div>
                              <div className="space-y-0.5 p-1">
                                {sortWithin(ungrouped).map(renderLocationRow)}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })()}
                  
                  {/* Blacklisted Locations - Collapsible */}
                  {(() => {
                    const blacklistedLocations = customLocations.filter(loc => loc.status === 'blacklist');
                    
                    return blacklistedLocations.length > 0 && (
                      <div className="border-2 border-red-300 rounded-lg p-2 bg-red-50">
                        <button
                          onClick={() => setShowBlacklistLocations(!showBlacklistLocations)}
                          className="w-full flex items-center justify-between text-sm font-bold text-red-700 hover:text-red-900"
                        >
                          <span className="flex items-center gap-1">
                            <span>{showBlacklistLocations ? 'â–¼' : 'â—€'}</span>
                            <span>ğŸš« ××§×•××•×ª ×©××“×œ×’×™× ×¢×œ×™×”× ({blacklistedLocations.length})</span>
                          </span>
                          <span className="text-[10px] text-red-600">
                            {showBlacklistLocations ? '×”×¡×ª×¨' : '×”×¦×’'}
                          </span>
                        </button>
                        
                        {showBlacklistLocations && (
                          <div className="space-y-1 mt-2 max-h-40 overflow-y-auto">
                            {blacklistedLocations.map(loc => {
                              const mapUrl = loc.address?.trim() 
                                ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc.address.trim())}`
                                : (loc.lat && loc.lng) 
                                  ? `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}`
                                  : null;
                              return (
                              <div
                                key={loc.id}
                                className="flex items-center justify-between gap-2 border border-red-300 rounded p-1.5 bg-white hover:bg-red-50"
                              >
                                <div className="flex-1 min-w-0">
                                  <div className="flex items-center gap-1 flex-wrap">
                                    {mapUrl ? (
                                      <a href={mapUrl} target="_blank" rel="noopener noreferrer"
                                        className="font-medium text-sm text-blue-600 hover:text-blue-800 hover:underline truncate"
                                      >{loc.name}</a>
                                    ) : (
                                      <span className="font-medium text-sm truncate">{loc.name}</span>
                                    )}
                                    {loc.locked && <span title="× ×¢×•×œ" style={{ fontSize: '12px' }}>ğŸ”’</span>}
                                    {loc.interests?.map((int, idx) => {
                                      const obj = allInterestOptions.find(o => o.id === int);
                                      return obj?.icon ? <span key={idx} title={obj.label} style={{ fontSize: '13px' }}>{obj.icon}</span> : null;
                                    })}
                                  </div>
                                </div>
                                <div className="flex gap-0.5">
                                  <button onClick={() => handleEditLocation(loc)}
                                    className="text-xs px-1 py-0.5 rounded hover:bg-blue-100"
                                    title="×¤×¨×˜×™× / ×¢×¨×•×š">âœï¸</button>
                                </div>
                              </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    );
                  })()}
                </>
              )}
            </div>

          </div>
        )}

        {/* My Interests View */}
        {currentView === 'myInterests' && (
          <div className="bg-white rounded-xl shadow-lg p-3">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-2">
                <h2 className="text-lg font-bold">ğŸ·ï¸ ×”×ª×—×•××™× ×©×œ×™</h2>
                <span className="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">
                  {Object.values(interestStatus).filter(Boolean).length} ×¤×¢×™×œ×™×
                </span>
              </div>
              <button
                onClick={() => {
                  setEditingCustomInterest(null);
                  setNewInterest({ label: '', icon: 'ğŸ“', searchMode: 'types', types: '', textSearch: '', blacklist: '', inProgress: true, locked: false, builtIn: false });
                  setShowAddInterestDialog(true);
                }}
                className="bg-purple-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-purple-600"
              >
                â• ×”×•×¡×£ ×ª×—×•×
              </button>
            </div>
            
            {/* Unified Interest List */}
            {(() => {
              // Helper to open interest dialog for editing
              const openInterestDialog = (interest, isCustom = false) => {
                const config = interestConfig[interest.id] || {};
                setEditingCustomInterest(isCustom ? interest : { ...interest, builtIn: true });
                setNewInterest({
                  id: interest.id,
                  label: interest.label || interest.name || '',
                  icon: interest.icon || 'ğŸ“',
                  searchMode: config.textSearch ? 'text' : 'types',
                  types: (config.types || []).join(', '),
                  textSearch: config.textSearch || '',
                  blacklist: (config.blacklist || []).join(', '),
                  inProgress: interest.inProgress || false,
                  locked: interest.locked || false,
                  builtIn: !isCustom
                });
                setShowAddInterestDialog(true);
              };
              
              // Render a single interest row
              const renderInterestRow = (interest, isCustom = false, isActive = true) => {
                const isValid = isInterestValid(interest.id);
                const borderClass = !isActive ? 'border border-gray-300 bg-gray-50 opacity-60'
                  : isCustom ? (isValid ? 'border-2 border-purple-400 bg-purple-50' : 'border-2 border-red-400 bg-red-50')
                  : (isValid ? 'border border-green-300 bg-green-50' : 'border-2 border-red-400 bg-red-50');
                
                return (
                  <div key={interest.id} className={`flex items-center justify-between gap-2 rounded-lg p-2 ${borderClass}`}>
                    <div className="flex items-center gap-2 flex-1 min-w-0">
                      <span className="text-lg flex-shrink-0">{interest.icon}</span>
                      <span className={`font-medium text-sm truncate ${!isActive ? 'text-gray-500' : ''}`}>{interest.label || interest.name}</span>
                      {isCustom && <span className="text-[10px] bg-purple-200 text-purple-800 px-1 py-0.5 rounded flex-shrink-0">××•×ª××</span>}
                      {!isValid && <span className="text-red-500 text-xs flex-shrink-0" title="×—×¡×¨ ×”×’×“×¨×•×ª ×—×™×¤×•×©">âš ï¸</span>}
                      {interest.inProgress && <span className="text-orange-600 flex-shrink-0" title="×‘×¢×‘×•×“×”" style={{ fontSize: '12px' }}>ğŸ› ï¸</span>}
                      {interest.locked && <span title="× ×¢×•×œ" style={{ fontSize: '11px' }} className="flex-shrink-0">ğŸ”’</span>}
                    </div>
                    <button
                      onClick={() => openInterestDialog(interest, isCustom)}
                      className="text-xs px-1 py-0.5 rounded hover:bg-blue-100 flex-shrink-0"
                      title="×¤×¨×˜×™× / ×¢×¨×•×š"
                    >âœï¸</button>
                  </div>
                );
              };
              
              // Collect active and inactive
              const activeBuiltIn = interestOptions.filter(i => interestStatus[i.id] !== false);
              const activeUncovered = uncoveredInterests.filter(i => interestStatus[i.id] === true);
              const activeCustom = customInterests.filter(i => interestStatus[i.id] !== false);
              const inactiveBuiltIn = interestOptions.filter(i => interestStatus[i.id] === false);
              const inactiveUncovered = uncoveredInterests.filter(i => interestStatus[i.id] !== true);
              const inactiveCustom = customInterests.filter(i => interestStatus[i.id] === false);
              
              return (
                <>
                  {/* Active Interests */}
                  <div className="mb-4">
                    <h3 className="text-sm font-bold text-green-700 mb-2">
                      âœ… ×ª×—×•××™× ×¤×¢×™×œ×™× ({activeBuiltIn.length + activeUncovered.length + activeCustom.length})
                    </h3>
                    <div className="space-y-1">
                      {activeBuiltIn.map(i => renderInterestRow(i, false, true))}
                      {activeUncovered.map(i => renderInterestRow(i, false, true))}
                      {activeCustom.map(i => renderInterestRow(i, true, true))}
                    </div>
                  </div>
                  
                  {/* Inactive Interests */}
                  {(inactiveBuiltIn.length + inactiveUncovered.length + inactiveCustom.length) > 0 && (
                    <div className="mb-2">
                      <h3 className="text-sm font-bold text-gray-500 mb-2">
                        â¸ï¸ ×ª×—×•××™× ×œ× ×¤×¢×™×œ×™× ({inactiveBuiltIn.length + inactiveUncovered.length + inactiveCustom.length})
                      </h3>
                      <div className="space-y-1">
                        {inactiveBuiltIn.map(i => renderInterestRow(i, false, false))}
                        {inactiveUncovered.map(i => renderInterestRow(i, false, false))}
                        {inactiveCustom.map(i => renderInterestRow(i, true, false))}
                      </div>
                    </div>
                  )}
                </>
              );
            })()}
          </div>
        )}

        {/* Settings View - Compact Design */}
        {currentView === 'settings' && (
          <div className="bg-white rounded-xl shadow-lg p-3">
            <div className="flex items-center gap-2 mb-3">
              <h2 className="text-lg font-bold">×”×’×“×¨×•×ª</h2>
              <button
                onClick={() => showHelpFor('settings')}
                className="text-gray-400 hover:text-blue-500 text-sm"
                title="×¢×–×¨×”"
              >
                â“
              </button>
            </div>
            
            {/* Max Stops Setting */}
            <div className="mb-3">
              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-400 rounded-lg p-2">
                <h3 className="text-sm font-bold text-gray-800 mb-1">ğŸ“ ××¡×¤×¨ ××§×•××•×ª ×‘××¡×œ×•×œ</h3>
                <input
                  type="number"
                  min="1"
                  max="100"
                  value={formData.maxStops}
                  onChange={(e) => {
                    const val = parseInt(e.target.value) || 10;
                    setFormData({...formData, maxStops: Math.min(100, Math.max(1, val))});
                  }}
                  className="w-20 p-1 border-2 border-blue-300 rounded text-center font-bold text-sm"
                  placeholder="10"
                />
                <span className="text-[10px] text-gray-500 mr-2">(1-100)</span>
              </div>
            </div>
            
            {/* Fetch More Count Setting - NEW */}
            <div className="mb-3">
              <div className="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-400 rounded-lg p-2">
                <h3 className="text-sm font-bold text-gray-800 mb-1">â• ××§×•××•×ª × ×•×¡×¤×™× ×‘"××¦× ×¢×•×“"</h3>
                <input
                  type="number"
                  min="1"
                  max="100"
                  value={formData.fetchMoreCount || 3}
                  onChange={(e) => {
                    const val = parseInt(e.target.value) || 5;
                    setFormData({...formData, fetchMoreCount: Math.min(100, Math.max(1, val))});
                  }}
                  className="w-20 p-1 border-2 border-green-300 rounded text-center font-bold text-sm"
                  placeholder="5"
                />
                <span className="text-[10px] text-gray-500 mr-2">(1-100)</span>
              </div>
            </div>
            
            {/* Refresh Data Button */}
            <div className="mb-3">
              <div className="bg-gradient-to-r from-cyan-50 to-teal-50 border-2 border-cyan-400 rounded-xl p-3">
                <h3 className="text-base font-bold text-gray-800 mb-1">ğŸ”„ ×¨×¢× ×•×Ÿ × ×ª×•× ×™×</h3>
                <p className="text-xs text-gray-600 mb-2">
                  ×˜×¢×Ÿ ××—×“×© ××ª ×›×œ ×”× ×ª×•× ×™× ×-Firebase: ×ª×—×•××™×, ××§×•××•×ª, ××¡×œ×•×œ×™× ×•×”×’×“×¨×•×ª
                </p>
                <button
                  onClick={refreshAllData}
                  disabled={isRefreshing}
                  className={`w-full py-2 px-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition ${
                    isRefreshing 
                      ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                      : 'bg-cyan-500 text-white hover:bg-cyan-600 active:bg-cyan-700'
                  }`}
                >
                  <span className={isRefreshing ? 'animate-spin' : ''}>ğŸ”„</span>
                  <span>{isRefreshing ? '××¨×¢× ×Ÿ...' : '×¨×¢× ×Ÿ ××ª ×›×œ ×”× ×ª×•× ×™×'}</span>
                </button>
                <div className="mt-2 text-[10px] text-gray-500 flex flex-wrap gap-1">
                  <span className="bg-cyan-100 px-1.5 py-0.5 rounded">ğŸ“ ××§×•××•×ª</span>
                  <span className="bg-cyan-100 px-1.5 py-0.5 rounded">ğŸ·ï¸ ×ª×—×•××™×</span>
                  <span className="bg-cyan-100 px-1.5 py-0.5 rounded">ğŸ’¾ ××¡×œ×•×œ×™×</span>
                  <span className="bg-cyan-100 px-1.5 py-0.5 rounded">âš™ï¸ ×”×’×“×¨×•×ª ×—×™×¤×•×©</span>
                  <span className="bg-cyan-100 px-1.5 py-0.5 rounded">ğŸ‘‘ ×”×¨×©××•×ª</span>
                </div>
              </div>
            </div>
            
            {/* Debug Mode Toggle */}
            <div className="mb-4">
              <div className="bg-gradient-to-r from-gray-50 to-slate-50 border-2 border-gray-400 rounded-xl p-3">
                <h3 className="text-base font-bold text-gray-800 mb-1">ğŸ”§ ××¦×‘ Debug</h3>
                <p className="text-xs text-gray-600 mb-2">
                  ×”×¦×’ ×œ×•×’ ×©×œ ×¤×¢×•×œ×•×ª ×œ××™×ª×•×¨ ×‘×¢×™×•×ª
                </p>
                
                <label className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={debugMode}
                    onChange={(e) => setDebugMode(e.target.checked)}
                    className="w-5 h-5 rounded border-2 border-gray-400"
                  />
                  <span className="text-sm font-bold">
                    {debugMode ? 'âœ… Debug ××•×¤×¢×œ' : 'âŒ Debug ×›×‘×•×™'}
                  </span>
                </label>
                
                {debugMode && (
                  <div className="mt-2 text-xs text-gray-600">
                    ×”×•×“×¢×•×ª Debug ×™×•×¤×™×¢×• ×‘×§×•× ×¡×•×œ (F12)
                  </div>
                )}
              </div>
            </div>
            
            {/* Import/Export Section */}
            
            {/* Admin Management - Password Based (Admin Only) */}
            {isCurrentUserAdmin && (
            <div className="mb-4">
              <div className="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-400 rounded-xl p-3">
                <h3 className="text-base font-bold text-gray-800 mb-1">ğŸ‘‘ × ×™×”×•×œ Admin</h3>
                
                {/* Current Device Info */}
                <div className="text-xs bg-white rounded-lg p-2 border border-red-200 mb-3">
                  <strong>××›×©×™×¨ × ×•×›×—×™:</strong> {localStorage.getItem('bangkok_user_id')?.slice(-12) || 'N/A'}
                  <br />
                  <strong>×¡×˜×˜×•×¡:</strong> 
                  <span className="text-green-600 font-bold"> ğŸ”“ ×¤×ª×•×—</span>
                </div>
                
                {/* Password Section - Secure */}
                <div className="mb-3">
                  <label className="text-xs font-bold text-gray-700 block mb-1">ğŸ”‘ {adminPassword ? '×©× ×” ×¡×™×¡××ª ××¢×¨×›×ª:' : '×”×’×“×¨ ×¡×™×¡××ª ××¢×¨×›×ª:'}</label>
                  <div className="flex gap-2">
                    <input
                      type="password"
                      value={newAdminPassword}
                      onChange={(e) => setNewAdminPassword(e.target.value)}
                      placeholder={adminPassword ? '×¡×™×¡××” ×—×“×©×”...' : '×”×’×“×¨ ×¡×™×¡××”'}
                      className="flex-1 p-2 border rounded text-sm"
                    />
                    <button
                      onClick={async () => {
                        if (isFirebaseAvailable && database) {
                          try {
                            if (newAdminPassword.trim()) {
                              const hashed = await window.BKK.hashPassword(newAdminPassword.trim());
                              await database.ref('settings/adminPassword').set(hashed);
                              setAdminPassword(hashed);
                              showToast('×¡×™×¡××” × ×©××¨×”!', 'success');
                            } else {
                              await database.ref('settings/adminPassword').set('');
                              setAdminPassword('');
                              showToast('×¡×™×¡××” ×”×•×¡×¨×” - ×’×™×©×” ×¤×ª×•×—×”', 'warning');
                            }
                            setNewAdminPassword('');
                          } catch (err) {
                            showToast('×©×’×™××” ×‘×©××™×¨×”', 'error');
                          }
                        }
                      }}
                      className="px-3 py-2 bg-green-500 text-white rounded text-sm font-bold"
                    >
                      ×©××•×¨
                    </button>
                  </div>
                  <p className="text-[10px] text-gray-500 mt-1">
                    {adminPassword ? 'ğŸ”’ ××¢×¨×›×ª ××•×’× ×ª ×‘×¡×™×¡××”' : 'ğŸ”“ ×œ×œ× ×¡×™×¡××” - ×’×™×©×” ×¤×ª×•×—×” ×œ×›×•×œ×'}
                  </p>
                </div>
                
                {/* Admin Users List */}
                <div className="mb-3">
                  <label className="text-xs font-bold text-gray-700 block mb-1">ğŸ‘¥ ××©×ª××©×™ Admin ({adminUsers.length}):</label>
                  <div className="bg-white border rounded-lg max-h-32 overflow-y-auto">
                    {adminUsers.length === 0 ? (
                      <div className="p-2 text-xs text-gray-500 text-center">××™×Ÿ ××©×ª××©×™× ×¨×©×•××™×</div>
                    ) : (
                      adminUsers.map((user, idx) => (
                        <div key={user.userId} className="flex justify-between items-center p-2 border-b last:border-b-0 text-xs">
                          <div>
                            <span className="font-mono">{user.oderId?.slice(-12) || 'Unknown'}</span>
                            {user.oderId === localStorage.getItem('bangkok_user_id') && (
                              <span className="text-green-600 mr-1">(××ª×”)</span>
                            )}
                            <br />
                            <span className="text-gray-500">{user.addedAt ? new Date(user.addedAt).toLocaleDateString('he-IL') : ''}</span>
                          </div>
                          <button
                            onClick={() => {
                              if (isFirebaseAvailable && database) {
                                database.ref(`settings/adminUsers/${user.oderId}`).remove()
                                  .then(() => showToast('××©×ª××© ×”×•×¡×¨', 'success'))
                                  .catch(() => showToast('×©×’×™××”', 'error'));
                              }
                            }}
                            className="px-2 py-1 bg-red-500 text-white rounded text-[10px]"
                          >
                            ×”×¡×¨
                          </button>
                        </div>
                      ))
                    )}
                  </div>
                </div>
                
                {/* Access Log Button */}
                <button
                  onClick={() => {
                    markLogsAsSeen();
                    setShowAccessLog(true);
                  }}
                  className="w-full bg-blue-500 text-white py-2 rounded-lg font-bold text-sm hover:bg-blue-600 flex items-center justify-center gap-2"
                >
                  ğŸ“‹ ×¦×¤×” ×‘×œ×•×’ ×›× ×™×¡×•×ª
                  {hasNewEntries && <span className="bg-red-600 text-white text-[10px] px-2 py-0.5 rounded-full">×—×“×©!</span>}
                </button>
              </div>
            </div>
            )}
            
            <div className="mb-4">
              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-400 rounded-xl p-3">
                <h3 className="text-base font-bold text-gray-800 mb-1">ğŸ’¾ ×™×™×‘×•× ×•×™×™×¦×•×</h3>
                <p className="text-xs text-gray-600 mb-2">
                  ×©××•×¨ ×•×”×¢×‘×¨ × ×ª×•× ×™× ×‘×™×Ÿ ××›×©×™×¨×™×
                </p>
                
                <div className="space-y-2">
                  {/* Export Button */}
                  <button
                    onClick={() => {
                      try {
                        // Count active interests
                        const activeCount = Object.values(interestStatus).filter(Boolean).length;
                        
                        const data = {
                          // Custom interests created by user
                          customInterests: customInterests,
                          // Custom locations
                          customLocations: customLocations,
                          // Saved routes
                          savedRoutes: savedRoutes,
                          // Interest search configurations (types, textSearch, blacklist)
                          interestConfig: interestConfig,
                          // Interest active/inactive status
                          interestStatus: interestStatus,
                          // Metadata
                          exportDate: new Date().toISOString(),
                          version: window.BKK.VERSION || '2.8'
                        };
                        
                        const dataStr = JSON.stringify(data, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        const dateStr = new Date().toISOString().split('T')[0];
                        link.download = `bangkok-data-${dateStr}.json`;
                        link.click();
                        URL.revokeObjectURL(url);
                        
                        showToast(`×”×§×•×‘×¥ ×”×•×¨×“! (${customInterests.length} ×ª×—×•××™× ××•×ª×××™×, ${activeCount} ×¤×¢×™×œ×™×, ${customLocations.length} ××§×•××•×ª, ${savedRoutes.length} ××¡×œ×•×œ×™×)`, 'success');
                      } catch (error) {
                        console.error('[EXPORT] Error:', error);
                        showToast('×©×’×™××” ×‘×™×™×¦×•×', 'error');
                      }
                    }}
                    className="w-full bg-blue-500 text-white py-2 px-3 rounded-lg font-bold hover:bg-blue-600 transition text-sm flex items-center justify-center gap-2"
                  >
                    <span>ğŸ“¤ ×™×™×¦× ×”×›×œ</span>
                    <span className="text-xs bg-blue-600 px-2 py-0.5 rounded">
                      {customInterests.length + customLocations.length + savedRoutes.length}
                    </span>
                  </button>
                  
                  {/* Import Button */}
                  <div>
                    <input
                      type="file"
                      accept=".json"
                      onChange={(e) => {
                        const file = e.target.files?.[0];
                        if (!file) return;
                        
                        const reader = new FileReader();
                        reader.onload = (event) => {
                          try {
                            const data = JSON.parse(event.target.result);
                            
                            if (!data.customInterests && !data.customLocations && !data.savedRoutes) {
                              showToast('×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ - ×œ× × ××¦××• × ×ª×•× ×™×', 'error');
                              return;
                            }
                            
                            setImportedData(data);
                            setShowImportDialog(true);
                          } catch (error) {
                            console.error('[IMPORT] Error:', error);
                            showToast('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥', 'error');
                          }
                        };
                        reader.readAsText(file);
                        e.target.value = '';
                      }}
                      id="importData"
                      className="hidden"
                    />
                    <label
                      htmlFor="importData"
                      className="block w-full bg-green-500 text-white py-2 px-3 rounded-lg font-bold hover:bg-green-600 transition text-sm text-center cursor-pointer"
                    >
                      ğŸ“¥ ×™×™×‘× ××§×•×‘×¥
                    </label>
                  </div>
                  
                  {/* Info Box */}
                  <div className="bg-blue-100 border border-blue-300 rounded-lg p-2 text-[10px]">
                    <p className="text-blue-900 font-bold mb-1">ğŸ’¡ ×©×™××•×©×™×:</p>
                    <ul className="text-blue-800 space-y-0.5 mr-3">
                      <li>â€¢ ×”×¢×‘×¨×” ×‘×™×Ÿ Claude ×œ-GitHub</li>
                      <li>â€¢ ×’×™×‘×•×™ × ×ª×•× ×™×</li>
                      <li>â€¢ ×©×™×ª×•×£ ×¢× ×—×‘×¨×™×</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            
            {/* Share App Section */}
            <div className="mt-3">
              <div className="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-400 rounded-lg p-3">
                <h3 className="text-sm font-bold text-gray-800 mb-2">ğŸ“¤ ×©×ª×£ ××ª ×”××¤×œ×™×§×¦×™×”</h3>
                <p className="text-xs text-gray-600 mb-3">
                  ××”×‘×ª ××ª ×”××¤×œ×™×§×¦×™×”? ×©×ª×£ ×¢× ×—×‘×¨×™×!
                </p>
                
                <button
                  onClick={() => {
                    const shareData = {
                      title: 'Bangkok Explorer ğŸ—ºï¸',
                      text: '××¤×œ×™×§×¦×™×” ×—×›××” ×œ×ª×›× ×•×Ÿ ×˜×™×•×œ×™× ×‘×‘× ×’×§×•×§! ××¦× ××§×•××•×ª ××¢× ×™×™× ×™× ×•×‘× ×” ××¡×œ×•×œ ××•×ª×× ××™×©×™×ª ğŸŒ',
                      url: window.location.href
                    };
                    
                    // Try native share API (mobile)
                    if (navigator.share) {
                      navigator.share(shareData)
                        .then(() => showToast('×ª×•×“×” ×¢×œ ×”×©×™×ª×•×£!', 'success'))
                        .catch((err) => {
                          if (err.name !== 'AbortError') {
                            console.error('Share error:', err);
                          }
                        });
                    } else {
                      // Fallback - reliable copy method
                      try {
                        const textArea = document.createElement('textarea');
                        textArea.value = window.location.href;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        if (successful) {
                          showToast('×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—!', 'success');
                        } else {
                          // Show toast with URL
                          showToast('×”×¢×ª×§: ' + window.location.href, 'info');
                        }
                      } catch (err) {
                        console.error('Copy error:', err);
                        // Show toast with URL
                        showToast('×”×¢×ª×§: ' + window.location.href, 'info');
                      }
                    }
                  }}
                  className="w-full bg-orange-500 text-white py-2.5 px-4 rounded-lg font-bold hover:bg-orange-600 transition text-sm flex items-center justify-center gap-2"
                >
                  <span>ğŸ“¤</span>
                  <span>×©×ª×£ ×¢× ×—×‘×¨×™×</span>
                </button>
              </div>
            </div>
            
            {/* Admin Access Log Section */}
            <div className="mt-4 pt-3 border-t border-gray-200 text-center">
              {/* Admin Access Log Button */}
              <div className="mt-2">
                <button
                  onClick={() => {
                    setShowAccessLog(true);
                    markLogsAsSeen();
                  }}
                  className={`px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300 ${
                    hasNewEntries 
                      ? 'bg-red-500 text-white shadow-lg' 
                      : 'bg-gray-400 text-white shadow-md'
                  }`}
                >
                  ğŸ”’ ×œ×•×’ ×›× ×™×¡×•×ª
                  {hasNewEntries && (
                    <span className="mr-1">ğŸ””</span>
                  )}
                </button>
                
                {/* Admin Status */}
                <div className="text-[9px] text-gray-400 mt-1 flex items-center justify-center gap-2">
                  {accessLogs.length > 0 ? (
                    <span>ğŸ‘‘ Admin Mode - {accessLogs.length} ×›× ×™×¡×•×ª</span>
                  ) : (
                    <span>××™×Ÿ ×›× ×™×¡×•×ª ×¢×“×™×™×Ÿ</span>
                  )}
                  
                  {/* Clear Log Button */}
                  {accessLogs.length > 0 && (
                    <button
                      onClick={() => {
                        showConfirm('×œ××—×•×§ ××ª ×›×œ ×œ×•×’ ×”×›× ×™×¡×•×ª? ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”.', () => {
                          database.ref('accessLog').remove();
                          localStorage.setItem('bangkok_last_seen', Date.now().toString());
                          setAccessLogs([]);
                            setHasNewEntries(false);
                            showToast('×”×œ×•×’ × ×•×§×”', 'success');
                          });
                        }}
                        className="text-red-500 hover:text-red-700 text-lg p-1"
                        title="××—×§ ×œ×•×’ ×›× ×™×¡×•×ª"
                      >
                        ğŸ—‘ï¸
                      </button>
                    )}
                  </div>
                </div>
            </div>
          </div>
        )}

        {/* === DIALOGS (from dialogs.js) === */}


        {/* Add/Edit Location Dialog - REDESIGNED */}
        {(showAddLocationDialog || showEditLocationDialog) && (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-2">
            <div className="bg-white rounded-xl w-full max-w-2xl max-h-[95vh] flex flex-col shadow-2xl">
              
              {/* Header - Compact */}
              <div className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2.5 rounded-t-xl flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <h3 className="text-base font-bold">
                    {showEditLocationDialog ? '×¢×¨×•×š ××§×•×' : '×”×•×¡×£ ××§×•×'}
                  </h3>
                  <button
                    onClick={() => showHelpFor('addLocation')}
                    className="bg-white text-purple-600 hover:bg-purple-100 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold shadow"
                    title="×¢×–×¨×”"
                  >
                    ?
                  </button>
                </div>
                <button
                  onClick={() => {
                    setShowAddLocationDialog(false);
                    setShowEditLocationDialog(false);
                    setEditingLocation(null);
                    setNewLocation({ 
                      name: '', description: '', notes: '', area: formData.area, interests: [], 
                      lat: null, lng: null, mapsUrl: '', address: '', uploadedImage: null, imageUrls: [], inProgress: true
                    });
                  }}
                  className="text-xl hover:bg-white hover:bg-opacity-20 rounded-full w-7 h-7 flex items-center justify-center"
                >
                  âœ•
                </button>
              </div>
              
              {/* Content - Scrollable - COMPACT */}
              <div className="flex-1 overflow-y-auto px-4 py-3 space-y-2.5">
                
                {/* Row 1: Name + Area */}
                <div className="grid grid-cols-3 gap-2">
                  {/* Name - 2 columns */}
                  <div className="col-span-2">
                    <label className="block text-xs font-bold mb-1">
                      ×©× <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      value={newLocation.name}
                      onChange={(e) => {
                        setNewLocation({...newLocation, name: e.target.value});
                        if (e.target.value.trim()) {
                          const exists = customLocations.find(loc => 
                            loc.name.toLowerCase() === e.target.value.trim().toLowerCase() &&
                            (!editingLocation || loc.id !== editingLocation.id)
                          );
                          if (exists) showToast('×©× ×–×” ×›×‘×¨ ×§×™×™×', 'warning');
                        }
                      }}
                      placeholder="×©× ×”××§×•×"
                      className="w-full p-2 text-sm border-2 border-purple-300 rounded-lg focus:border-purple-500"
                      style={{ direction: 'rtl' }}
                      autoFocus
                    />
                  </div>
                  
                  {/* Area - 1 column */}
                  <div>
                    <label className="block text-xs font-bold mb-1">××™×–×•×¨</label>
                    <select
                      value={newLocation.area}
                      onChange={(e) => setNewLocation({...newLocation, area: e.target.value})}
                      className="w-full p-2 text-sm border-2 border-gray-300 rounded-lg focus:border-purple-500"
                      style={{ direction: 'rtl' }}
                    >
                      {areaOptions.map(area => (
                        <option key={area.id} value={area.id}>{area.label}</option>
                      ))}
                    </select>
                  </div>
                </div>

                {/* Interests - Compact Grid */}
                <div>
                  <label className="block text-xs font-bold mb-1">×ª×—×•××™ ×¢× ×™×™×Ÿ</label>
                  <div className="grid grid-cols-6 gap-1.5 p-2 bg-gray-50 rounded-lg max-h-32 overflow-y-auto">
                    {allInterestOptions.map(option => (
                      <button
                        key={option.id}
                        onClick={() => {
                          const current = newLocation.interests || [];
                          setNewLocation({
                            ...newLocation,
                            interests: current.includes(option.id)
                              ? current.filter(i => i !== option.id)
                              : [...current, option.id]
                          });
                        }}
                        className={`p-1.5 rounded-lg text-[10px] font-bold transition-all ${
                          (newLocation.interests || []).includes(option.id)
                            ? 'bg-purple-500 text-white shadow-md'
                            : 'bg-white border border-gray-300 hover:border-purple-300'
                        }`}
                        title={option.label}
                      >
                        <span className="text-lg block">{option.icon}</span>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Description - NEW */}
                <div>
                  <label className="block text-xs font-bold mb-1">ğŸ“ ×ª×™××•×¨</label>
                  <input
                    type="text"
                    value={newLocation.description || ''}
                    onChange={(e) => setNewLocation({...newLocation, description: e.target.value})}
                    placeholder="×ª×™××•×¨ ×§×¦×¨ ×©×œ ×”××§×•×"
                    className="w-full p-2 text-sm border-2 border-gray-300 rounded-lg focus:border-purple-500"
                    style={{ direction: 'rtl' }}
                  />
                </div>

                {/* Image - Compact */}
                <div>
                  <label className="block text-xs font-bold mb-1">ğŸ“· ×ª××•× ×”</label>
                  {newLocation.uploadedImage ? (
                    <div className="relative">
                      <img 
                        src={newLocation.uploadedImage} 
                        alt="Preview"
                        className="w-full h-48 object-cover rounded-lg border-2 border-purple-300 cursor-pointer hover:opacity-90"
                        onClick={() => {
                          setModalImage(newLocation.uploadedImage);
                          setShowImageModal(true);
                        }}
                      />
                      <button
                        onClick={() => setNewLocation({...newLocation, uploadedImage: null})}
                        className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs font-bold hover:bg-red-600"
                      >
                        âœ•
                      </button>
                    </div>
                  ) : (
                    <label className="block w-full p-3 border-2 border-dashed border-purple-300 rounded-lg text-center cursor-pointer hover:bg-purple-50">
                      <span className="text-2xl">ğŸ“¸</span>
                      <div className="text-xs text-gray-600 mt-1">×œ×—×¥ ×œ×”×¢×œ××”</div>
                      <input
                        type="file"
                        accept="image/*"
                        onChange={(e) => {
                          const file = e.target.files?.[0];
                          if (file) {
                            const reader = new FileReader();
                            reader.onload = () => setNewLocation({...newLocation, uploadedImage: reader.result});
                            reader.readAsDataURL(file);
                          }
                        }}
                        className="hidden"
                      />
                    </label>
                  )}
                </div>

                {/* Links - Compact */}
                <div>
                  <label className="block text-xs font-bold mb-1">ğŸ”— ×§×™×©×•×¨×™×</label>
                  <div className="space-y-1">
                    {(newLocation.imageUrls || []).map((url, idx) => (
                      <div key={idx} className="flex gap-1">
                        <input
                          type="text"
                          value={url}
                          onChange={(e) => {
                            const updated = [...(newLocation.imageUrls || [])];
                            updated[idx] = e.target.value;
                            setNewLocation({...newLocation, imageUrls: updated});
                          }}
                          placeholder="https://..."
                          className="flex-1 p-1.5 text-xs border border-gray-300 rounded-lg"
                        />
                        <button
                          onClick={() => {
                            const updated = (newLocation.imageUrls || []).filter((_, i) => i !== idx);
                            setNewLocation({...newLocation, imageUrls: updated});
                          }}
                          className="px-2 py-1 bg-red-500 text-white rounded-lg text-xs font-bold hover:bg-red-600"
                        >
                          âœ•
                        </button>
                      </div>
                    ))}
                    <button
                      onClick={() => setNewLocation({...newLocation, imageUrls: [...(newLocation.imageUrls || []), '']})}
                      className="w-full p-1.5 border border-dashed border-gray-300 rounded-lg text-xs text-gray-600 hover:bg-gray-50"
                    >
                      + ×§×™×©×•×¨
                    </button>
                  </div>
                </div>

                {/* Row 2: Address + Maps Link */}
                <div className="grid grid-cols-2 gap-2">
                  <div>
                    <label className="block text-xs font-bold mb-1">ğŸ  ×›×ª×•×‘×ª</label>
                    <input
                      type="text"
                      value={newLocation.address || ''}
                      onChange={(e) => setNewLocation({...newLocation, address: e.target.value})}
                      placeholder="×›×ª×•×‘×ª"
                      className="w-full p-1.5 text-xs border border-gray-300 rounded-lg focus:border-purple-500"
                      style={{ direction: 'rtl' }}
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-bold mb-1">ğŸ”— ×§×™×©×•×¨ Maps</label>
                    <input
                      type="text"
                      value={newLocation.mapsUrl || ''}
                      onChange={(e) => {
                        setNewLocation({...newLocation, mapsUrl: e.target.value});
                        parseMapsUrl(e.target.value);
                      }}
                      placeholder="Google Maps URL"
                      className="w-full p-1.5 text-xs border border-gray-300 rounded-lg focus:border-purple-500"
                    />
                  </div>
                </div>

                {/* Coordinates - SUPER COMPACT */}
                <div className="bg-blue-50 border border-blue-300 rounded-lg p-2">
                  <label className="block text-xs font-bold mb-1.5">ğŸ“ ×§×•××•×¨×“×™× ×˜×•×ª</label>
                  
                  {/* Lat/Lng Inputs */}
                  <div className="grid grid-cols-2 gap-1.5 mb-1.5">
                    <input
                      type="number"
                      step="0.000001"
                      value={newLocation.lat || ''}
                      onChange={(e) => setNewLocation({...newLocation, lat: parseFloat(e.target.value) || null})}
                      placeholder="Lat"
                      className="w-full p-1.5 text-xs border border-gray-300 rounded-lg"
                    />
                    <input
                      type="number"
                      step="0.000001"
                      value={newLocation.lng || ''}
                      onChange={(e) => setNewLocation({...newLocation, lng: parseFloat(e.target.value) || null})}
                      placeholder="Lng"
                      className="w-full p-1.5 text-xs border border-gray-300 rounded-lg"
                    />
                  </div>

                  {/* Calculate Buttons - Row with labels */}
                  <div className="grid grid-cols-5 gap-1">
                    <button
                      onClick={() => geocodeByName(newLocation.name)}
                      disabled={!newLocation.name?.trim()}
                      className={`p-1.5 rounded-lg text-[9px] font-bold flex flex-col items-center ${
                        newLocation.name?.trim()
                          ? 'bg-indigo-500 text-white hover:bg-indigo-600'
                          : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}
                      title="×—×¤×© ×œ×¤×™ ×©× ×”××§×•×"
                    >
                      <span className="text-sm">ğŸ”¤</span>
                      <span>×©×</span>
                    </button>
                    <button
                      onClick={() => geocodeAddress(newLocation.address)}
                      disabled={!newLocation.address?.trim()}
                      className={`p-1.5 rounded-lg text-[9px] font-bold flex flex-col items-center ${
                        newLocation.address?.trim()
                          ? 'bg-purple-500 text-white hover:bg-purple-600'
                          : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}
                      title="×—×¤×© ×œ×¤×™ ×›×ª×•×‘×ª"
                    >
                      <span className="text-sm">ğŸ </span>
                      <span>×›×ª×•×‘×ª</span>
                    </button>
                    <button
                      onClick={() => parseMapsUrl(newLocation.mapsUrl)}
                      disabled={!newLocation.mapsUrl?.trim()}
                      className={`p-1.5 rounded-lg text-[9px] font-bold flex flex-col items-center ${
                        newLocation.mapsUrl?.trim()
                          ? 'bg-blue-500 text-white hover:bg-blue-600'
                          : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}
                      title="×—×œ×¥ ××§×™×©×•×¨"
                    >
                      <span className="text-sm">ğŸ”—</span>
                      <span>×§×™×©×•×¨</span>
                    </button>
                    <button
                      onClick={getCurrentLocation}
                      className="p-1.5 rounded-lg text-[9px] font-bold bg-green-500 text-white hover:bg-green-600 flex flex-col items-center"
                      title="×”×©×ª××© ×‘-GPS"
                    >
                      <span className="text-sm">ğŸ“</span>
                      <span>××™×§×•×</span>
                    </button>
                  </div>
                </div>

                {/* Open in Google + Google Info */}
                <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-2">
                  <div className="flex gap-2">
                    {newLocation.lat && newLocation.lng ? (
                      <a
                        href={newLocation.address?.trim() 
                          ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(newLocation.address.trim())}`
                          : `https://www.google.com/maps/search/?api=1&query=${newLocation.lat},${newLocation.lng}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex-1 py-2 bg-green-500 text-white rounded-lg text-sm font-bold hover:bg-green-600 text-center"
                      >
                        ğŸ—ºï¸ ×¤×ª×— ×‘×’×•×’×œ
                      </a>
                    ) : (
                      <button disabled className="flex-1 py-2 bg-gray-300 text-gray-500 rounded-lg text-sm font-bold cursor-not-allowed">
                        ğŸ—ºï¸ ×¤×ª×— ×‘×’×•×’×œ (××™×Ÿ ×§×•××•×¨×“×™× ×˜×•×ª)
                      </button>
                    )}
                    <button
                      onClick={() => {
                        setGooglePlaceInfo(null);
                        fetchGooglePlaceInfo(newLocation);
                      }}
                      disabled={!newLocation.name?.trim() || loadingGoogleInfo}
                      className={`flex-1 py-2 rounded-lg text-sm font-bold ${
                        newLocation.name?.trim() && !loadingGoogleInfo
                          ? 'bg-indigo-500 text-white hover:bg-indigo-600'
                          : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}
                    >
                      {loadingGoogleInfo ? 'â³ ×˜×•×¢×Ÿ...' : 'ğŸ” ××™×“×¢ ××’×•×’×œ'}
                    </button>
                  </div>
                  
                  {/* Google Place Info Results */}
                  {googlePlaceInfo && !googlePlaceInfo.notFound && (
                    <div className="mt-2 text-xs space-y-1 bg-white rounded p-2 border border-indigo-200" style={{ direction: 'ltr' }}>
                      <div>
                        <span className="font-bold text-indigo-700">Found:</span>
                        <span className="ml-1">{googlePlaceInfo.name}</span>
                      </div>
                      <div>
                        <span className="font-bold text-indigo-700">Primary Type:</span>
                        <span className="ml-1 bg-indigo-200 px-2 py-0.5 rounded">
                          {googlePlaceInfo.primaryTypeDisplayName || googlePlaceInfo.primaryType || 'N/A'}
                        </span>
                      </div>
                      <div>
                        <span className="font-bold text-indigo-700">All Types:</span>
                        <div className="flex flex-wrap gap-1 mt-1">
                          {googlePlaceInfo.types.map((type, idx) => (
                            <span key={idx} className="bg-gray-200 px-2 py-0.5 rounded text-[10px]">{type}</span>
                          ))}
                        </div>
                      </div>
                      <div>
                        <span className="font-bold text-indigo-700">Rating:</span>
                        <span className="ml-1">â­ {googlePlaceInfo.rating?.toFixed(1) || 'N/A'} ({googlePlaceInfo.ratingCount || 0})</span>
                      </div>
                    </div>
                  )}
                  
                  {googlePlaceInfo && googlePlaceInfo.notFound && (
                    <div className="mt-2 text-xs text-red-600 bg-white rounded p-2 border border-red-200">
                      âŒ ×”××§×•× ×œ× × ××¦× ×‘-Google ×¢×‘×•×¨: "{googlePlaceInfo.searchQuery}"
                    </div>
                  )}
                </div>

                {/* Notes - Compact */}
                <div>
                  <label className="block text-xs font-bold mb-1">ğŸ’­ ×”×¢×¨×•×ª</label>
                  <textarea
                    value={newLocation.notes || ''}
                    onChange={(e) => setNewLocation({...newLocation, notes: e.target.value})}
                    placeholder="×”×¢×¨×•×ª..."
                    className="w-full p-2 text-xs border border-gray-300 rounded-lg focus:border-purple-500"
                    style={{ direction: 'rtl', minHeight: '50px' }}
                    rows="2"
                  />
                </div>

                {/* Status toggles */}
                <div className="flex gap-3 px-4 py-2 bg-gray-50 border-t border-gray-100">
                  <label className="flex items-center gap-1.5 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={newLocation.inProgress || false}
                      onChange={(e) => setNewLocation({...newLocation, inProgress: e.target.checked})}
                      className="rounded"
                    />
                    <span className="text-xs">ğŸ› ï¸ ×‘×¢×‘×•×“×”</span>
                  </label>
                  {isUnlocked && (
                    <label className="flex items-center gap-1.5 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={newLocation.locked || false}
                        onChange={(e) => setNewLocation({...newLocation, locked: e.target.checked})}
                        className="rounded"
                      />
                      <span className="text-xs">ğŸ”’ × ×¢×•×œ</span>
                    </label>
                  )}
                </div>

                {/* Actions: Skip permanently + Delete (edit mode only) */}
                {showEditLocationDialog && editingLocation && (
                  <div className="border-t border-red-200 bg-red-50 px-4 py-2">
                    {!(editingLocation.locked && !isUnlocked) && (
                      <div className="flex gap-2">
                        {editingLocation.status === 'blacklist' ? (
                          <button
                            onClick={() => {
                              // Restore and mark as inProgress
                              const loc = customLocations.find(l => l.id === editingLocation.id);
                              if (loc && isFirebaseAvailable && database) {
                                database.ref(`customLocations/${loc.firebaseId || loc.id}`).update({ inProgress: true });
                              }
                              toggleLocationStatus(editingLocation.id);
                              setShowEditLocationDialog(false);
                              setEditingLocation(null);
                            }}
                            className="flex-1 py-2 bg-green-500 text-white rounded-lg text-sm font-bold hover:bg-green-600"
                          >
                            âœ… ×”×—×–×¨ ×›××§×•× ×¤×¢×™×œ
                          </button>
                        ) : (
                          <button
                            onClick={() => {
                              toggleLocationStatus(editingLocation.id);
                              setShowEditLocationDialog(false);
                              setEditingLocation(null);
                            }}
                            className="flex-1 py-2 bg-orange-500 text-white rounded-lg text-sm font-bold hover:bg-orange-600"
                          >
                            ğŸš« ×“×œ×’ ×œ×¦××™×ª×•×ª
                          </button>
                        )}
                        <button
                          onClick={() => {
                            showConfirm(`×œ××—×•×§ ××ª "${editingLocation.name}"?`, () => {
                              deleteCustomLocation(editingLocation.id);
                              setShowEditLocationDialog(false);
                              setEditingLocation(null);
                            });
                          }}
                          className="flex-1 py-2 bg-red-600 text-white rounded-lg text-sm font-bold hover:bg-red-700"
                        >
                          ğŸ—‘ï¸ ××—×§ ××§×•×
                        </button>
                      </div>
                    )}
                    {editingLocation.locked && !isUnlocked && (
                      <div className="text-center text-xs text-yellow-700">ğŸ”’ ××§×•× × ×¢×•×œ - ×¤×¢×•×œ×•×ª ×—×¡×•××•×ª</div>
                    )}
                  </div>
                )}

              </div>
              
              {/* Footer - Compact */}
              {(() => {
                const isLockedPlace = showEditLocationDialog && editingLocation?.locked && !isUnlocked;
                return (
              <div className="px-4 py-2.5 border-t border-gray-200 flex gap-2" style={{ direction: 'rtl' }}>
                {isLockedPlace ? (
                  <div className="flex-1 py-2.5 bg-yellow-100 text-yellow-800 rounded-lg text-sm font-bold text-center">
                    ğŸ”’ ××§×•× × ×¢×•×œ - ×¦×¤×™×™×” ×‘×œ×‘×“
                  </div>
                ) : (
                <button
                  onClick={() => {
                    if (!newLocation.name || !newLocation.name.trim()) {
                      showToast('×× × ×”×–×Ÿ ×©× ×œ××§×•×', 'warning');
                      return;
                    }
                    if (!newLocation.interests || newLocation.interests.length === 0) {
                      showToast('×× × ×‘×—×¨ ×œ×¤×—×•×ª ×ª×—×•× ×¢× ×™×™×Ÿ ××—×“', 'warning');
                      return;
                    }
                    const exists = customLocations.find(loc => 
                      loc.name.toLowerCase() === newLocation.name.trim().toLowerCase() &&
                      (!editingLocation || loc.id !== editingLocation.id)
                    );
                    if (exists) {
                      showToast('××§×•× ×¢× ×©× ×–×” ×›×‘×¨ ×§×™×™×', 'error');
                      return;
                    }
                    if (showEditLocationDialog) {
                      updateCustomLocation(false);
                    } else {
                      addCustomLocation(false);
                    }
                  }}
                  disabled={!newLocation.name?.trim()}
                  className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${
                    newLocation.name?.trim()
                      ? 'bg-purple-500 text-white hover:bg-purple-600'
                      : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`}
                >
                  {showEditLocationDialog ? 'ğŸ’¾ ×¢×“×›×Ÿ' : 'â• ×”×•×¡×£'}
                </button>
                )}
                <button
                  onClick={() => {
                    // Save if there's valid content, then close
                    if (newLocation.name?.trim() && newLocation.interests?.length > 0) {
                      const exists = customLocations.find(loc => 
                        loc.name.toLowerCase() === newLocation.name.trim().toLowerCase() &&
                        (!editingLocation || loc.id !== editingLocation.id)
                      );
                      if (!exists) {
                        if (showEditLocationDialog) {
                          updateCustomLocation(true); // Save and close
                        } else {
                          addCustomLocation(true); // Save and close
                        }
                        return;
                      }
                    }
                    // Just close if nothing to save or invalid
                    setShowAddLocationDialog(false);
                    setShowEditLocationDialog(false);
                    setEditingLocation(null);
                    setNewLocation({ 
                      name: '', description: '', notes: '', area: formData.area, interests: [], 
                      lat: null, lng: null, mapsUrl: '', address: '', uploadedImage: null, imageUrls: [], inProgress: true
                    });
                  }}
                  className="px-5 py-2.5 rounded-lg bg-green-500 text-white text-sm font-bold hover:bg-green-600"
                >
                  âœ“ ×¡×’×•×¨
                </button>
              </div>
                );
              })()}

            </div>
          </div>
        )}

        {/* Unified Interest Dialog - Add / Edit / Config */}
        {showAddInterestDialog && (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-2">
            <div className="bg-white rounded-xl w-full max-w-md max-h-[90vh] flex flex-col shadow-2xl">
              
              {/* Header */}
              <div className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2.5 rounded-t-xl flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <h3 className="text-base font-bold">{editingCustomInterest ? `${newInterest.icon?.startsWith?.('data:') ? '' : newInterest.icon} ${newInterest.label}` : '×”×•×¡×£ ×ª×—×•× ×¢× ×™×™×Ÿ'}</h3>
                  {editingCustomInterest && (
                    <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold ${newInterest.builtIn ? 'bg-blue-200 text-blue-800' : 'bg-purple-200 text-purple-800'}`}>
                      {newInterest.builtIn ? 'ğŸ—ï¸ ××¢×¨×›×ª' : 'ğŸ‘¤ ××™×©×™'}
                    </span>
                  )}
                  {!editingCustomInterest && (
                    <span className="text-[10px] bg-purple-200 text-purple-800 px-2 py-0.5 rounded-full font-bold">ğŸ‘¤ ××™×©×™</span>
                  )}
                  <button
                    onClick={() => showHelpFor('addInterest')}
                    className="bg-white text-purple-600 hover:bg-purple-100 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold shadow"
                    title="×¢×–×¨×”"
                  >?</button>
                </div>
                <button
                  onClick={() => {
                    setShowAddInterestDialog(false);
                    setNewInterest({ label: '', icon: 'ğŸ“', searchMode: 'types', types: '', textSearch: '', blacklist: '', inProgress: false, locked: false });
                    setEditingCustomInterest(null);
                  }}
                  className="text-xl hover:bg-white hover:bg-opacity-20 rounded-full w-7 h-7 flex items-center justify-center"
                >âœ•</button>
              </div>
              
              {/* Content */}
              <div className="flex-1 overflow-y-auto px-4 py-3 space-y-3">
                {/* Name + Icon row */}
                <div className="grid grid-cols-4 gap-2">
                  <div className="col-span-3">
                    <label className="block text-xs font-bold mb-1">×©× ×”×ª×—×•× <span className="text-red-500">*</span></label>
                    <input
                      type="text"
                      value={newInterest.label}
                      onChange={(e) => setNewInterest({...newInterest, label: e.target.value})}
                      placeholder="×œ×“×•×’××”: ×‘×ª×™ ×§×•×œ× ×•×¢"
                      className="w-full p-2 text-sm border-2 border-purple-300 rounded-lg focus:border-purple-500"
                      style={{ direction: 'rtl' }}
                      disabled={newInterest.builtIn}
                      autoFocus={!newInterest.builtIn}
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-bold mb-1">××™×™×§×•×Ÿ</label>
                    {newInterest.icon && newInterest.icon.startsWith('data:') ? (
                      <div className="relative">
                        <img src={newInterest.icon} alt="icon" className="w-full h-10 object-contain rounded-lg border-2 border-gray-300 bg-white" />
                        <button
                          onClick={() => setNewInterest({...newInterest, icon: 'ğŸ“'})}
                          className="absolute top-0 right-0 bg-red-500 text-white rounded-full w-4 h-4 text-[9px] font-bold"
                        >âœ•</button>
                      </div>
                    ) : (
                      <input
                        type="text"
                        value={newInterest.icon}
                        onChange={(e) => {
                          const firstEmoji = [...e.target.value][0] || '';
                          setNewInterest({...newInterest, icon: firstEmoji});
                        }}
                        placeholder="ğŸ“"
                        className="w-full p-2 text-xl border-2 border-gray-300 rounded-lg text-center"
                        disabled={newInterest.builtIn}
                      />
                    )}
                    {!newInterest.builtIn && (
                      <label className="block w-full mt-1 p-1 border border-dashed border-gray-300 rounded text-center cursor-pointer hover:bg-gray-50 text-[9px] text-gray-500">
                        ğŸ“ ×§×•×‘×¥
                        <input
                          type="file"
                          accept="image/*"
                          onChange={(e) => {
                            const file = e.target.files?.[0];
                            if (file) {
                              const reader = new FileReader();
                              reader.onload = () => setNewInterest({...newInterest, icon: reader.result});
                              reader.readAsDataURL(file);
                            }
                          }}
                          className="hidden"
                        />
                      </label>
                    )}
                  </div>
                </div>

                {/* Search Configuration */}
                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3">
                  <label className="block text-xs font-bold mb-2 text-blue-800">ğŸ” ×”×’×“×¨×•×ª ×—×™×¤×•×©</label>
                  
                  <div className="mb-2">
                    <label className="block text-[10px] text-gray-600 mb-1" style={{ direction: 'ltr' }}>Search Mode:</label>
                    <select
                      value={newInterest.searchMode || 'types'}
                      onChange={(e) => setNewInterest({...newInterest, searchMode: e.target.value})}
                      className="w-full p-1.5 text-sm border rounded"
                      style={{ direction: 'ltr' }}
                    >
                      <option value="types">Category Search (types)</option>
                      <option value="text">Text Search (query)</option>
                    </select>
                  </div>
                  
                  {newInterest.searchMode === 'text' ? (
                    <div className="mb-2">
                      <label className="block text-[10px] text-gray-600 mb-1" style={{ direction: 'ltr' }}>Text Query:</label>
                      <input
                        type="text"
                        value={newInterest.textSearch || ''}
                        onChange={(e) => setNewInterest({...newInterest, textSearch: e.target.value})}
                        placeholder="e.g., street art"
                        className="w-full p-1.5 text-sm border rounded"
                        style={{ direction: 'ltr' }}
                      />
                      <p className="text-[9px] text-gray-500 mt-0.5" style={{ direction: 'ltr' }}>
                        Searches: "[query] [area] Bangkok"
                      </p>
                    </div>
                  ) : (
                    <div className="mb-2">
                      <label className="block text-[10px] text-gray-600 mb-1" style={{ direction: 'ltr' }}>Place Types (comma separated):</label>
                      <input
                        type="text"
                        value={newInterest.types || ''}
                        onChange={(e) => setNewInterest({...newInterest, types: e.target.value})}
                        placeholder="e.g., movie_theater, museum"
                        className="w-full p-1.5 text-sm border rounded"
                        style={{ direction: 'ltr' }}
                      />
                      <p className="text-[9px] text-gray-500 mt-0.5" style={{ direction: 'ltr' }}>
                        <a href="https://developers.google.com/maps/documentation/places/web-service/place-types" target="_blank" className="text-blue-500 underline">See types list</a>
                      </p>
                    </div>
                  )}
                  
                  <div>
                    <label className="block text-[10px] text-gray-600 mb-1" style={{ direction: 'ltr' }}>Blacklist Words (comma separated):</label>
                    <input
                      type="text"
                      value={newInterest.blacklist || ''}
                      onChange={(e) => setNewInterest({...newInterest, blacklist: e.target.value})}
                      placeholder="e.g., cannabis, massage"
                      className="w-full p-1.5 text-sm border rounded"
                      style={{ direction: 'ltr' }}
                    />
                  </div>
                </div>

                {/* Status toggles */}
                <div className="flex gap-3 px-4 py-2 bg-gray-50 border-t border-gray-100">
                  <label className="flex items-center gap-1.5 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={newInterest.inProgress || false}
                      onChange={(e) => setNewInterest({...newInterest, inProgress: e.target.checked})}
                      className="rounded"
                    />
                    <span className="text-xs">ğŸ› ï¸ ×‘×¢×‘×•×“×”</span>
                  </label>
                  {isUnlocked && (
                    <label className="flex items-center gap-1.5 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={newInterest.locked || false}
                        onChange={(e) => setNewInterest({...newInterest, locked: e.target.checked})}
                        className="rounded"
                      />
                      <span className="text-xs">ğŸ”’ × ×¢×•×œ</span>
                    </label>
                  )}
                </div>

                {/* Actions: Enable/Disable + Delete (edit mode only) */}
                {editingCustomInterest && (
                  <div className="border-t border-red-200 bg-red-50 px-4 py-2">
                    {!(editingCustomInterest.locked && !isUnlocked) ? (
                      <div className="flex gap-2">
                        <button
                          onClick={() => {
                            toggleInterestStatus(editingCustomInterest.id);
                            setShowAddInterestDialog(false);
                            setEditingCustomInterest(null);
                          }}
                          className={`flex-1 py-2 rounded-lg text-sm font-bold ${
                            interestStatus[editingCustomInterest.id] === false 
                              ? 'bg-green-500 text-white hover:bg-green-600'
                              : 'bg-orange-500 text-white hover:bg-orange-600'
                          }`}
                        >
                          {interestStatus[editingCustomInterest.id] === false ? 'âœ… ×”×¤×¢×œ' : 'â¸ï¸ ×”×©×‘×ª'}
                        </button>
                        {(!newInterest.builtIn || isUnlocked) && (
                          <button
                            onClick={() => {
                              const msg = newInterest.builtIn 
                                ? `âš ï¸ ××ª×” ×¢×•××“ ×œ××—×•×§ ×ª×—×•× ××¢×¨×›×ª "${newInterest.label}". ×¤×¢×•×œ×” ×–×• ×ª×¡×™×¨ ××•×ª×• ×œ×¦××™×ª×•×ª. ×œ×”××©×™×š?`
                                : `××ª×” ×¢×•××“ ×œ××—×•×§ ×ª×—×•× ××™×©×™ "${newInterest.label}". ×œ×”××©×™×š?`;
                              showConfirm(msg, () => {
                                if (newInterest.builtIn) {
                                  // For built-in: toggle off + remove config
                                  toggleInterestStatus(editingCustomInterest.id);
                                  if (isFirebaseAvailable && database) {
                                    database.ref(`settings/interestConfig/${editingCustomInterest.id}`).remove();
                                  }
                                  showToast('×ª×—×•× ××¢×¨×›×ª ×”×•×¡×¨', 'success');
                                } else {
                                  deleteCustomInterest(editingCustomInterest.id);
                                }
                                setShowAddInterestDialog(false);
                                setEditingCustomInterest(null);
                              });
                            }}
                            className="flex-1 py-2 bg-red-600 text-white rounded-lg text-sm font-bold hover:bg-red-700"
                          >
                            ğŸ—‘ï¸ ××—×§ ×ª×—×•×
                          </button>
                        )}
                      </div>
                    ) : (
                      <div className="text-center text-xs text-yellow-700">ğŸ”’ ×ª×—×•× × ×¢×•×œ - ×¤×¢×•×œ×•×ª ×—×¡×•××•×ª</div>
                    )}
                  </div>
                )}
              </div>
              
              {/* Footer */}
              <div className="px-4 py-2.5 border-t border-gray-200 flex gap-2" style={{ direction: 'rtl' }}>
                {(() => {
                  const isLockedInterest = editingCustomInterest?.locked && !isUnlocked;
                  return isLockedInterest ? (
                    <div className="flex-1 py-2.5 bg-yellow-100 text-yellow-800 rounded-lg text-sm font-bold text-center">
                      ğŸ”’ ×ª×—×•× × ×¢×•×œ - ×¦×¤×™×™×” ×‘×œ×‘×“
                    </div>
                  ) : (
                    <button
                      onClick={() => {
                        if (!newInterest.label.trim()) return;
                        
                        const searchConfig = {};
                        if (newInterest.searchMode === 'text' && newInterest.textSearch) {
                          searchConfig.textSearch = newInterest.textSearch.trim();
                        } else if (newInterest.types) {
                          searchConfig.types = newInterest.types.split(',').map(t => t.trim()).filter(t => t);
                        }
                        if (newInterest.blacklist) {
                          searchConfig.blacklist = newInterest.blacklist.split(',').map(t => t.trim().toLowerCase()).filter(t => t);
                        }
                        
                        if (editingCustomInterest) {
                          // EDIT MODE
                          const interestId = editingCustomInterest.id;
                          
                          if (!newInterest.builtIn) {
                            // Custom interest - update name/icon too
                            const updatedInterest = {
                              ...editingCustomInterest,
                              label: newInterest.label.trim(),
                              name: newInterest.label.trim(),
                              icon: newInterest.icon || 'ğŸ“',
                              inProgress: newInterest.inProgress || false,
                              locked: newInterest.locked || false
                            };
                            delete updatedInterest.builtIn;
                            
                            if (isFirebaseAvailable && database) {
                              database.ref(`customInterests/${editingCustomInterest.firebaseId || interestId}`).update(updatedInterest);
                              if (Object.keys(searchConfig).length > 0) {
                                database.ref(`settings/interestConfig/${interestId}`).set(searchConfig);
                              }
                            } else {
                              const updated = customInterests.map(ci => ci.id === interestId ? updatedInterest : ci);
                              setCustomInterests(updated);
                              localStorage.setItem('bangkok_custom_interests', JSON.stringify(updated));
                            }
                          } else {
                            // Built-in interest - save search config only
                            if (isFirebaseAvailable && database) {
                              database.ref(`settings/interestConfig/${interestId}`).set(searchConfig);
                            } else {
                              setInterestConfig(prev => ({...prev, [interestId]: searchConfig}));
                            }
                          }
                          
                          showToast('×”×ª×—×•× ×¢×•×“×›×Ÿ!', 'success');
                        } else {
                          // ADD MODE
                          const interestId = 'custom_' + Date.now();
                          const newInterestData = {
                            id: interestId,
                            label: newInterest.label.trim(),
                            name: newInterest.label.trim(),
                            icon: newInterest.icon || 'ğŸ“',
                            inProgress: newInterest.inProgress || false,
                            locked: newInterest.locked || false
                          };
                          
                          if (isFirebaseAvailable && database) {
                            database.ref(`customInterests/${interestId}`).set(newInterestData);
                            if (Object.keys(searchConfig).length > 0) {
                              database.ref(`settings/interestConfig/${interestId}`).set(searchConfig);
                            }
                          } else {
                            const updated = [...customInterests, newInterestData];
                            setCustomInterests(updated);
                            localStorage.setItem('bangkok_custom_interests', JSON.stringify(updated));
                          }
                          
                          showToast('×”×ª×—×•× × ×•×¡×£!', 'success');
                        }
                        
                        setShowAddInterestDialog(false);
                        setNewInterest({ label: '', icon: 'ğŸ“', searchMode: 'types', types: '', textSearch: '', blacklist: '', inProgress: false, locked: false });
                        setEditingCustomInterest(null);
                      }}
                      disabled={!newInterest.label?.trim()}
                      className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${
                        newInterest.label?.trim()
                          ? 'bg-purple-500 text-white hover:bg-purple-600'
                          : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}
                    >
                      {editingCustomInterest ? 'ğŸ’¾ ×©××•×¨' : 'â• ×”×•×¡×£'}
                    </button>
                  );
                })()}
                <button
                  onClick={() => {
                    setShowAddInterestDialog(false);
                    setNewInterest({ label: '', icon: 'ğŸ“', searchMode: 'types', types: '', textSearch: '', blacklist: '', inProgress: false, locked: false });
                    setEditingCustomInterest(null);
                  }}
                  className="px-5 py-2.5 rounded-lg bg-green-500 text-white text-sm font-bold hover:bg-green-600"
                >
                  âœ“ ×¡×’×•×¨
                </button>
              </div>

            </div>
          </div>
        )}

            {/* Access Log Dialog */}
      {showAccessLog && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="p-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50">
              <h2 className="text-xl font-bold text-gray-800">ğŸ”’ ×œ×•×’ ×›× ×™×¡×•×ª</h2>
              <button
                onClick={() => setShowAccessLog(false)}
                className="text-2xl font-bold text-gray-600 hover:text-gray-800"
              >
                âœ•
              </button>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4">
              {accessLogs.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  <p className="text-4xl mb-2">ğŸ“­</p>
                  <p>××™×Ÿ ×›× ×™×¡×•×ª ×¢×“×™×™×Ÿ</p>
                </div>
              ) : (
                <div className="space-y-2">
                  {accessLogs.map((log, index) => {
                    const date = new Date(log.timestamp);
                    const isNew = log.timestamp > parseInt(localStorage.getItem('bangkok_last_seen') || '0');
                    
                    return (
                      <div
                        key={log.id}
                        className={`p-3 rounded-lg border-2 ${
                          isNew ? 'border-red-400 bg-red-50' : 'border-gray-200 bg-gray-50'
                        }`}
                      >
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 flex-wrap">
                              {isNew && <span className="text-red-500 font-bold">ğŸ†•</span>}
                              <span className="font-bold text-sm">
                                ××©×ª××© #{log.userId.slice(-8)}
                              </span>
                              {log.country && (
                                <span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-bold">
                                  {log.countryCode === 'IL' ? 'ğŸ‡®ğŸ‡±' : log.countryCode === 'TH' ? 'ğŸ‡¹ğŸ‡­' : 'ğŸŒ'} {log.country}
                                </span>
                              )}
                            </div>
                            {(log.city || log.region) && (
                              <div className="text-xs text-indigo-600 mt-1 font-medium">
                                ğŸ“ {[log.city, log.region].filter(Boolean).join(', ')}
                              </div>
                            )}
                            <div className="text-xs text-gray-600 mt-1">
                              ğŸ“… {date.toLocaleDateString('he-IL', { 
                                day: '2-digit', 
                                month: '2-digit', 
                                year: 'numeric' 
                              })}
                              {' '}
                              ğŸ• {date.toLocaleTimeString('he-IL', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                              })}
                            </div>
                            <div className="flex items-center gap-2 mt-1 flex-wrap">
                              {log.browser && (
                                <span className="text-[10px] bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded">
                                  ğŸŒ {log.browser}
                                </span>
                              )}
                              {log.os && (
                                <span className="text-[10px] bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded">
                                  {log.os === 'iPhone' || log.os === 'iPad' || log.os === 'Android' ? 'ğŸ“±' : 'ğŸ’»'} {log.os}
                                </span>
                              )}
                              {log.screenSize && (
                                <span className="text-[10px] bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded">
                                  ğŸ“ {log.screenSize}
                                </span>
                              )}
                              {log.language && (
                                <span className="text-[10px] bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded">
                                  ğŸ—£ï¸ {log.language}
                                </span>
                              )}
                            </div>
                            {(log.isp || log.ip) && (
                              <div className="text-[10px] text-gray-400 mt-1">
                                {log.isp && <span>ğŸ¢ {log.isp}</span>}
                                {log.ip && <span className="mr-2">  IP: {log.ip}</span>}
                              </div>
                            )}
                            {!log.country && log.userAgent && (
                              <div className="text-[10px] text-gray-400 mt-1 truncate">
                                {log.userAgent}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
            
            <div className="p-4 border-t border-gray-200 bg-gray-50">
              <div className="flex items-center justify-between">
                <div className="text-xs text-gray-600">
                  ×¡×”"×› {accessLogs.length} ×›× ×™×¡×•×ª
                  {hasNewEntries && (
                    <span className="text-red-600 font-bold mr-2">
                      â€¢ ×™×© ×›× ×™×¡×•×ª ×—×“×©×•×ª ×©×œ× × ×¦×¤×•
                    </span>
                  )}
                </div>
                {accessLogs.length > 0 && (
                  <button
                    onClick={() => {
                      showConfirm('×œ××—×•×§ ××ª ×›×œ ×œ×•×’ ×”×›× ×™×¡×•×ª? ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”.', () => {
                        if (isFirebaseAvailable && database) {
                          database.ref('accessLog').remove()
                            .then(() => {
                              setAccessLogs([]);
                              setHasNewEntries(false);
                              localStorage.setItem('bangkok_last_seen', Date.now().toString());
                              showToast('×”×œ×•×’ × ×•×§×”', 'success');
                            })
                            .catch(err => {
                              console.error('[ACCESS LOG] Clear error:', err);
                              showToast('×©×’×™××” ×‘× ×™×§×•×™ ×”×œ×•×’', 'error');
                            });
                        }
                      });
                    }}
                    className="text-xs px-3 py-1.5 rounded-lg bg-red-500 text-white font-bold hover:bg-red-600 transition"
                  >
                    ğŸ—‘ï¸ × ×§×” ×œ×•×’
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Route Dialog */}
      {showRouteDialog && editingRoute && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-2">
          <div className="bg-white rounded-xl w-full max-w-md max-h-[90vh] flex flex-col shadow-2xl">
            
            {/* Header */}
            <div className="bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-4 py-2.5 rounded-t-xl flex items-center justify-between">
              <div className="flex items-center gap-2">
                <h3 className="text-base font-bold">{routeDialogMode === 'add' ? 'ğŸ—ºï¸ ×”×•×¡×£ ××¡×œ×•×œ ×©××•×¨' : 'ğŸ—ºï¸ ×¢×¨×•×š ××¡×œ×•×œ ×©××•×¨'}</h3>
              </div>
              <button
                onClick={() => { setShowRouteDialog(false); setEditingRoute(null); }}
                className="text-xl hover:bg-white hover:bg-opacity-20 rounded-full w-7 h-7 flex items-center justify-center"
              >âœ•</button>
            </div>
            
            {/* Content */}
            <div className="flex-1 overflow-y-auto px-4 py-3 space-y-3">
              {/* Route info */}
              <div className="bg-blue-50 rounded-lg p-3 space-y-1.5">
                {/* Area */}
                <div className="text-xs text-gray-700">
                  <span className="font-bold">ğŸ“ ××™×–×•×¨:</span> {editingRoute.areaName || '×œ×œ× ××™×–×•×¨'}
                </div>
                {/* Interests */}
                {(() => {
                  const ids = [...new Set((editingRoute.stops || []).flatMap(s => s.interests || []))];
                  return ids.length > 0 && (
                    <div className="flex gap-1 flex-wrap items-center">
                      <span className="text-xs font-bold text-gray-700">ğŸ·ï¸ ×ª×—×•××™×:</span>
                      {ids.map((intId, idx) => {
                        const obj = allInterestOptions.find(o => o.id === intId);
                        return obj ? (
                          <span key={idx} className="text-[10px] bg-white px-1.5 py-0.5 rounded" title={obj.label}>
                            {obj.icon} {obj.label}
                          </span>
                        ) : null;
                      })}
                    </div>
                  );
                })()}
                {/* Circular / Linear */}
                <div className="text-xs text-gray-700">
                  <span className="font-bold">ğŸ”€ ×¡×•×’:</span> {editingRoute.circular ? 'ğŸ”„ ××¢×’×œ×™' : 'â¡ï¸ ×œ×™× ×™××¨×™'}
                </div>
                {/* Start point */}
                <div className="text-xs text-gray-700">
                  <span className="font-bold">ğŸš© × ×§×•×“×ª ×”×ª×—×œ×”:</span> {editingRoute.startPoint || editingRoute.startPointCoords?.address || '×”××§×•× ×”×¨××©×•×Ÿ ×‘×¨×©×™××”'}
                </div>
              </div>

              {/* Name */}
              <div>
                <label className="block text-xs font-bold mb-1">×©× ×”××¡×œ×•×œ</label>
                <input
                  type="text"
                  value={editingRoute.name || ''}
                  onChange={(e) => setEditingRoute({...editingRoute, name: e.target.value})}
                  className="w-full p-2 text-sm border-2 border-blue-300 rounded-lg"
                  style={{ direction: 'rtl' }}
                  disabled={editingRoute.locked && !isUnlocked}
                />
              </div>

              {/* Notes */}
              <div>
                <label className="block text-xs font-bold mb-1">ğŸ’¬ ×”×¢×¨×•×ª</label>
                <textarea
                  value={editingRoute.notes || ''}
                  onChange={(e) => setEditingRoute({...editingRoute, notes: e.target.value})}
                  placeholder="×”×¢×¨×•×ª..."
                  className="w-full p-2 text-sm border-2 border-gray-300 rounded-lg h-16 resize-none"
                  style={{ direction: 'rtl' }}
                  disabled={editingRoute.locked && !isUnlocked}
                />
              </div>

              {/* Stops list */}
              <div>
                <label className="block text-xs font-bold mb-1">×ª×—× ×•×ª ({editingRoute.stops?.length || 0})</label>
                <div className="max-h-32 overflow-y-auto space-y-0.5">
                  {(editingRoute.stops || []).map((stop, idx) => (
                    <div key={idx} className="flex items-center gap-1 text-xs bg-gray-50 px-2 py-1 rounded">
                      <span className="text-gray-400">{idx + 1}.</span>
                      <span className="font-medium truncate">{stop.name}</span>
                      {stop.rating && <span className="text-yellow-600">â­{stop.rating}</span>}
                    </div>
                  ))}
                </div>
              </div>

              {/* Share buttons */}
              <div className="flex gap-2">
                <button
                  onClick={() => {
                    const shareText = `ğŸ—ºï¸ ${editingRoute.name}\nğŸ“ ${editingRoute.areaName}\nğŸ¯ ${editingRoute.stops?.length || 0} ×ª×—× ×•×ª\n${editingRoute.circular ? 'ğŸ”„ ××¡×œ×•×œ ××¢×’×œ×™' : 'â¡ï¸ ××¡×œ×•×œ ×œ×™× ×™××¨×™'}\n\n×ª×—× ×•×ª:\n${(editingRoute.stops || []).map((s, i) => `${i+1}. ${s.name}${s.address ? ' - ' + s.address : ''}`).join('\n')}`;
                    if (navigator.share) {
                      navigator.share({ title: editingRoute.name, text: shareText });
                    } else {
                      navigator.clipboard.writeText(shareText);
                      showToast('××¡×œ×•×œ ×”×•×¢×ª×§ ×œ×œ×•×—', 'success');
                    }
                  }}
                  className="flex-1 py-2 bg-green-500 text-white rounded-lg text-sm font-bold hover:bg-green-600"
                >
                  ğŸ“¤ ×©×ª×£ ××¡×œ×•×œ
                </button>
                <button
                  onClick={() => {
                    const pois = (editingRoute.stops || []).map((s, i) => {
                      let line = `${i+1}. ${s.name}`;
                      if (s.address) line += `\n   ğŸ“ ${s.address}`;
                      if (s.description) line += `\n   ${s.description}`;
                      if (s.todayHours) line += `\n   ğŸ• ${s.todayHours}`;
                      if (s.rating) line += `\n   â­ ${s.rating}`;
                      const mapsUrl = s.address ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.address)}` : (s.lat && s.lng ? `https://www.google.com/maps?q=${s.lat},${s.lng}` : '');
                      if (mapsUrl) line += `\n   ğŸ—ºï¸ ${mapsUrl}`;
                      return line;
                    }).join('\n\n');
                    const text = `ğŸ“ × ×§×•×“×•×ª ×¢× ×™×™×Ÿ - ${editingRoute.name}\n${'â”€'.repeat(30)}\n\n${pois}`;
                    if (navigator.share) {
                      navigator.share({ title: `× ×§×•×“×•×ª ×¢× ×™×™×Ÿ - ${editingRoute.name}`, text });
                    } else {
                      navigator.clipboard.writeText(text);
                      showToast('× ×§×•×“×•×ª ×”×¢× ×™×™×Ÿ ×”×•×¢×ª×§×• ×œ×œ×•×—', 'success');
                    }
                  }}
                  className="flex-1 py-2 bg-indigo-500 text-white rounded-lg text-sm font-bold hover:bg-indigo-600"
                >
                  ğŸ“‹ ×©×ª×£ × ×§×•×“×•×ª ×¢× ×™×™×Ÿ
                </button>
              </div>

              {/* Status toggles */}
              <div className="flex gap-3 px-4 py-2 bg-gray-50 border-t border-gray-100">
                <label className="flex items-center gap-1.5 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={editingRoute.inProgress || false}
                    onChange={(e) => setEditingRoute({...editingRoute, inProgress: e.target.checked})}
                    className="rounded"
                    disabled={editingRoute.locked && !isUnlocked}
                  />
                  <span className="text-xs">ğŸ› ï¸ ×‘×¢×‘×•×“×”</span>
                </label>
                {isUnlocked && (
                  <label className="flex items-center gap-1.5 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={editingRoute.locked || false}
                      onChange={(e) => setEditingRoute({...editingRoute, locked: e.target.checked})}
                      className="rounded"
                    />
                    <span className="text-xs">ğŸ”’ × ×¢×•×œ</span>
                  </label>
                )}
              </div>

              {/* Actions: Delete */}
              <div className="border-t border-red-200 bg-red-50 px-4 py-2">
                {!(editingRoute.locked && !isUnlocked) ? (
                  <div className="flex gap-2">
                    <button
                      onClick={() => {
                        showConfirm(`×œ××—×•×§ ××ª ×”××¡×œ×•×œ "${editingRoute.name}"?`, () => {
                          deleteRoute(editingRoute.id);
                          setShowRouteDialog(false);
                          setEditingRoute(null);
                        });
                      }}
                      className="flex-1 py-2 bg-red-600 text-white rounded-lg text-sm font-bold hover:bg-red-700"
                    >
                      ğŸ—‘ï¸ ××—×§ ××¡×œ×•×œ
                    </button>
                  </div>
                ) : (
                  <div className="text-center text-xs text-yellow-700">ğŸ”’ ××¡×œ×•×œ × ×¢×•×œ - ×¤×¢×•×œ×•×ª ×—×¡×•××•×ª</div>
                )}
              </div>
            </div>
            
            {/* Footer */}
            <div className="px-4 py-2.5 border-t border-gray-200 flex gap-2" style={{ direction: 'rtl' }}>
              {(() => {
                const isLockedRoute = editingRoute.locked && !isUnlocked;
                return (
                  <>
                    {isLockedRoute ? (
                      <div className="flex-1 py-2.5 bg-yellow-100 text-yellow-800 rounded-lg text-sm font-bold text-center">
                        ğŸ”’ ××¡×œ×•×œ × ×¢×•×œ - ×¦×¤×™×™×” ×‘×œ×‘×“
                      </div>
                    ) : (
                      <>
                        <button
                          onClick={() => {
                            updateRoute(editingRoute.id, {
                              name: editingRoute.name,
                              notes: editingRoute.notes,
                              inProgress: editingRoute.inProgress,
                              locked: editingRoute.locked
                            });
                            setShowRouteDialog(false);
                            setEditingRoute(null);
                          }}
                          className="flex-1 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-bold hover:bg-blue-600"
                        >
                          ğŸ’¾ ×¢×“×›×Ÿ
                        </button>
                        <button
                          onClick={() => {
                            loadSavedRoute(editingRoute);
                            setShowRouteDialog(false);
                            setEditingRoute(null);
                          }}
                          className="flex-1 py-2.5 bg-orange-500 text-white rounded-lg text-sm font-bold hover:bg-orange-600"
                        >
                          ğŸ“ ×¤×ª×— ××¡×œ×•×œ
                        </button>
                      </>
                    )}
                    <button
                      onClick={() => { setShowRouteDialog(false); setEditingRoute(null); }}
                      className="px-5 py-2.5 rounded-lg bg-green-500 text-white text-sm font-bold hover:bg-green-600"
                    >
                      âœ“ ×¡×’×•×¨
                    </button>
                  </>
                );
              })()}
            </div>
          </div>
        </div>
      )}

      {/* Image Modal */}
      {showImageModal && modalImage && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-80 z-[100] flex items-center justify-center p-4"
          onClick={() => { setShowImageModal(false); setModalImage(null); }}
        >
          <img src={modalImage} alt="enlarged" className="max-w-full max-h-full rounded-lg shadow-2xl" />
        </div>
      )}

      {/* Help Dialog */}
      {showHelp && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4">
          <div className="bg-white rounded-xl max-w-md w-full max-h-[80vh] overflow-hidden flex flex-col shadow-2xl">
            <div className="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-4 py-3 flex items-center justify-between">
              <h3 className="text-base font-bold flex items-center gap-2">
                <span>â“</span>
                {helpContent[helpContext]?.title || '×¢×–×¨×”'}
              </h3>
              <button
                onClick={() => setShowHelp(false)}
                className="text-xl hover:bg-white hover:bg-opacity-20 rounded-full w-7 h-7 flex items-center justify-center"
              >âœ•</button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 text-sm text-gray-700" style={{ direction: 'rtl' }}>
              {helpContent[helpContext]?.content.split('\n').map((line, i) => {
                if (line.startsWith('**') && line.endsWith('**')) {
                  return <h4 key={i} className="font-bold text-gray-900 mt-3 mb-1">{line.replace(/\*\*/g, '')}</h4>;
                } else if (line.startsWith('**')) {
                  const parts = line.split('**');
                  return <p key={i} className="mb-1"><strong>{parts[1]}</strong>{parts[2]}</p>;
                } else if (line.startsWith('â€¢ ')) {
                  const text = line.substring(2);
                  if (text.includes('**')) {
                    const parts = text.split('**');
                    return <p key={i} className="mr-3 mb-0.5">â€¢ <strong>{parts[1]}</strong>{parts[2] || ''}</p>;
                  }
                  return <p key={i} className="mr-3 mb-0.5">â€¢ {text}</p>;
                } else if (line.trim() === '') {
                  return <div key={i} className="h-2" />;
                }
                return <p key={i} className="mb-1">{line}</p>;
              })}
            </div>
            <div className="px-4 py-3 border-t border-gray-200 bg-gray-50">
              <button
                onClick={() => setShowHelp(false)}
                className="w-full py-2 rounded-lg bg-blue-500 text-white font-bold hover:bg-blue-600 text-sm"
              >×”×‘× ×ª×™ âœ“</button>
            </div>
          </div>
        </div>
      )}

      {/* Confirm Dialog */}
      {showConfirmDialog && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
          <div className="bg-white rounded-xl p-4 max-w-sm w-full shadow-2xl">
            <p className="text-sm text-gray-800 mb-4 text-center font-medium">{confirmConfig.message}</p>
            <div className="flex gap-2">
              <button
                onClick={() => {
                  setShowConfirmDialog(false);
                  if (confirmConfig.onConfirm) confirmConfig.onConfirm();
                }}
                className="flex-1 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600"
              >
                ××™×©×•×¨
              </button>
              <button
                onClick={() => setShowConfirmDialog(false)}
                className="flex-1 py-2 bg-gray-300 text-gray-700 rounded-lg font-bold hover:bg-gray-400"
              >
                ×‘×™×˜×•×œ
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Toast Notification - Subtle */}
      {/* Import Confirmation Dialog */}
      {showImportDialog && importedData && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl w-full max-w-sm shadow-2xl">
            <div className="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-3 rounded-t-xl">
              <h3 className="text-base font-bold">ğŸ“¥ ×™×™×‘×•× × ×ª×•× ×™×</h3>
            </div>
            <div className="p-4 space-y-3">
              {importedData.exportDate && (
                <p className="text-xs text-gray-500 text-center">
                  ××ª××¨×™×š: {new Date(importedData.exportDate).toLocaleDateString('he-IL')}
                  {importedData.version && ` | ×’×¨×¡×”: ${importedData.version}`}
                </p>
              )}
              
              <div className="bg-gray-50 rounded-lg p-3 space-y-1.5">
                <div className="flex justify-between text-sm">
                  <span>ğŸ·ï¸ ×ª×—×•××™ ×¢× ×™×™×Ÿ ××•×ª×××™×</span>
                  <span className="font-bold text-purple-600">{(importedData.customInterests || []).length}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span>ğŸ“ ××§×•××•×ª</span>
                  <span className="font-bold text-blue-600">{(importedData.customLocations || []).length}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span>ğŸ—ºï¸ ××¡×œ×•×œ×™× ×©××•×¨×™×</span>
                  <span className="font-bold text-orange-600">{(importedData.savedRoutes || []).length}</span>
                </div>
                {importedData.interestConfig && (
                  <div className="flex justify-between text-sm">
                    <span>âš™ï¸ ×”×’×“×¨×•×ª ×—×™×¤×•×©</span>
                    <span className="font-bold text-gray-600">{Object.keys(importedData.interestConfig).length}</span>
                  </div>
                )}
                {importedData.interestStatus && (
                  <div className="flex justify-between text-sm">
                    <span>âœ… ×¡×˜×˜×•×¡ ×ª×—×•××™×</span>
                    <span className="font-bold text-gray-600">{Object.keys(importedData.interestStatus).length}</span>
                  </div>
                )}
              </div>
              
              <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-2">
                <p className="text-xs text-yellow-800">
                  ğŸ’¡ ×¤×¨×™×˜×™× ×§×™×™××™× (×œ×¤×™ ×©×) ×œ× ×™×™×“×¨×¡×•. ×¨×§ ×¤×¨×™×˜×™× ×—×“×©×™× ×™×ª×•×•×¡×¤×•.
                </p>
              </div>
              
              <div className="flex gap-2">
                <button
                  onClick={handleImportMerge}
                  className="flex-1 py-2.5 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 transition text-sm"
                >
                  âœ… ×™×™×‘× ×”×›×œ
                </button>
                <button
                  onClick={() => {
                    setShowImportDialog(false);
                    setImportedData(null);
                  }}
                  className="flex-1 py-2.5 bg-gray-300 text-gray-700 rounded-lg font-bold hover:bg-gray-400 transition text-sm"
                >
                  ×‘×™×˜×•×œ
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Password Dialog */}
      {showPasswordDialog && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl w-full max-w-sm shadow-2xl">
            <div className="bg-gradient-to-r from-gray-700 to-gray-800 text-white p-3 rounded-t-xl">
              <h3 className="text-base font-bold">ğŸ”’ ×”×’×“×¨×•×ª × ×¢×•×œ×•×ª</h3>
            </div>
            <div className="p-4 space-y-4">
              <p className="text-sm text-gray-600 text-center">×”×–×Ÿ ×¡×™×¡××” ×œ×¤×ª×™×—×ª ×”×”×’×“×¨×•×ª</p>
              <input
                type="password"
                value={passwordInput}
                onChange={(e) => setPasswordInput(e.target.value)}
                placeholder="×¡×™×¡××”"
                className="w-full p-3 border rounded-lg text-center text-lg"
                autoFocus
                onKeyDown={async (e) => {
                  if (e.key === 'Enter') {
                    const hashedInput = await window.BKK.hashPassword(passwordInput);
                    // Support both hashed and legacy plaintext passwords
                    if (hashedInput === adminPassword || passwordInput === adminPassword) {
                      const userId = localStorage.getItem('bangkok_user_id');
                      const userName = localStorage.getItem('bangkok_user_name') || 'Unknown';
                      if (isFirebaseAvailable && database) {
                        // If password was plaintext, upgrade to hash
                        if (passwordInput === adminPassword && hashedInput !== adminPassword) {
                          database.ref('settings/adminPassword').set(hashedInput);
                          setAdminPassword(hashedInput);
                        }
                        database.ref(`settings/adminUsers/${userId}`).set({
                          addedAt: new Date().toISOString(),
                          name: userName
                        }).then(() => {
                          setIsUnlocked(true);
                          setIsCurrentUserAdmin(true);
                          localStorage.setItem('bangkok_is_admin', 'true');
                          setShowPasswordDialog(false);
                          setPasswordInput('');
                          setCurrentView('settings');
                          showToast('× ×¤×ª×— ×‘×”×¦×œ×—×”!', 'success');
                        });
                      }
                    } else {
                      showToast('×¡×™×¡××” ×©×’×•×™×”', 'error');
                      setPasswordInput('');
                    }
                  }
                }}
              />
              <div className="flex gap-2">
                <button
                  onClick={async () => {
                    const hashedInput = await window.BKK.hashPassword(passwordInput);
                    // Support both hashed and legacy plaintext passwords
                    if (hashedInput === adminPassword || passwordInput === adminPassword) {
                      const userId = localStorage.getItem('bangkok_user_id');
                      const userName = localStorage.getItem('bangkok_user_name') || 'Unknown';
                      if (isFirebaseAvailable && database) {
                        // If password was plaintext, upgrade to hash
                        if (passwordInput === adminPassword && hashedInput !== adminPassword) {
                          database.ref('settings/adminPassword').set(hashedInput);
                          setAdminPassword(hashedInput);
                        }
                        database.ref(`settings/adminUsers/${userId}`).set({
                          addedAt: new Date().toISOString(),
                          name: userName
                        }).then(() => {
                          setIsUnlocked(true);
                          setIsCurrentUserAdmin(true);
                          localStorage.setItem('bangkok_is_admin', 'true');
                          setShowPasswordDialog(false);
                          setPasswordInput('');
                          setCurrentView('settings');
                          showToast('× ×¤×ª×— ×‘×”×¦×œ×—×”!', 'success');
                        });
                      }
                    } else {
                      showToast('×¡×™×¡××” ×©×’×•×™×”', 'error');
                      setPasswordInput('');
                    }
                  }}
                  className="flex-1 py-2 bg-green-500 text-white rounded-lg font-medium"
                >
                  ××™×©×•×¨
                </button>
                <button
                  onClick={() => {
                    setShowPasswordDialog(false);
                    setPasswordInput('');
                  }}
                  className="flex-1 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium"
                >
                  ×‘×™×˜×•×œ
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

            {toastMessage && (
        <div
          style={{
            position: 'fixed',
            top: '10px',
            right: '10px',
            left: '10px',
            maxWidth: '350px',
            margin: '0 auto',
            padding: '6px 12px',
            borderRadius: '6px',
            backgroundColor: toastMessage.type === 'error' ? '#fecaca' : toastMessage.type === 'warning' ? '#fde68a' : toastMessage.type === 'info' ? '#dbeafe' : '#bbf7d0',
            border: `1px solid ${toastMessage.type === 'error' ? '#ef4444' : toastMessage.type === 'warning' ? '#f59e0b' : toastMessage.type === 'info' ? '#3b82f6' : '#22c55e'}`,
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
            zIndex: 9999,
            animation: 'slideDown 0.15s ease-out'
          }}
        >
          <div style={{ display: 'flex', alignItems: 'center', gap: '6px', justifyContent: 'center' }}>
            <span style={{ fontSize: '12px' }}>
              {toastMessage.type === 'error' ? 'âœ—' : toastMessage.type === 'warning' ? '!' : toastMessage.type === 'info' ? 'â„¹' : 'âœ“'}
            </span>
            <div style={{ fontSize: '12px', fontWeight: '500', color: '#374151' }}>
              {toastMessage.message}
            </div>
          </div>
        </div>
      )}





      </div>
    </div>
  );
};

// Wait for Firebase SDK, then init and render
window.__firebaseReady.then(function(sdkLoaded) {
  if (sdkLoaded) {
    initFirebase();
  } else {
    console.log('[FIREBASE] SDK not loaded - running without Firebase');
  }
  ReactDOM.createRoot(document.getElementById('root')).render(<BangkokExplorer />);
});
    </script>
</body>
</html>
